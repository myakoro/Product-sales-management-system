# V1.54 → V1.55 実装引き継ぎ書

## 📋 V1.54 実装完了サマリー

### ✅ 完了した機能
V1.54では、**Next Engine API連携による売上データの自動同期機能**を実装しました。

#### 主要機能
1. **OAuth 2.0認証**: Next Engineとの安全な連携を確立
2. **店舗マッピング**: Next Engineの店舗とRinoriの販路を紐付け
3. **売上データ同期**: 
   - 出荷確定日ベースでの売上データ取得
   - 商品コード単位での自動集計
   - 手動CSV取込と同等の精度を実現
4. **新商品候補検出**: 未登録商品の自動検出・通知機能

---

## 🗄️ データ保管場所と構造

### 1. Next Engine関連テーブル

#### `ne_auth` テーブル
**場所**: `prisma/schema.prisma` (246-256行目)
**用途**: Next Engine APIの認証情報を保管

| カラム名 | 型 | 説明 |
|---------|-----|------|
| `id` | Int | 固定値1（シングルトン） |
| `access_token` | String | アクセストークン |
| `refresh_token` | String | リフレッシュトークン |
| `expires_at` | DateTime | アクセストークン有効期限 |
| `refreshes_at` | DateTime | リフレッシュトークン有効期限 |
| `updated_at` | DateTime | 最終更新日時 |

**重要**: このテーブルは常に1レコードのみ存在します（`@id @default(1)`）

#### `ne_shop_mappings` テーブル
**場所**: `prisma/schema.prisma` (258-268行目)
**用途**: Next Engineの店舗IDとRinoriの販路IDの紐付け

| カラム名 | 型 | 説明 |
|---------|-----|------|
| `ne_shop_id` | Int | Next Engine店舗ID（主キー） |
| `channel_id` | Int | Rinori販路ID |
| `created_at` | DateTime | 作成日時 |
| `updated_at` | DateTime | 更新日時 |

**関連**: `SalesChannel` テーブルと外部キー関連

### 2. 売上データ関連

#### `sales_records` テーブル
**Next Engine同期で作成されるレコードの特徴**:
- `external_order_id`: `NE-{販路ID}-{年月}-{商品コード}` 形式
  - 例: `NE-1-2025-02-RINO-FR010`
- `data_source`: `'API'`（手動CSV取込は `'NE'` または `'Amazon'`）
- 商品コード単位で集計済み（1商品1レコード/月）

#### `import_histories` テーブル
**Next Engine同期の履歴**:
- `import_type`: `'sales'`
- `data_source`: `'API'`
- `comment`: `'ネクストエンジン自動同期 (店舗名1, 店舗名2...)'`

### 3. 新商品候補

#### `new_product_candidates` テーブル
**場所**: `prisma/schema.prisma` (224-234行目)
**Next Engine同期での登録内容**:
- `product_code`: 親商品コード
- `sample_sku`: 商品コード（NEの場合は親コードと同じ）
- `product_name`: Next EngineのAPIから取得した商品名
- `status`: `'pending'`（未処理）

---

## 🔧 実装の技術的詳細

### 主要ファイル

#### 1. Next Engine APIクライアント
**ファイル**: `src/lib/nextengine.ts`
**主要メソッド**:
- `authorize()`: OAuth認証URLの生成
- `handleCallback()`: 認証コールバック処理
- `refreshAccessToken()`: トークンリフレッシュ
- `getShops()`: 店舗一覧取得
- `searchOrderRows()`: 受注明細検索（売上データ取得）

**重要な実装ポイント**:
```typescript
// 取得フィールド
fields: 'receive_order_row_no,receive_order_row_goods_id,receive_order_row_goods_name,receive_order_row_quantity,receive_order_row_unit_price,receive_order_row_sub_total_price'

// 検索条件
'receive_order_send_date-gte': '2025-02-01'  // 出荷確定日（開始）
'receive_order_send_date-lte': '2025-02-28'  // 出荷確定日（終了）
'receive_order_shop_id-in': '123,456'        // 店舗ID（カンマ区切り）
```

#### 2. 同期処理
**ファイル**: `src/app/api/nextengine/sync/route.ts`
**処理フロー**:
1. 店舗マッピング取得
2. Next Engine APIから受注明細取得
3. 除外キーワードフィルタリング
4. 商品コード単位で集計
5. 既存データ削除（同一月・販路）
6. 新規データ登録
7. 新商品候補登録

**集計ロジック**:
```typescript
// 商品コード単位で数量と金額を合算
aggregatedData.set(parentCode, {
    quantity: 合計数量,
    totalAmount税込: 合計金額（税込）,
    productCode: 親商品コード,
    productName: 商品名
});
```

**外部注文ID生成ルール**:
```typescript
externalOrderId: `NE-${channelId}-${targetYm}-${productCode}`
// 例: NE-1-2025-02-RINO-FR010
```

#### 3. 認証・マッピングUI
**ファイル**: `src/app/settings/nextengine/page.tsx`
**機能**:
- Next Engine OAuth連携ボタン
- 店舗一覧表示
- 販路マッピング設定

---

## 🚨 重要な制約事項と注意点

### 1. Next Engine API仕様の制約
- **検索可能フィールドの制限**: `receive_order_row/search` では、ヘッダー情報（キャンセルフラグ等）を検索条件に使用できない
- **日付フィールド**: `receive_order_send_date` が「出荷確定日」に相当
- **比較演算子**: `-gte`, `-lte`, `-eq`, `-in` のみ使用可能（`-gt`, `-lt` は不可）

### 2. データ整合性の保証
- **冪等性**: 同一月・販路の同期を複数回実行しても、結果は同じ
- **削除ロジック**: 同期前に `externalOrderId` が `NE-{販路ID}-{年月}-` で始まるレコードを削除
- **集計の一意性**: 商品コード単位で集計するため、1商品1レコード/月が保証される

### 3. 手動CSV取込との互換性
- **新商品候補**: 手動CSV取込と同じロジックで検出・登録
- **除外キーワード**: 手動CSV取込と同じフィルタリングルールを適用
- **税計算**: 手動CSV取込と同じ税率計算ロジックを使用

---

## 📊 環境変数

### 必須の環境変数
```bash
NEXTENGINE_CLIENT_ID=your_client_id
NEXTENGINE_CLIENT_SECRET=your_client_secret
NEXTENGINE_REDIRECT_URI=https://your-domain.com/api/auth/nextengine/callback
```

**設定場所**:
- ローカル: `.env.local`
- Render: Environment Variables

---

## 🔄 V1.55への引き継ぎ事項

### 完了していない項目（Phase 5）
- [ ] 統合テスト
- [ ] Next Engineでの実データ検証
- [ ] ドキュメント更新

### 既知の課題・改善点
1. **エラーハンドリング**: API通信エラー時のリトライ処理が未実装
2. **パフォーマンス**: 大量データ（1000件以上）の同期性能が未検証
3. **ログ**: 詳細なデバッグログが不足（本番運用時の調査が困難）

### 推奨される次期機能
1. **スケジュール同期**: 定期的な自動同期（cron / Render Cron Jobs）
2. **差分同期**: 全件取得ではなく、前回同期以降の差分のみ取得
3. **エラー通知**: 同期失敗時のメール/Slack通知
4. **同期履歴詳細**: 成功/失敗の詳細ログ、スキップされた商品の一覧表示

---

## 📚 参考資料の場所

### ドキュメント
- **要件定義書**: `C:\Users\takuy\Desktop\売上管理システム\要件定義書\V1.54_要件定義書_差分.md`
- **詳細設計書**: `C:\Users\takuy\Desktop\売上管理システム\詳細設計書\V1.54_詳細設計_差分.md`
- **NE API資料**: `C:\Users\takuy\Desktop\売上管理システム\参考資料\NE参考資料\NE関連資料.md`

### コードベース
- **プロジェクトルート**: `C:\Users\takuy\Desktop\売上管理システム\rinori-sales-system`
- **Gitリポジトリ**: `https://github.com/myakoro/Product-sales-management-system`
- **デプロイ先**: `https://product-sales-management-system.onrender.com`

---

## 🎯 V1.55開発の推奨アプローチ

1. **要件定義から開始**: V1.54と同様、必ず要件定義書を作成し、ユーザーと合意形成
2. **段階的実装**: Phase 1（計画）→ Phase 2（環境）→ Phase 3（実装）→ Phase 4（改善）→ Phase 5（検証）
3. **データ整合性の重視**: 既存データとの互換性を最優先
4. **セキュリティ**: 個人情報の取り扱いに細心の注意

---

**作成日**: 2026-01-07  
**作成者**: AI Assistant (V1.54実装担当)  
**対象バージョン**: V1.54 → V1.55
