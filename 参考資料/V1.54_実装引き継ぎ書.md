# V1.54 Next Engine連携 実装引き継ぎ書

あなたは、Next.js / Prisma / Tailwind CSS を熟知し、ネクストエンジン API 連携の実績を持つ**シニア・ソフトウェア・エンジニア（API連携担当）**として、Rinoriシステムの拡張を担ってください。

## 1. ミッションと開始地点
現在のCSVインポート運用を脱却し、Next Engine（NE）APIによる売上同期を自動化せよ。

**【最重要】作業開始時は、まず「要件定義書」の更新から着手すること。**
以下の項目をユーザーと合意形成し、ドキュメント化せよ：
- **取り込み対象**: どの店舗（販路）の、どの受注ステータス（「出荷済み」のみ等）を対象とするか。
- **データマッピング**: NEの受注金額、消費税、配送料を、Rinoriのどのフィールドにマッピングするか。
- **個人情報の扱い**: 住所詳細、氏名、電話番号のうち、分析に不要なものは「取得・保存しない」方針を徹底すること。

## 2. ネクストエンジン側の準備状況
- **アプリ属性**: 特定の企業（自社）に限定公開。
- **ステータス**: 運営審査中（完了後に `ClientID`, `ClientSecret` が発行される）。
- **Redirect URI（設定済み）**: 
  - 本番: `https://product-sales-management-system.onrender.com/api/auth/nextengine/callback`
  - テスト: `https://localhost:3000/api/auth/nextengine/callback` (NEの制約によりテスト環境もhttps必須)

## 3. 実装の技術的要件
1. **認可フロー (OAuth 2.0)**: `NEAuth` テーブルを新設し、リフレッシュトークンによるアクセストークンの自動更新を実装せよ。
2. **同期方式**: 初期実装として `receiveorder_base/search` API を用いたバッチ同期を目指せ。リアルタイム（Webhook）は将来検討。
3. **冪等性**: NEの受注伝票番号をユニークキーとし、多重登録・多重計算を物理的に防止せよ。

## 4. セキュリティ・個人情報保護の徹底
本システムは顧客の個人情報にアクセス可能なため、以下の実装を義務付ける：
- **.env管理**: 認証情報は絶対にドキュメントやリポジトリに記載せず、環境変数として管理せよ。
- **DB保存の最小化**: 分析に不要な機密情報は保存せず、メモリエントリ時点で破棄せよ。
- **権限制御**: NE連携設定および詳細データへのアクセスは「マスター権限」に限定せよ。

## 5. 参照リソース
- **技術詳細**: [NE関連資料.md](file:///C:/Users/takuy/Desktop/売上管理システム/参考資料/NE参考資料/NE関連資料.md)

---
既存の「プレミアムなUI」と「堅牢な論理層」を継承し、ユーザーが安心して利用できる最高水準のAPI連携機能を構築してください。
