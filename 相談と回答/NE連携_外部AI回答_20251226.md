# ネクストエンジン OAuth認証エラー - 外部AI回答

## 回答日時
2025年12月26日

## 調査結果サマリー

### 重要な発見
1. **authorize URL のパスが誤っている可能性が高い**
   - 現在: `https://base.next-engine.org/main/oauth/authorize`
   - この URL が現行仕様として正しいか要検証

2. **`response_type=code` パラメータが欠落**
   - OAuth 2.0 標準では必須パラメータ
   - 未指定の場合、404/エラーになる可能性

3. **テスト環境と本番環境の整合性**
   - テスト環境用 Client ID を使用しているが、本番ドメインにアクセスしている可能性

4. **アプリステータス「審査中」の制限**
   - 審査中は OAuth authorize が利用不可の可能性

---

## 原因分析（優先順）

### 原因A（最有力）: authorize URL の誤り
- `/main/oauth/authorize` が現行仕様として正しいか不明
- パスが1文字でも違うと404になる
- `response_type=code` などの必須パラメータが欠落

### 原因B: テスト環境と本番環境の不一致
- テスト環境 Client ID を本番 authorize に投げている可能性
- NextEngine はテスト環境を別ホストではなく、同一ホストで内部的に区別している可能性

### 原因C: アプリが「審査中」で OAuth 利用不可
- 審査完了まで authorize を塞ぐ仕様の可能性

### 原因D: 起動導線の問題
- 「単独機能」でも、NE 管理画面からの起動が前提の可能性
- 企業ID/テナント指定が必要な可能性

---

## 解決策（優先順位付き）

### 最優先(1): 公式ドキュメント記載の authorize URL に合わせる
- 公式の「認証・認可（OAuth 2.0）」に記載されている authorize endpoint を確認
- `response_type=code` などの必須パラメータを追加

### 高優先(2): テスト環境の整合性を取る
- テスト Client ID → テスト authorize URL
- 公式の「テストメイン機能」手順に記載のホストを使用

### 高優先(3): アプリ状態の確認
- 審査中でも OAuth 可能かを確認
- テストユーザー/開発者のみ許可する設定があるか確認

### 中優先(4): NE 管理画面から正しい認可 URL を取得
- 管理画面の「OAuth認証を開始」ボタンなどから生成される URL を確認
- 自前生成 URL と差分比較

### 中優先(5): 最小構成で authorize URL を直接確認
- ブラウザで authorize URL を直叩きしてログイン画面が出るか確認

---

## サポートへの質問テンプレート

### 質問1: テスト環境の authorize endpoint
「テスト環境のClient ID `Orxim4pwzPe69v` を用いた OAuth2 認可の開始URL（authorize endpoint）はどのホスト・パスですか？」

### 質問2: 必須クエリパラメータ
「authorize リクエストに必須のパラメータは何ですか？ `response_type=code` や `scope` は必須ですか？」

### 質問3: 審査中の制限
「アプリステータスが"審査中"の場合、テスト環境で OAuth 認証フローは実行できますか？」

### 質問4: 起動導線
「単独機能として実行」の場合、外部サイトから直接 authorize endpoint へ遷移して認可開始できますか？」

---

## 次の確認事項

1. `https://base.next-engine.org/main/` はブラウザで表示できるか？
2. 公式ドキュメントに記載の authorize URL の完全な形式は？
3. `response_type=code` は必須か？
4. NE 管理画面上の「認可URL」は何になっているか？
