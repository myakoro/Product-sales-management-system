# ネクストエンジン連携エラー (999999) - 問題サマリー

## 現在の状況

**プロジェクト**: Rinori Sales Management System (Next.js 14, TypeScript)
**環境**: 
- ローカル: Windows 11, Node.js 20+, `npm run dev:https` (Next.js experimental HTTPS)
- ネクストエンジン提供のテスト用アプリ環境

**発生している問題**:
ネクストエンジンの認証画面へリダイレクトした際、「お客様のアクセスはセキュリティポリシーによりブロックされました。(Error 999999)」と表示される。

```json
{
  "result": "error",
  "code": "999999",
  "message": "お客様のアクセスはセキュリティポリシーによりブロックされました。この問題について詳しい情報が必要な場合はネクストエンジンサポートセンターにお問い合わせください。"
}
```

## 何をしたいか

1. ローカル開発環境 (`https://localhost:3000`) からネクストエンジンの認証を完了させたい。
2. テスト環境用の資格情報を使用して、アクセストークンを取得したい。

## エラーの詳細

### 症状
- ログインボタンを押して `/api/auth/nextengine/login` にアクセス
- `api.next-engine.org` へリダイレクトされる
- ネクストエンジンのログイン画面が出る前に、上記の JSON エラーが返される

### リダイレクトURLの例 (デバッグ出力)
```
https://api.next-engine.org/main/oauth/authorize?client_id=Orxim4pwzPe69v&redirect_uri=https%3A%2F%2Flocalhost%3A3000%2Fapi%2Fauth%2Fnextengine%2Fcallback&state=...
```

## 試したこと（すべて失敗）

1. **`.env` ファイルの修正**
   - `NEXTENGINE_REDIRECT_URI` を `http` から `https` に変更。
   - プレースホルダーだった `client_id` 等を本物のテスト用資格情報に差し替え。
   - 重複していた古い設定（ファイル上部）を削除。

2. **サーバーの再起動とHTTPS化**
   - `npm run dev:https` を使用し、ローカル環境を HTTPS で起動。
   - ブラウザの「詳細設定」から自己署名証明書を許可。

3. **キャッシュの削除**
   - `.next` ディレクトリを削除して再ビルド。

4. **環境変数の読み込み確認**
   - コード内で `console.log` を使い、生成された URL が正しい Client ID と `https://localhost...` を含んでいることを確認。

## 関連ファイル

### 設定ファイル
- `.env`
```env
DATABASE_URL="file:./prisma/dev.db"
NEXTAUTH_URL="https://localhost:3000"
NEXTAUTH_SECRET="..."

NEXTENGINE_CLIENT_ID=Orxim4pwzPe69v
NEXTENGINE_CLIENT_SECRET=FRyJfbtsAZmuLUwXpzqovVNO8KWQDBljMYPncr59
NEXTENGINE_REDIRECT_URI=https://localhost:3000/api/auth/nextengine/callback
```

### 関連コード (一部)
- `src/lib/nextengine.ts`
```typescript
getAuthUrl(state: string): string {
    return `https://api.next-engine.org/main/oauth/authorize?client_id=${this.clientId}&redirect_uri=${encodeURIComponent(this.redirectUri)}&state=${state}`;
}
```

## 質問したいこと

1. **Error 999999 の真の原因は何か？**
   - `redirect_uri` が `https://localhost:3000` であること自体が拒否されている可能性はあるか？
   - ネクストエンジンのテスト環境側で、許可された IP アドレスや Redirect URI の登録が不足している可能性があるか？
2. **ローカル環境からテスト環境への認証を通すための回避策はあるか？**
   - `localhost` ではなく IP アドレス (`127.0.0.1`) を使うべきか、あるいはトンネリングツール (ngrok等) が必須か？
3. **リクエストパラメータ以外に、ヘッダーや Cookie などでブロックされる要因はあるか？**
