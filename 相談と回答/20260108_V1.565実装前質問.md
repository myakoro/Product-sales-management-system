# V1.565 実装前質問事項

## 現状分析結果

### 確認済みファイル状況

**`src/app/products/page.tsx`**
- ✅ CSV出力機能は実装済み（V1.56で追加）
- ✅ `categoryName`フィールドは型定義に存在
- ❌ **カテゴリー列がテーブルに表示されていない**（V1.55機能が消失）
- ❌ **カテゴリーフィルタが存在しない**（V1.55機能が消失）
- 現在のテーブル列: 商品コード、商品名、販売価格、原価、商品区分、管理ステータス、登録日、操作
- 現在のフィルタ: 検索、商品区分、管理ステータス

**`src/app/pl/page.tsx`**
- ✅ PL推移グラフは実装済み（V1.56で追加）
- ✅ 予算実績推移グラフは実装済み（V1.56で追加）
- ❌ **複数商品/カテゴリー比較機能が未実装**
- ❌ **チェックボックスによる選択UIが未実装**
- 現在の実装: 全体データのみを単一グラフで表示

---

## 実装が必要な項目

### 1. V1.55機能の復元（商品マスタ画面）
- カテゴリー列の追加
- カテゴリーフィルタの追加

### 2. 比較グラフUI構築
- PL分析画面（商品別・カテゴリー別）にチェックボックス追加
- 予算実績画面に選択UI追加

### 3. グラフ機能の改修
- 複数ID対応のデータ取得・整形
- 動的ライン生成
- カラーパレット適用

---

## 質問事項

### Q1. 商品マスタ画面のレイアウト - カテゴリー列の配置位置

現在のテーブル列順：
```
商品コード | 商品名 | 販売価格 | 原価 | 商品区分 | 管理ステータス | 登録日 | 操作
```

カテゴリー列を追加する場合、どの位置が望ましいでしょうか？

**案A**: 管理ステータスと登録日の間
```
商品コード | 商品名 | 販売価格 | 原価 | 商品区分 | 管理ステータス | カテゴリー | 登録日 | 操作
```

**案B**: 商品名の直後
```
商品コード | 商品名 | カテゴリー | 販売価格 | 原価 | 商品区分 | 管理ステータス | 登録日 | 操作
```

**案C**: その他のご希望の位置

**ご回答欄**:


---

### Q2. カテゴリーフィルタの配置

現在のフィルタエリアは3列（検索、商品区分、ステータス）です。

**案A**: 4列に拡張（検索ボックスは2列分、残り3つは1列ずつ）
```
[検索ボックス（2列分）] [商品区分] [ステータス]
[カテゴリー] [空白] [空白] [空白]
```

**案B**: 4列均等配置
```
[検索ボックス] [商品区分] [ステータス] [カテゴリー]
```

**案C**: 2行構成
```
行1: [検索ボックス（2列分）] [商品区分] [ステータス]
行2: [カテゴリー] [その他のフィルタ候補]
```

**ご回答欄**:


---

### Q3. 商品別PL分析画面の実装方式

現在の`/pl/page.tsx`には「商品別PL」タブがありますが、**商品一覧テーブルが存在しません**。

V1.565では、商品別PLで複数商品を比較するために、商品選択UIが必要です。

**案A**: 商品選択用のモーダル/ドロワー
- 「商品を選択」ボタンをクリック → モーダルで商品一覧を表示 → チェックボックスで選択（最大5件）

**案B**: 画面内に商品一覧テーブルを追加
- PLデータ表示の上または横に商品一覧テーブルを配置
- チェックボックスで選択（最大5件）

**案C**: ドロップダウン/マルチセレクト
- 商品を検索・選択できるドロップダウンコンポーネント（react-selectなど）

**案D**: その他のご提案

**ご回答欄**:


---

### Q4. グラフの初期表示挙動

V1.565の設計書では「比較対象が1つも選択されていない場合、グラフ描画エリアの中央に案内メッセージを表示」とあります。

この変更により、以下の挙動になると理解していますが、正しいでしょうか？

- **全体PLタブ**: 変更なし（常に全体データを表示）
- **商品別PLタブ**: 商品未選択時は「左の表から比較したい項目を選択してください（最大5件）」を表示
- **カテゴリー別PLタブ**: カテゴリー未選択時は案内メッセージ表示

**ご回答欄**:


---

### Q5. 予算実績画面の確認

設計書に記載されている `/src/app/budget/vs-actual/page.tsx` というファイルが存在するか確認が必要です。

もし存在しない場合、V1.565での実装対象から除外すべきでしょうか？
それとも、新規作成が必要でしょうか？

**ご回答欄**:


---

### Q6. 営業利益の表示制御

設計書によると、「商品別分析・カテゴリー別分析では営業利益のチェックボックス自体を非表示」とあります。

現在のV1.56実装では、PL推移グラフで以下のように制御されています：
```typescript
{activeTab === 'overall' && (
  <>
    <label>営業利益</label>
    <label>SGA</label>
  </>
)}
```

この実装は既に正しく動作していると思われますが、**予算実績推移グラフでも同様の制御が必要でしょうか？**

（予算実績推移グラフには営業利益項目がないため、現状では影響なしと思われます）

**ご回答欄**:


---

### Q7. カテゴリーフィルタのAPI連携

カテゴリーフィルタを実装する際、カテゴリー一覧を取得するAPIエンドポイントは以下で正しいでしょうか？

- `/api/categories` （全カテゴリー取得）

また、フィルタ適用時のクエリパラメータは以下の形式でよろしいでしょうか？

- `/api/products?categoryId=1` （特定カテゴリー）
- `/api/products?categoryId=null` または `/api/products?categoryId=unclassified` （未分類）

**ご回答欄**:


---

### Q8. チェックボックスの選択制限UI

設計書では「5件選択中の場合、他のチェックボックスを非活性化（Disabled）にするか、チェック時にトースト等のJ-Alertで通知する」とあります。

どちらの方式が望ましいでしょうか？

**案A**: 5件選択時に他のチェックボックスを非活性化（Disabled）
- メリット: 視覚的に分かりやすい
- デメリット: 選択を変更したい場合、一度解除してから選び直す必要がある

**案B**: 6件目をチェックしようとした時にアラート表示
- メリット: 柔軟な選択変更が可能
- デメリット: アラートが煩わしい可能性

**案C**: 5件選択時に他のチェックボックスを薄く表示し、クリック時にアラート
- メリット: 視覚的フィードバック + アラートで理由を説明
- デメリット: 実装が複雑

**ご回答欄**:


---

### Q9. グラフタイプ切替UI

設計書では「折れ線と棒を切り替えるトグルスイッチ、またはタブボタンを配置」とあります。

どちらのUIが望ましいでしょうか？

**案A**: トグルスイッチ
```
[折れ線 ⚪︎━━ 棒]
```

**案B**: タブボタン
```
[折れ線] [棒]
```

**案C**: ドロップダウン
```
[グラフ種類: 折れ線 ▼]
```

**ご回答欄**:


---

### Q10. 昨年データの一括表示切替UI

設計書では「昨年対比を表示」という共通トグル/チェックボックスを追加とあります。

配置位置はどこが望ましいでしょうか？

**案A**: グラフヘッダーの右側（表示項目チェックボックスの前）
```
[▼ PL推移グラフ] [☑ 昨年対比を表示] [☑売上高 ☑粗利 ...]
```

**案B**: 表示項目チェックボックスの後
```
[▼ PL推移グラフ] [☑売上高 ☑粗利 ...] [☑ 昨年対比を表示]
```

**案C**: グラフエリア内の独立した行
```
[▼ PL推移グラフ]
[☑ 昨年対比を表示]
[☑売上高 ☑粗利 ...]
```

**ご回答欄**:


---

## 実装開始前の確認

上記の質問にご回答いただければ、以下の順序で実装を開始いたします：

1. V1.55機能の復元（商品マスタ画面）
2. 比較グラフUI構築（チェックボックス追加）
3. グラフ機能の改修（複数比較ロジック）
4. 営業利益関連UIの表示制御
5. 動作確認とテスト

**実装プロセス・ルール**:
- コードを書き換える前に、必ず現在のファイル状況と設計ドキュメントをマッピングした実装計画を作成
- 推測で補わず、不明点があれば必ず質問
- APIロジックは監査済みのため、フロント側での型定義の不整合など致命的な理由がない限り変更しない
