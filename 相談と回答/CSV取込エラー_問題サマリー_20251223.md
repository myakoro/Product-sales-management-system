# CSV取込エラー - 問題サマリー

## 現在の状況

**プロジェクト**: Rinori販売管理システム (Next.js 14.2.18 + Prisma + SQLite)
**環境**: 
- ローカル: Windows, Node.js 25.2.1
- 本番: Render.com

**発生している問題**:
売上CSV取込機能（NE形式・Amazon形式両方）で、以下のエラーが発生します：

```
Import failed: No number after minus sign in JSON at position 1 (line 1 column 2)
```

## 何をしたいか

1. NE形式のCSV取込を正常に動作させたい
2. Amazon形式のCSV取込機能（V1.51新機能）を実装したい

## エラーの詳細

### ローカル環境のスタックトレース
```
Import Error: SyntaxError: No number after minus sign in JSON at position 1 (line 1 column 2)
    at JSON.parse (<anonymous>)
    at parseJSONFromBytes (node:internal/deps/undici/undici:6433:19)
    at successSteps (node:internal/deps/undici/undici:6414:27)
    at readAllBytes (node:internal/deps/undici/undici:5380:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:103:5)
POST /api/import/sales 500 in 30ms
```

### 問題の詳細
- **フロントエンド**: `csv-parser.ts:78` で Papa.parse を実行
- **バックエンド**: `/api/sales/import/route.ts` で FormData を受信
- **エラー発生箇所**: Node.jsのHTTPライブラリ（undici）が、FormDataで送信されたCSVファイルをJSONとして解釈しようとしている

## 試したこと（すべて失敗）

1. **Papa.parse に `dynamicTyping: false` を追加**
   - フロントエンドとバックエンドの全Papa.parse呼び出しに追加
   - 効果なし

2. **csv-parser.ts の不正なクォート処理を削除**
   - 74-76行目の `csvText.replace()` 処理を削除
   - 効果なし、同じエラーが継続

3. **コミット履歴のrevert**
   - 複数回revertを試したが、問題解決せず

## 関連ファイル

### フロントエンド
- `src/lib/csv-parser.ts` - CSVパース処理（Papa.parse使用）
- `src/app/import/sales/page.tsx` - CSV取込UI

### バックエンド
- `src/app/api/sales/import/route.ts` - CSV取込APIエンドポイント

## 技術スタック

- **フレームワーク**: Next.js 14.2.18
- **CSVパーサー**: Papa Parse 5.4.1
- **データベース**: Prisma + SQLite
- **デプロイ**: Render.com

## 質問したいこと

1. なぜNode.jsのunidiciライブラリが、FormDataで送信されたCSVファイルをJSONとして解釈しようとするのか？
2. FormDataの送信方法、またはNext.jsのAPI RouteでのFormData受信方法に問題があるか？
3. このエラーを解決する正しいアプローチは何か？

## 追加情報

- 本番環境でも同じエラーが発生
- 以前（V1.5まで）はNE CSV取込が正常に動作していたはず
- V1.51でAmazon CSV対応を追加しようとした際に問題が発覚
