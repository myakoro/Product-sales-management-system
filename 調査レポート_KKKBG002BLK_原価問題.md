# KKKBG002BLK 原価問題 調査レポート

**調査日時**: 2026-01-27  
**対象商品**: KKKBG002BLK  
**対象期間**: 2026年1月  
**問題**: データ同期実行後、売上は正しいが原価がマスタと異なる

---

## 1. 調査内容

### 1.1 データ同期機能の実装確認

**ファイル**: `src/app/api/nextengine/sync/route.ts`

データ同期処理の原価計算ロジックを確認しました：

```typescript
// 248行目
const costAmountExclTax = product.costExclTax * data.quantity;
```

**重要な発見**:
- データ同期時、商品マスタの `costExclTax`（原価・税別）を使用して原価金額を計算
- 計算式: `原価金額 = 商品マスタの単価原価 × 数量`
- この計算は**同期実行時点**の商品マスタの原価を使用

### 1.2 データベースの確認

**確認したデータベース**: `prisma/dev.db.bak`（バックアップファイル）

**結果**:
- 商品コード `KKKBG002BLK` は商品マスタに存在しない
- データベースには2件のテスト商品のみ存在:
  - RINO-FR001 (原価: 5000.0)
  - RINO-FR002 (原価: 4000.0)
- 2026年1月の売上レコードも存在しない

**推測**:
- バックアップファイルは古いデータまたはテスト環境のデータ
- 本番データベース（`dev.db`）が別の場所に存在する可能性
- アプリケーションが実際に使用しているデータベースファイルが見つからない

---

## 2. 原価不一致の原因（推測）

### 2.1 最も可能性が高い原因

**商品マスタの原価が同期後に変更された**

1. **2026年1月のデータ同期実行時**:
   - 商品マスタの原価: 例えば 1000円
   - 同期処理が原価金額を計算: 1000円 × 数量
   - 売上レコードに保存

2. **同期後に商品マスタの原価を更新**:
   - 商品マスタの原価を変更: 例えば 1200円に変更
   - 既存の売上レコードの原価金額は変更されない（過去データは保持）

3. **現在の状態**:
   - 商品マスタの原価: 1200円（現在の値）
   - 売上レコードの原価金額: 1000円 × 数量（同期時の値）
   - → 不一致が発生

### 2.2 その他の可能性

1. **同期処理中のエラー**:
   - 商品マスタの取得に失敗し、デフォルト値（0または古い値）を使用
   - ただし、コードレビューではこの可能性は低い

2. **データベースの不整合**:
   - トランザクション処理中の問題
   - ただし、売上金額が正しいため可能性は低い

---

## 3. 本番環境での調査方法

### 3.1 Render本番環境からデータベースをエクスポート

システムには既にデータベースエクスポート機能が実装されています。以下の手順で本番データベースを取得できます：

#### 手順:

1. **Render本番環境にアクセス**:
   - https://[your-render-app-url] にアクセス
   - マスター権限でログイン

2. **データエクスポート画面に移動**:
   - 設定メニューから「データエクスポート」を選択
   - または直接 `/settings/export` にアクセス

3. **データベースをダウンロード**:
   - 「データベースをダウンロード」ボタンをクリック
   - ファイル名: `rinori-sales-backup-[日付].db` がダウンロードされます

4. **ダウンロードしたファイルを調査**:
   - ダウンロードしたファイルを以下のパスに配置:
     ```
     C:\Users\takuy\Desktop\Rinori売上管理システム\rinori-sales-system\prisma\dev.db
     ```
   - 調査スクリプトを実行:
     ```bash
     cd C:\Users\takuy\Desktop\Rinori売上管理システム\rinori-sales-system
     python investigate_kkkbg002blk.py
     ```

### 3.2 調査スクリプトの実行結果で確認する項目

スクリプト実行後、以下の情報が表示されます：

1. **商品マスタの現在の原価**:
   - 現在の `costExclTax` の値
   - 最終更新日時 (`updated_at`)

2. **2026年1月の売上レコード**:
   - 各レコードの原価金額 (`costAmountExclTax`)
   - 推測される同期時の単価原価（原価金額 ÷ 数量）
   - データ同期の実行日時

3. **原価の差分**:
   - 期待される原価金額（現在のマスタ原価 × 数量）
   - 実際の原価金額
   - 差分の計算結果

### 3.3 調査結果の解釈

#### ケース1: 商品マスタの更新日時 > データ同期の実行日時

**結論**: 商品マスタの原価が同期後に変更された

**対応**:
- これは仕様通りの動作です
- 売上レコードは同期時点の原価を保持しています
- 必要に応じて、原価変更の履歴を記録する機能の追加を検討

#### ケース2: 商品マスタの更新日時 ≒ データ同期の実行日時

**結論**: 同期処理中に原価が変更された可能性

**対応**:
- 同期処理のトランザクション制御を確認
- 同期中は商品マスタの更新をロックする仕組みの検討

#### ケース3: 推測される単価原価が不自然な値

**結論**: データ同期処理にバグがある可能性

**対応**:
- データ同期のログを確認
- 同期処理のロジックを再検証

---

## 4. 原価不一致の原因（推測）

### 4.1 最も可能性が高い原因

**商品マスタの原価が同期後に変更された**

1. **2026年1月のデータ同期実行時**:
   - 商品マスタの原価: 例えば 1000円
   - 同期処理が原価金額を計算: 1000円 × 数量
   - 売上レコードに保存

2. **同期後に商品マスタの原価を更新**:
   - 商品マスタの原価を変更: 例えば 1200円に変更
   - 既存の売上レコードの原価金額は変更されない（過去データは保持）

3. **現在の状態**:
   - 商品マスタの原価: 1200円（現在の値）
   - 売上レコードの原価金額: 1000円 × 数量（同期時の値）
   - → 不一致が発生

### 4.2 その他の可能性

1. **同期処理中のエラー**:
   - 商品マスタの取得に失敗し、デフォルト値（0または古い値）を使用
   - ただし、コードレビューではこの可能性は低い

2. **データベースの不整合**:
   - トランザクション処理中の問題
   - ただし、売上金額が正しいため可能性は低い

---

## 5. 対応方針（提案）

### 5.1 即座の対応（調査完了後）

1. **原価の不一致を確認**:
   - 商品マスタの現在の原価
   - 売上レコードの原価金額
   - 差分を計算

2. **原因の特定**:
   - 商品マスタの更新履歴を確認（`updated_at` フィールド）
   - データ同期の実行日時と比較

3. **ユーザーへの報告**:
   - 不一致の原因を説明
   - 修正が必要かどうかを確認

### 5.2 長期的な対応（必要に応じて）

**仕様の明確化**:

現在の仕様では、売上レコードの原価は**同期実行時点**の商品マスタの原価を使用します。
これは以下の理由で合理的です：

- **過去の実績を正確に記録**: 同期時点の原価で粗利を計算
- **原価変更の影響を受けない**: 後から原価を変更しても過去データは変わらない

ただし、以下の点を検討する必要があります：

1. **原価変更時の対応**:
   - 過去の売上レコードを再計算するか？
   - それとも、同期時点の原価を保持するか？

2. **ユーザーへの通知**:
   - 原価変更時に、過去の売上レコードとの不一致が発生することを警告

3. **監査証跡**:
   - 商品マスタの原価変更履歴を記録する機能の追加を検討

---

## 6. 次のステップ

1. **本番データベースのエクスポート**（最優先）
   - Render本番環境にログイン
   - `/settings/export` からデータベースをダウンロード

2. **調査スクリプトの実行**
   - ダウンロードしたファイルを `prisma/dev.db` に配置
   - `python investigate_kkkbg002blk.py` を実行

3. **原因の確定**
   - スクリプトの出力結果を確認
   - 商品マスタの更新日時とデータ同期の実行日時を比較

4. **ユーザーへの報告と対応方針の決定**
   - 調査結果を報告
   - 必要に応じて修正方針を協議

---

## 付録: 作成したスクリプト

### A. investigate_kkkbg002blk.py
商品マスタと売上レコードの原価を詳細に調査するスクリプト

### B. check_products.py
商品マスタと2026年1月の売上データを確認するスクリプト

両スクリプトは `rinori-sales-system` ディレクトリに配置されています。

