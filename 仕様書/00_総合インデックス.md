# Rinori 販売管理システム 詳細仕様書 V1.1
## 総合インデックス

**バージョン**: 1.1  
**作成日**: 2025-12-05  
**基準文書**: Rinori 販売管理システム 要件定義書_V1.1

---

## 変更履歴

| バージョン | 日付 | 主な変更内容 |
|-----------|------|------------|
| 1.0 | 2025-12-04 | 初版作成 |
| 1.1 | 2025-12-05 | ユーザー権限機能追加、SKU変換ルール変更、期間予算ロジック変更、画面削除対応 |

---

## V1.0からV1.1への主な変更点

### 新規追加機能

1. **ユーザー権限機能**
   - マスター権限とスタッフ権限の2種類
   - スタッフ権限では月次PL・期間PLの総合計を非表示
   - ユーザーマスタテーブル（users）を追加

2. **期間予算の履歴保持**
   - 期間予算の変更履歴を保存
   - period_budget_histories テーブルを追加
   - 履歴閲覧機能を期間予算編集画面に追加

3. **期間予算編集画面の強化**
   - Excel型UIで月別売上・原価・粗利をリアルタイム自動計算
   - 予算数量変更時に即座に金額が更新

4. **sales_dateカラムの追加**
   - 将来の日次PL対応のために確保（現在はNULL運用）

### 変更された機能

1. **SKU変換ルール**
   - Rule1: ハイフン4区切りパターン → RINO-形式に特化
   - Rule2: ハイフン3区切りパターン → RINOハイフン無し形式に特化

2. **期間予算の端数処理**
   - V1.0: 余りは期間の最初の月から順に加算
   - V1.1: **余りは最終月に寄せる**

### 削除された機能

1. **画面の削除**
   - コード変換チェック画面（SC-08）
   - 広告費CSV取込画面（SC-16）
   - 広告費カテゴリ管理画面（SC-17）
   - 不完全マスタ一覧画面（SC-19）

2. **広告費CSV取込機能**
   - 手入力のみに変更

---

## 仕様書の構成

本仕様書は、Rinori販売管理システムの詳細設計・DB設計・処理フロー・画面仕様を定義した包括的なドキュメントです。
以下の5部構成となっています。

---

## 第1部：システム概要とデータベース設計

**ファイル**: `01_システム概要とDB設計.md`

### 主な内容

1. **システム概要**
   - 目的と技術要件
   - 用語定義
   - **ユーザー権限仕様**【V1.1追加】

2. **データベース設計**
   - ER図
   - 全11テーブルの詳細定義【V1.1: 2テーブル追加】
     - **users（ユーザーマスタ）**【V1.1追加】
     - products（商品マスタ）
     - sales_records（売上実績）【V1.1: sales_date追加】
     - monthly_budgets（月別予算）
     - period_budgets（期間予算）
     - **period_budget_histories（期間予算履歴）**【V1.1追加】
     - ad_expenses（広告費）【V1.1: created_by_user_id追加】
     - ad_categories（広告費カテゴリマスタ）
     - tax_rates（税率設定）
     - import_histories（CSV取込履歴）【V1.1: imported_by_user_id追加】
     - new_product_candidates（新商品候補）

3. **SKU → 親コード変換ルール**【V1.1変更】
   - 3つの変換ルールの詳細（Rule1とRule2が変更）
   - 適用順序と処理フロー

4. **税率設定と税抜換算ロジック**
   - 税率の適用ルール
   - 税抜換算の計算式

5. **管理ステータスと集計対象制御**
   - 管理中 / 管理外の定義
   - 集計対象の判定ロジック
   - 不完全マスタの警告

---

## 第2部：CSV取込処理とデータ変換

**ファイル**: `02_CSV取込処理.md`

### 主な内容

1. **売上CSV取込処理**
   - CSVフォーマット
   - 取込処理フロー
   - 取込モード（追加 / 上書き）
   - 行ごとの処理詳細
   - **実績の即時反映**【V1.1強調】
   - 新商品候補の処理

2. **商品一覧CSV取込処理**
   - CSVフォーマット
   - 取込処理フロー
   - 差分検出ロジック

3. **広告費の入力**【V1.1変更】
   - **手入力のみ**（CSV取込機能は削除）

4. **CSV取込共通仕様**
   - 文字コード判定
   - 数値のパース
   - エラーハンドリング

---

## 第3部：予算管理とPL計算

**ファイル**: `03_予算管理とPL計算.md`

### 主な内容

1. **予算管理**
   - 予算の種類（月別 / 期間）
   - 月別予算の設定と自動計算
   - 期間予算の設定と月別配分【V1.1: 端数処理変更】
   - **期間予算編集画面の強化**【V1.1: Excel型UI、自動計算】
   - **期間予算の履歴保持**【V1.1追加】

2. **予算 vs 実績の進捗確認**
   - 進捗確認の対象期間
   - 商品別進捗の計算

3. **PL（損益計算書）計算**
   - PLの種類（月次 / 期間 / 商品別）
   - 月次PL・期間PLの計算
   - **権限による表示制御**【V1.1追加】
   - 商品別PLの計算

4. **率の計算仕様**
   - 原価率・粗利率・広告率・利益率

---

## 第4部：画面仕様と画面遷移

**ファイル**: `04_画面仕様と画面遷移.md`

### 主な内容

1. **画面一覧**【V1.1: 15画面（4画面削除）】
   - 全15画面のリスト
   - 画面遷移図

2. **画面詳細仕様**
   - SC-01: トップページ【V1.1: 権限制御追加】
   - SC-02: 売上CSV取込画面
   - SC-03: 商品一覧CSV取込画面
   - SC-04: CSV取込履歴画面
   - SC-05: 商品マスタ一覧画面
   - SC-06: 商品マスタ編集画面
   - SC-07: 新商品候補一覧画面
   - SC-09: 月別予算設定画面
   - SC-10: 期間予算編集画面【V1.1: Excel型UI強化】
   - SC-11: 予算 vs 実績一覧画面
   - SC-12: PL画面（月次・期間）【V1.1: 権限制御追加】
   - SC-13: 商品別PL画面
   - SC-14: 広告費入力画面
   - SC-15: 広告費一覧画面
   - SC-18: 税率設定画面

3. **共通UI仕様**
   - ヘッダー・フッター
   - **権限による表示制御**【V1.1追加】
   - エラー表示・成功メッセージ

---

## 第5部：処理フローとバリデーション

**ファイル**: `05_処理フローとバリデーション.md`

### 主な内容

1. **全体処理フロー**
   - 初期セットアップフロー【V1.1: ユーザー作成追加】
   - 月次運用フロー
   - 新商品発生時のフロー

2. **バリデーションルール一覧**
   - **ユーザー**【V1.1追加】
   - 商品マスタ
   - 売上CSV取込
   - 商品一覧CSV取込
   - 月別予算
   - 期間予算
   - 広告費
   - 税率設定

3. **エラーハンドリング**
   - エラーの種類【V1.1: 権限エラー追加】
   - エラー表示の原則
   - トランザクション制御

4. **権限制御**【V1.1追加】
   - 権限チェックのタイミング
   - 権限別アクセス制御

5. **データ整合性チェック**
   - 取込前チェック
   - 取込後チェック

6. **パフォーマンス考慮事項**
   - インデックス戦略
   - 大量データ処理
   - キャッシュ戦略

7. **セキュリティ考慮事項**
   - **認証・認可**【V1.1追加】
   - 入力値の検証
   - ファイルアップロード

8. **ログ・監査**
   - ログ記録【V1.1: ユーザー名追加】
   - 監査証跡【V1.1: 期間予算履歴追加】

9. **テスト方針**
   - 単体テスト【V1.1: 権限チェック追加】
   - 結合テスト【V1.1: 権限制御追加】
   - システムテスト
   - 受入テスト

10. **将来拡張の考慮事項**
    - マルチブランド対応
    - 日次PL
    - 商品別広告費配賦
    - 取込履歴のロールバック
    - API連携
    - **期間予算の自動配分アルゴリズム**【V1.1追加】

---

## 重要な仕様のクイックリファレンス

### SKU → 親コード変換ルール【V1.1変更】

1. **Rule1（V1.1）**: `^(RINO-[A-Z0-9]+)` → RINO-形式
   - 例: `RINO-FR010-X-BLK` → `RINO-FR010`
2. **Rule2（V1.1）**: `^(RINO[A-Z]+[0-9]{3,4})` → RINOハイフン無し形式
   - 例: `RINODO002BLK` → `RINODO002`
3. **Rule3**: その他 → そのまま

**適用順序**: Rule1 → Rule2 → Rule3（最初にマッチしたルールを使用）

### 売上CSV取込モード

| モード | 動作 | 用途 |
|--------|------|------|
| 追加 | 既存実績に加算（差分追加・累積） | 月中の部分的な売上追加 |
| 上書き | 対象月の実績を全削除して再登録 | 月末の確定データで入れ直し |

### 期間予算の端数処理【V1.1変更】

```
月別数量 = 期間合計数量 ÷ 期間の月数（切り捨て）
余り = 期間合計数量 % 期間の月数
```
- **余りは最終月に寄せる**【V1.1】

**例**（期間: 2025-01〜03、合計: 100個）:
- 2025-01: 33個
- 2025-02: 33個
- 2025-03: 34個（33 + 余り1）

### ユーザー権限【V1.1追加】

| 権限 | 説明 | 制限 |
|------|------|------|
| マスター権限 | すべての機能にアクセス可能 | なし |
| スタッフ権限 | 一部機能に制限あり | 月次PL・期間PLの総合計を非表示 |

### PL計算項目

1. **売上**（税別）
2. **原価**（税別）
3. **粗利** = 売上 - 原価
4. **広告費**
5. **営業利益** = 粗利 - 広告費

### 率の計算

- **原価率** = 原価 ÷ 売上 × 100
- **粗利率** = 粗利 ÷ 売上 × 100
- **広告率** = 広告費 ÷ 売上 × 100
- **利益率** = 営業利益 ÷ 売上 × 100

---

## 実装時の注意事項

### 必ず実装すべき項目

1. **ユーザー認証・権限制御**【V1.1追加】
   - ログイン機能
   - セッション管理
   - 権限による表示制御

2. **SKU → 親コード変換**【V1.1変更】
   - 新しいRule1とRule2を実装
   - 適用順序を厳守

3. **期間予算の端数処理**【V1.1変更】
   - 余りは最終月に寄せる

4. **期間予算の履歴保持**【V1.1追加】
   - 保存時に履歴レコードを追加
   - 履歴閲覧機能を実装

5. **期間予算編集画面のExcel型UI**【V1.1追加】
   - 月別売上・原価・粗利のリアルタイム自動計算

6. **実績の即時反映**【V1.1強調】
   - 売上CSV取込後、月次PL・商品別PL・予算vs実績が即時更新

### 実装しない項目（将来拡張）

1. **マルチブランド対応**
2. **日次PL**（sales_dateカラムは確保済み）
3. **商品別広告費配賦**
4. **取込履歴のロールバック**
5. **API連携（広告費自動取込）**
6. **期間予算の自動配分アルゴリズム**

### V1.1で削除された機能

1. **コード変換チェック画面**
2. **広告費CSV取込機能**
3. **広告費カテゴリ管理画面**
4. **不完全マスタ一覧画面**（警告のみで対応）

---

## 用語集

| 用語 | 定義 |
|------|------|
| SKU | ネクストエンジンで管理される商品コード（サイズ・色などのバリエーション含む） |
| 親コード（型番） | SKUから変換された商品の基本コード（バリエーションを除いた商品識別子） |
| 管理中 | 売上・予算・PLの集計対象となる商品ステータス |
| 管理外 | 集計対象外となる商品ステータス（廃盤商品など） |
| 対象年月 | YYYY-MM形式の年月（例: 2025-10） |
| 税別 | 税抜金額（消費税を除いた金額） |
| マスター権限 | すべての機能にアクセス可能な権限（オーナー）【V1.1追加】 |
| スタッフ権限 | 一部機能に制限がある権限（スタッフ）【V1.1追加】 |
| NE | ネクストエンジン（Next Engine） |
| PL | 損益計算書（Profit and Loss statement） |
| D2C | Direct to Consumer（消費者直販） |

---

## 仕様書の使い方

### 実装担当者向け

1. **まず読むべきドキュメント**
   - 総合インデックス（本ファイル）
   - V1.0からV1.1への主な変更点
   - 第1部：システム概要とデータベース設計

2. **機能実装時に参照するドキュメント**
   - 第2部：CSV取込処理とデータ変換
   - 第3部：予算管理とPL計算
   - 第4部：画面仕様と画面遷移
   - 第5部：処理フローとバリデーション

3. **迷ったときの確認事項**
   - 重要な仕様のクイックリファレンス
   - 実装時の注意事項

### レビュー担当者向け

1. **全体像の把握**
   - 総合インデックス（本ファイル）
   - V1.0からV1.1への主な変更点
   - 第1部のER図とテーブル定義

2. **詳細レビュー**
   - 各部の詳細仕様
   - バリデーションルール
   - エラーハンドリング
   - 権限制御【V1.1追加】

### テスト担当者向け

1. **テスト設計時に参照**
   - 第4部：画面仕様と画面遷移
   - 第5部：処理フローとバリデーション

2. **テストケース作成時に参照**
   - バリデーションルール一覧
   - エラーハンドリング
   - データ整合性チェック
   - 権限別動作確認【V1.1追加】

---

以上で、Rinori販売管理システムの詳細仕様書（V1.1）が完成しました。
実装担当者は本仕様書に基づいて開発を進めてください。
