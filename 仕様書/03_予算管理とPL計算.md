# Rinori 販売管理システム 詳細仕様書 V1.3
## 第3部：予算管理とPL計算

**バージョン**: 1.3  
**作成日**: 2025-12-05  
**基準文書**: Rinori 販売管理システム 要件定義書_V1.3

---

## 1. 予算管理

### 1.1 予算の種類

本システムでは2種類の予算を管理する。

| 種類 | 説明 | テーブル |
|------|------|---------|
| 月別予算 | 商品×月ごとの予算 | monthly_budgets |
| 期間予算 | 商品×期間（複数月）の予算 | period_budgets |

**関係性**:
- 期間予算を登録すると、システムが自動的に月別予算を生成
- **予算設定画面（SC-09）で、期間予算と月別予算を統合的に管理**【V1.3変更】

---

## 2. 月別予算

### 2.1 月別予算の設定

**対象商品**:
- `management_status = 'managed'` の商品のみ
- 管理外の商品は予算設定不可

**設定項目**:
1. **予算数量** (budget_quantity): ユーザー入力
2. **予算売上** (budget_sales_excl_tax): 自動計算（手動修正可）
3. **予算原価** (budget_cost_excl_tax): 自動計算
4. **予算粗利** (budget_gross_profit): 自動計算

### 2.2 自動計算ロジック

#### 予算売上の計算
```
予算売上 = 商品マスタの販売価格（税別） × 予算数量
```

**手動修正**:
- ユーザーが予算売上を直接編集可能
- 編集後は自動計算を上書き

#### 予算原価の計算
```
予算原価 = 商品マスタの原価（税別） × 予算数量
```

**注意**:
- 原価が NULL の場合は 0 として計算
- 手動修正は不可（原価は常に自動計算）

#### 予算粗利の計算
```
予算粗利 = 予算売上 - 予算原価
```

**注意**:
- 常に自動計算
- 手動修正は不可

### 2.3 予算設定画面（SC-09）について

**V1.3より、月別予算の設定は「予算設定画面（SC-09）」に統合されました。**
詳細は **3.3 予算設定画面（SC-09）の仕様** を参照してください。

---

## 3. 期間予算と予算設定画面

### 3.1 期間予算の設定

**設定項目**:
1. **商品コード** (product_code): 選択
2. **開始年月** (start_ym): YYYY-MM形式
3. **終了年月** (end_ym): YYYY-MM形式
4. **期間合計数量** (total_quantity): ユーザー入力
5. **備考** (memo): 任意

**制約**:
- start_ym <= end_ym
- 期間は最大24ヶ月（推奨）

### 3.2 期間予算から月別予算への自動配分

期間予算を登録すると、期間内の月に等分して月別予算を生成。

**配分ロジック**:
```
月別数量 = 期間合計数量 ÷ 期間の月数（切り捨て）
余り = 期間合計数量 % 期間の月数
```

**余りの配分**:
- **余りは最終月に寄せる**

**例**:
- 期間: 2025-01 〜 2025-03（3ヶ月）
- 期間合計数量: 100個
- 配分結果:
  - 2025-01: 33個
  - 2025-02: 33個
  - 2025-03: 34個（33 + 余り1）

### 3.3 予算設定画面（SC-09）の仕様【V1.3統合】

**概要**:
V1.3より、月別予算と期間予算の設定画面が統合されました。
ExcelライクなUIで、期間合計と月別数量のどちらからでも入力可能です。

**画面構成**:
- 期間選択（開始年月〜終了年月）
- 期間合計サマリ（リアルタイム更新）
- 商品別予算テーブル（Excel型UI）

**テーブル列構成**:
| 列名 | 説明 | 編集可否 | 位置 |
|------|------|---------|------|
| 商品コード | product_code | 表示のみ | 固定 |
| 商品名 | product_name | 表示のみ | 固定 |
| **期間合計数量** | total_quantity | **編集可** | 固定 |
| 期間売上 | 自動計算 | 表示のみ | 固定 |
| 期間粗利 | 自動計算 | 表示のみ | 固定 |
| 01月 | budget_quantity | **編集可** | スクロール |
| 02月 | budget_quantity | **編集可** | スクロール |
| ... | ... | ... | ... |

**動作仕様**:
1. **期間合計入力時**:
   - 月別数量に自動配分（等分、端数は最終月）
   - 期間売上・粗利を自動計算

2. **月別数量入力時**:
   - 期間合計数量を再計算（合計値で更新）
   - 期間売上・粗利を再計算

3. **リアルタイム計算**:
   - 入力と同時に全ての計算が行われる

### 3.4 期間予算の履歴保持【V1.1新規追加】

**目的**:
- 期間予算の変更履歴を保存
- 後から「なぜこの数字になったのか」を確認可能

**履歴の保存タイミング**:
- 期間予算を保存するたびに `period_budget_histories` テーブルに履歴を追加

**履歴レコードの内容**:
```sql
INSERT INTO period_budget_histories (
    period_budget_id,
    product_code,
    start_ym,
    end_ym,
    total_quantity,
    monthly_breakdown,
    saved_at
) VALUES (
    1,  -- period_budgets.id
    'RINO-FR010',
    '2025-01',
    '2025-03',
    100,
    '{"2025-01": 33, "2025-02": 33, "2025-03": 34}',  -- JSON形式
    CURRENT_TIMESTAMP
);
```

**monthly_breakdown の形式**:
- JSON形式で月別数量を保存
- 例: `{"2025-01": 33, "2025-02": 33, "2025-03": 34}`

**履歴の閲覧**:
- 期間予算編集画面に「履歴を見る」ボタンを配置
- クリックすると履歴一覧をモーダル表示
- 各履歴の保存日時と月別内訳を表示

### 3.5 期間予算のデータ操作

#### 期間予算の登録
```sql
INSERT INTO period_budgets (
    product_code, start_ym, end_ym, total_quantity, memo
) VALUES (
    'RINO-FR010', '2025-01', '2025-03', 100, 'Q1予算'
);
```

#### 期間予算の更新
```sql
UPDATE period_budgets
SET total_quantity = 120,
    memo = 'Q1予算（修正）',
    updated_at = CURRENT_TIMESTAMP
WHERE id = 1;
```

#### 期間予算の削除
```sql
DELETE FROM period_budgets WHERE id = 1;
```

**注意**:
- 期間予算を削除しても、既に生成された月別予算は削除されない
- 月別予算は独立して管理される

---

## 4. 予算 vs 実績の進捗確認

### 4.1 進捗確認の対象期間

以下の期間指定が可能。

| 期間種別 | 説明 | 例 |
|---------|------|-----|
| 単月 | 特定の1ヶ月 | 2025-10 |
| 複数月範囲 | 任意の開始〜終了月 | 2025-10 〜 2025-12 |
| 3ヶ月 | 直近3ヶ月 | 自動計算 |
| 6ヶ月 | 直近6ヶ月 | 自動計算 |
| 期首〜現在 | 年度開始〜現在月 | 自動計算 |

### 4.2 商品別進捗の計算

**集計SQL**:
```sql
SELECT 
    p.product_code,
    p.product_name,
    -- 予算
    COALESCE(SUM(mb.budget_quantity), 0) AS budget_quantity,
    COALESCE(SUM(mb.budget_sales_excl_tax), 0) AS budget_sales,
    COALESCE(SUM(mb.budget_cost_excl_tax), 0) AS budget_cost,
    COALESCE(SUM(mb.budget_gross_profit), 0) AS budget_gross_profit,
    -- 実績
    COALESCE(SUM(sr.quantity), 0) AS actual_quantity,
    COALESCE(SUM(sr.sales_amount_excl_tax), 0) AS actual_sales,
    COALESCE(SUM(sr.cost_amount_excl_tax), 0) AS actual_cost,
    COALESCE(SUM(sr.gross_profit), 0) AS actual_gross_profit,
    -- 達成率
    CASE 
        WHEN SUM(mb.budget_quantity) > 0 
        THEN (SUM(sr.quantity) * 100.0 / SUM(mb.budget_quantity))
        ELSE NULL 
    END AS quantity_achievement_rate,
    CASE 
        WHEN SUM(mb.budget_sales_excl_tax) > 0 
        THEN (SUM(sr.sales_amount_excl_tax) * 100.0 / SUM(mb.budget_sales_excl_tax))
        ELSE NULL 
    END AS sales_achievement_rate
FROM products p
LEFT JOIN monthly_budgets mb 
    ON p.product_code = mb.product_code 
    AND mb.period_ym BETWEEN '2025-10' AND '2025-12'
LEFT JOIN sales_records sr 
    ON p.product_code = sr.product_code 
    AND sr.period_ym BETWEEN '2025-10' AND '2025-12'
WHERE p.management_status = 'managed'
GROUP BY p.product_code, p.product_name
ORDER BY p.product_code;
```

### 4.3 進捗確認画面の仕様

**表示項目**:
| 列名 | 説明 | 計算式 |
|------|------|--------|
| 商品コード | product_code | - |
| 商品名 | product_name | - |
| 予算数量 | budget_quantity | SUM(monthly_budgets.budget_quantity) |
| 実績数量 | actual_quantity | SUM(sales_records.quantity) |
| 数量達成率 | quantity_achievement_rate | 実績数量 ÷ 予算数量 × 100 |
| 予算売上（税別） | budget_sales | SUM(monthly_budgets.budget_sales_excl_tax) |
| 実績売上（税別） | actual_sales | SUM(sales_records.sales_amount_excl_tax) |
| 売上達成率 | sales_achievement_rate | 実績売上 ÷ 予算売上 × 100 |
| 予算粗利 | budget_gross_profit | SUM(monthly_budgets.budget_gross_profit) |
| 実績粗利 | actual_gross_profit | SUM(sales_records.gross_profit) |

**達成率の色分け**:
- 100%以上: 緑色
- 80%以上100%未満: 黄色
- 80%未満: 赤色

**ソート・フィルタ**:
- 全列でソート可能
- 達成率でフィルタ（100%以上 / 80%以上 / 80%未満）

**権限による表示制御**:
- マスター権限: 全商品の進捗を表示
- スタッフ権限: 全商品の進捗を表示（総合計は非表示）

---

## 5. PL（損益計算書）計算

### 5.1 PLの種類

| 種類 | 説明 | 集計単位 |
|------|------|---------|
| 月次PL | 特定月のPL | 単月 |
| 期間PL | 複数月のPL | 期間合計 |
| 商品別PL | 商品ごとのPL | 商品×期間 |

### 5.2 月次PL・期間PLの計算

**計算項目**:
1. **売上**（税別）
2. **原価**（税別）
3. **粗利** = 売上 - 原価
4. **広告費**
5. **営業利益** = 粗利 - 広告費

**各項目の率**:
- **原価率** = 原価 ÷ 売上 × 100
- **粗利率** = 粗利 ÷ 売上 × 100
- **広告率** = 広告費 ÷ 売上 × 100
- **利益率** = 営業利益 ÷ 売上 × 100

### 5.3 月次PLの計算SQL

```sql
-- 売上・原価・粗利の集計
SELECT 
    COALESCE(SUM(sr.sales_amount_excl_tax), 0) AS sales,
    COALESCE(SUM(sr.cost_amount_excl_tax), 0) AS cost,
    COALESCE(SUM(sr.gross_profit), 0) AS gross_profit
FROM sales_records sr
INNER JOIN products p ON sr.product_code = p.product_code
WHERE p.management_status = 'managed'
  AND sr.period_ym = '2025-10';

-- 広告費の集計
SELECT 
    COALESCE(SUM(ae.amount), 0) AS ad_expense
FROM ad_expenses ae
WHERE DATE_FORMAT(ae.expense_date, '%Y-%m') = '2025-10';

-- 営業利益の計算
営業利益 = 粗利 - 広告費
```

### 5.4 期間PLの計算SQL

```sql
-- 売上・原価・粗利の集計
SELECT 
    COALESCE(SUM(sr.sales_amount_excl_tax), 0) AS sales,
    COALESCE(SUM(sr.cost_amount_excl_tax), 0) AS cost,
    COALESCE(SUM(sr.gross_profit), 0) AS gross_profit
FROM sales_records sr
INNER JOIN products p ON sr.product_code = p.product_code
WHERE p.management_status = 'managed'
  AND sr.period_ym BETWEEN '2025-10' AND '2025-12';

-- 広告費の集計
SELECT 
    COALESCE(SUM(ae.amount), 0) AS ad_expense
FROM ad_expenses ae
WHERE ae.expense_date BETWEEN '2025-10-01' AND '2025-12-31';
```

### 5.5 PL画面の仕様【V1.1権限制御追加】

**表示形式（マスター権限）**:
```
売上（税別）:        1,000,000円
原価（税別）:          400,000円 (40.0%)
─────────────────────────────
粗利:                  600,000円 (60.0%)
広告費:                200,000円 (20.0%)
─────────────────────────────
営業利益:              400,000円 (40.0%)
```

**表示形式（スタッフ権限）**【V1.1追加】:
```
🔴 総合計は非表示

※ 商品別PLは閲覧可能
```

**権限による表示制御**:
- **マスター権限**: 総合計（売上・原価・粗利・広告費・営業利益・各率）を表示
- **スタッフ権限**: 総合計を**非表示**

**率の表示**:
- カッコ書きで併記
- 小数点以下1桁まで表示
- 売上が 0 の場合は率を表示しない

**期間選択**:
- 単月（YYYY-MM）
- 3ヶ月（直近3ヶ月）
- 6ヶ月（直近6ヶ月）
- 期首〜現在（年度開始〜現在月）
- 任意の範囲（YYYY-MM 〜 YYYY-MM）

---

## 6. 商品別PL

### 6.1 商品別PLの計算

**計算項目**:
1. **売上**（税別）
2. **原価**（税別）
3. **粗利** = 売上 - 原価
4. **原価率** = 原価 ÷ 売上 × 100
5. **粗利率** = 粗利 ÷ 売上 × 100

**注意**:
- 広告費の商品別配賦は現フェーズでは実装しない
- 将来拡張で対応予定

### 6.2 商品別PLの計算SQL

```sql
SELECT 
    p.product_code,
    p.product_name,
    COALESCE(SUM(sr.sales_amount_excl_tax), 0) AS sales,
    COALESCE(SUM(sr.cost_amount_excl_tax), 0) AS cost,
    COALESCE(SUM(sr.gross_profit), 0) AS gross_profit,
    CASE 
        WHEN SUM(sr.sales_amount_excl_tax) > 0 
        THEN (SUM(sr.cost_amount_excl_tax) * 100.0 / SUM(sr.sales_amount_excl_tax))
        ELSE 0 
    END AS cost_rate,
    CASE 
        WHEN SUM(sr.sales_amount_excl_tax) > 0 
        THEN (SUM(sr.gross_profit) * 100.0 / SUM(sr.sales_amount_excl_tax))
        ELSE 0 
    END AS gross_profit_rate
FROM products p
LEFT JOIN sales_records sr 
    ON p.product_code = sr.product_code 
    AND sr.period_ym BETWEEN '2025-10' AND '2025-12'
WHERE p.management_status = 'managed'
GROUP BY p.product_code, p.product_name
ORDER BY sales DESC;
```

### 6.3 商品別PL画面の仕様

**表示項目**:
| 列名 | 説明 | 計算式 |
|------|------|--------|
| 商品コード | product_code | - |
| 商品名 | product_name | - |
| 売上（税別） | sales | SUM(sales_amount_excl_tax) |
| 原価（税別） | cost | SUM(cost_amount_excl_tax) |
| 粗利 | gross_profit | SUM(gross_profit) |
| 原価率 | cost_rate | 原価 ÷ 売上 × 100 |
| 粗利率 | gross_profit_rate | 粗利 ÷ 売上 × 100 |

**ソート**:
- デフォルト: 売上降順
- 全列でソート可能

**フィルタ**:
- 自社商品のみ / 仕入商品のみ / 両方
- 売上が 0 の商品を除外

**権限による表示制御**:
- **マスター権限**: 全商品のPLを表示
- **スタッフ権限**: 全商品のPLを表示（商品別は閲覧可能）

---

## 7. 率の計算仕様

### 7.1 計算式

| 率 | 計算式 | 備考 |
|-----|--------|------|
| 原価率 | 原価 ÷ 売上 × 100 | 売上が 0 の場合は 0 |
| 粗利率 | 粗利 ÷ 売上 × 100 | 売上が 0 の場合は 0 |
| 広告率 | 広告費 ÷ 売上 × 100 | 売上が 0 の場合は 0 |
| 利益率 | 営業利益 ÷ 売上 × 100 | 売上が 0 の場合は 0 |

### 7.2 表示形式

- 小数点以下1桁まで表示
- 例: `40.0%`
- 売上が 0 の場合は `-` を表示

### 7.3 丸め処理

- 計算結果を小数点以下2桁で四捨五入
- 表示時は小数点以下1桁で四捨五入

---

この仕様書は第3部として、予算管理とPL計算の詳細を定義しました。
次の第4部では、画面仕様と画面遷移の詳細を定義します。
