# Rinori 売上管理システム テスト仕様書（詳細テストケース）

- 文書名: Rinori 売上管理システム テスト仕様書
- 版数: 0.9（ドラフト）
- 作成日: 2025-12-09
- 関連文書:
  - `テスト計画書.md`
  - 要件定義書一式
  - 仕様書 `00_〜05_*.md`

---

## 1. 共通事項

### 1.1 テストケースID命名規則

- 形式: `TC-<画面ID>-<連番3桁>`
  - 例: `TC-SC01-001`
- 画面に依存しない共通テストは `TC-COM-xxx` とする。

### 1.2 結果区分

- OK: 期待結果どおり
- NG: 期待結果と異なる（差分内容を記録すること）

---

## 2. 共通・権限制御テスト

### 2.1 ログイン・権限関連（共通）

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-COM-001 | ログイン必須画面への未ログインアクセス制御 | ブラウザのセッションにログイン情報が無い状態 | 1. 直接URLで任意の保護画面（例: SC-05 商品マスタ一覧）にアクセスする | ログイン画面へリダイレクトされること。エラー画面やホワイトアウトにならないこと。 |
| TC-COM-002 | マスター権限ユーザーでのログイン | usersテーブルに role='master' の有効ユーザーが登録済み | 1. ログイン画面を表示 2. masterユーザーのID/PWを入力してログイン | ログイン成功し、ヘッダーにユーザー名と「マスター権限」が表示されること。マスター専用機能へのメニューが表示されること。 |
| TC-COM-003 | スタッフ権限ユーザーでのログイン | usersテーブルに role='staff' の有効ユーザーが登録済み | 1. ログイン画面を表示 2. staffユーザーのID/PWを入力してログイン | ログイン成功し、ヘッダーにユーザー名と「スタッフ権限」が表示されること。マスター専用機能がメニューに表示されない、またはアクセスすると権限エラーとなること。 |

---

## 3. SC-01 トップページ / ダッシュボード

### 3.1 画面表示・権限制御

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC01-001 | マスター権限でのトップページ表示 | masterユーザーでログイン済み。売上・予算・広告費などのサンプルデータがDBに存在すること。 | 1. ログイン後、自動的にトップページへ遷移、またはメニューからトップページを表示 | 「今月のサマリ」が表示され、売上・粗利・営業利益および各率が仕様どおりに表示されること。主要商品 予算 vs 実績ウィジェットが表示されること。警告・通知エリアに不完全マスタ／新商品候補がある場合は件数が表示されること。 |
| TC-SC01-002 | スタッフ権限でのトップページ表示（総合サマリ非表示） | staffユーザーでログイン済み。 | 1. ログイン後、トップページを表示 | 「今月のサマリ」セクションが**表示されない**こと。それ以外の主要商品予算 vs 実績や警告エリアは表示されること。 |
| TC-SC01-003 | 不完全マスタ警告の表示 | products.management_status='managed' かつ sales_price_excl_tax または cost_excl_tax がNULLのレコードが存在する | 1. masterまたはstaffでトップページを表示 | 画面上部に「商品マスタに未設定項目があります（X件）」の警告バナーが表示され、クリックで詳細一覧（モーダル等）が表示されること。件数XがDBと一致すること。 |

---

## 4. SC-02 売上CSV取込

### 4.1 正常系（追加モード）

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC02-001 | 追加モードでの正常取込 | 対象年月=2025-10の売上データが sales_records に存在しない、または一部のみ存在する状態。税率マスタに 2025-10 以前の適用開始年月レコードが存在すること。 | 1. SC-02画面を表示 2. 対象年月に `2025-10` を入力 3. 取込モードで「追加」を選択 4. 正しい形式の売上CSVファイルを選択 5. 「取込実行」ボタンを押下 | エラーなく取込が完了すること。import_histories に1件追加され、sales_records にCSVの行数分のレコードが追加されること。税込金額から税別金額への変換が仕様どおり行われていること。 |

### 4.2 正常系（上書きモード）

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC02-002 | 上書きモードでの既存実績置き換え | 対象年月=2025-10 に既に sales_records が複数件登録されていること。 | 1. SC-02画面を表示 2. 対象年月に `2025-10` を入力 3. 取込モードで「上書き」を選択 4. 正しい形式の売上CSVを選択 5. 「取込実行」押下 6. 上書き確認ダイアログで「OK」を選択 | 対象年月=2025-10 の既存 sales_records が削除されたうえで、CSV内容に基づき再登録されること。import_histories にモード='overwrite' で記録されること。 |

### 4.3 異常系・バリデーション

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC02-003 | 対象年月の未入力 | なし | 1. SC-02を表示 2. 対象年月を空欄のまま、取込モードを選択しCSVを指定 3. 「取込実行」を押下 | 「対象年月は必須です」等のエラーメッセージが画面上部に赤字で表示されること。取り込み処理は行われないこと。 |
| TC-SC02-004 | 税率未設定エラー | 税率マスタに、対象年月 2020-01 よりも前のレコードが1件も登録されていない状態。 | 1. SC-02を表示 2. 対象年月に `2020-01` を入力 3. 取込モード「追加」を選択 4. 正しい形式のCSVを指定 5. 「取込実行」を押下 | 税率未設定エラーとして処理が中断され、仕様書どおりのエラーメッセージが表示されること。sales_records への登録は行われないこと。 |

---

## 5. SC-03 商品一覧CSV取込

### 5.1 差分検出・一括選択

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC03-001 | 差分候補一覧の表示 | productsテーブルに一部の商品が登録済み。CSVには新規・更新・既存（変更なし）が混在していること。 | 1. SC-03画面を表示 2. 商品一覧CSVを指定 3. コメントを任意で入力 4. 「差分チェック」を押下 | 差分候補一覧が表示され、「新規」「更新」「変更なし」等の区分が仕様どおり判定されていること。 |
| TC-SC03-002 | 一括選択／一括解除ボタンの動作 | TC-SC03-001と同じ前提で差分候補一覧が表示されていること。 | 1. 「全て選択」ボタンを押下 2. 全行にチェックが付くことを確認 3. 「全て解除」ボタンを押下 | 「全て選択」で全候補にチェックが入り、「全て解除」で全てのチェックが外れること。 |

---

## 6. SC-05 商品マスタ一覧 & SC-06 商品マスタ編集

### 6.1 一覧の検索・フィルタ・ソート

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC05-001 | 商品コード・商品名検索 | productsテーブルに複数の商品が登録済み。 | 1. SC-05を表示 2. 検索ボックスに部分一致するキーワードを入力 3. 「検索」ボタンを押下 | 入力したキーワードを商品コードまたは商品名に含む商品だけが一覧に表示されること。 |
| TC-SC05-002 | 管理ステータスフィルタ | products.management_status が `managed` / `unmanaged` で混在。 | 1. SC-05を表示 2. フィルタ条件で「管理中」を選択 3. 検索またはフィルタ適用操作を実行 | 一覧には management_status='managed' の商品のみ表示されること。「管理外」を選択した場合は逆になること。 |

### 6.2 商品マスタ編集・バリデーション

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC06-001 | 必須項目正常登録 | 新規登録モードでSC-06を表示できること。 | 1. SC-06を新規モードで表示 2. 商品コード・商品名・販売価格・原価・商品区分・管理ステータスを全て正しく入力 3. 「保存」押下 | 入力内容で products にレコードが登録されること。SC-05一覧に新商品が表示されること。 |
| TC-SC06-002 | 必須項目未入力時のエラー | 1項目以上の必須項目が未入力。 | 1. SC-06を新規モードで表示 2. 商品コードを空欄のまま他の項目のみ入力 3. 「保存」押下 | 「商品コードは必須です」等のエラーが画面上部に表示され、登録処理が行われないこと。 |

---

## 7. SC-07 新商品候補一覧

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC07-001 | 新商品候補の一覧表示 | new_product_candidates に status='pending' のレコードが複数存在。 | 1. SC-07を表示 | 対象レコードが一覧に表示され、親コード・元SKU例・商品名・検出日時が仕様どおり表示されること。 |
| TC-SC07-002 | 候補を「管理中として登録」する | TC-SC07-001と同じ前提。 | 1. 任意の候補にチェック 2. 「管理中として登録」ボタンを押下 | productsに該当商品が登録され、new_product_candidates.status が 'registered' へ更新されること。 |

---

## 8. SC-09 予算設定（期間予算 + 月別予算）

### 8.1 期間合計 → 月別自動配分

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC09-001 | 期間合計数量入力時の月別自動配分（端数最終月寄せ） | 期間: 2025-01〜2025-03（3ヶ月）。対象商品の単価・原価がproductsに設定済み。 | 1. SC-09を表示 2. 開始年月=2025-01、終了年月=2025-03を指定し「表示」 3. 任意の商品行の「期間合計数量」に `100` を入力 | 月別数量が `33, 33, 34` に自動配分されること。期間売上・期間粗利が単価・原価に基づき自動計算されること。画面上部の期間合計サマリが更新されること。 |

### 8.2 月別数量変更 → 期間合計再計算

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC09-002 | 月別数量直接編集時の期間合計再計算 | TC-SC09-001実施後の状態。 | 1. 任意の月の数量を `40` に変更 2. 入力フィールドからフォーカスアウト | その商品の期間合計数量が月別数量の合計値に更新されること。期間売上・期間粗利も再計算されること。 |

### 8.3 保存時の履歴レコード作成

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC09-003 | 期間予算保存時の period_budget_histories 作成 | 期間予算未登録、または既存ありの状態。 | 1. SC-09で期間・数量を設定 2. 「保存」ボタンを押下 | period_budgets に期間予算が保存されると同時に、period_budget_histories に月別内訳（JSON）が保存されること。履歴テーブルの saved_at が現在時刻であること。 |

---

## 9. SC-11 予算 vs 実績

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC11-001 | 予算数量・実績数量・達成率の計算 | 対象期間に対して monthly_budgets と sales_records にデータが存在。 | 1. SC-11を表示し、対象期間を指定 2. 一覧表示を確認 | 各商品行で、予算数量・実績数量・数量達成率、予算売上・実績売上・売上達成率が仕様書の計算式どおりになっていること。管理外商品が一覧に表示されない、または集計対象外であること。 |

---

## 10. SC-12 PL画面（月次・期間）

### 10.1 期間選択UI

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC12-001 | プリセット期間選択（単月） | sales_records に複数月分のデータが存在。 | 1. SC-12を表示 2. 期間種別で「単月」を選択 3. 対象年月を指定 4. 「表示」押下 | 対象月のみを集計したPLが表示されること。UI上で他の期間入力欄がdisableになること。 |

### 10.2 権限制御（総合計の表示/非表示）

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC12-002 | マスター権限での総合計表示 | masterユーザーでログイン済み。 | 1. SC-12を表示し任意の期間を指定 2. 「表示」押下 | 売上・原価・粗利・広告費・営業利益および各率が総合計として表示されること。 |
| TC-SC12-003 | スタッフ権限での総合計非表示 | staffユーザーでログイン済み。 | 1. SC-12を表示し任意の期間を指定 2. 「表示」押下 | 「総合計」セクションが表示されないこと（またはマスクされること）。エラーにはならないこと。 |

---

## 11. SC-13 商品別PL

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC13-001 | 期間選択・検索・ソート | sales_records に複数商品・複数期間のデータが存在。 | 1. SC-13を表示 2. 期間種別を「単月」や「複数月範囲」に切り替え対象期間を指定 3. 商品検索キーワードを入力 4. 商品コード列ヘッダーをクリックして昇順/降順を切り替え | 一覧に表示される商品と集計値が指定期間・検索条件に一致すること。ソート順が昇順→降順に正しく切り替わること。 |

---

## 12. SC-14 広告費管理

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC14-001 | 広告費一覧タブでの新規行追加 | ad_categories に1件以上登録済。 | 1. SC-14を表示 2. 「広告費一覧」タブを選択 3. 最下部の新規行で日付・金額・カテゴリ・メモを入力 4. 「保存」押下 | ad_expenses に新規レコードが登録されること。一覧に即時反映されること。 |
| TC-SC14-002 | 広告費一覧タブでのインライン編集 | TC-SC14-001で作成した行が存在。 | 1. 対象行の金額セルをクリックし値を変更 2. フォーカスアウト | 変更内容がDBに保存され、再読み込み後も反映されていること。 |
| TC-SC14-003 | カテゴリ管理タブでのカテゴリ追加 | ad_categories に既存カテゴリがある状態。 | 1. 「カテゴリ管理」タブを選択 2. 最下部の新規行でカテゴリ名を入力 3. 「保存」押下 | ad_categoriesに新カテゴリが追加され、「広告費一覧」タブのカテゴリ選択肢に新カテゴリが表示されること。 |

---

## 13. SC-18 税率設定

| テストケースID | 観点 | 前提条件 | 手順 | 期待結果 |
|-----------------|------|----------|------|----------|
| TC-SC18-001 | 税率の新規登録 | tax_rates に既存レコードがある状態。 | 1. SC-18を表示 2. 新規行で start_ym と rate を入力 3. 「保存」押下 | tax_rates に新規レコードが登録されること。start_ym がユニークであること。 |
| TC-SC18-002 | start_ym 重複時のエラー | 既に start_ym='2019-10' のレコードが存在。 | 1. SC-18を表示 2. start_ym='2019-10' で新規税率を登録しようとする 3. 「保存」押下 | 「start_ym は既に登録されています」等のエラーが表示され、登録されないこと。 |

---

## 14. 補足

- 本テスト仕様書はドラフトであり、実装の詳細確定後にテストケースを追加・修正する。
- 実行時には、各テストケースごとに「実施日」「担当者」「結果（OK/NG）」「NG時の詳細」「関連チケットID」等の欄を別紙またはツールで管理すること。
