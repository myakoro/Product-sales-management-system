# Rinori 販売管理システム 詳細設計書 V1.4.5

## 📋 ドキュメント情報

**バージョン**: V1.4.5（V1.4修正版）  
**作成日**: 2025-12-15  
**目的**: V1.4.5修正計画書に基づく詳細実装仕様  
**前提**: 要件定義書 V1.3/V1.4 に完全準拠

---

## 🎯 V1.4.5 修正概要

### 修正の背景
V1.4実装時に以下の問題が発生:
1. 要件定義書との仕様相違（広告費管理のタブ構成等）
2. 未実装機能（CSV様式ダウンロード等）
3. 導線の欠落（ダッシュボードメニュー構成）
4. 初期データ未反映（seed.js実行漏れ）

### 修正方針
要件定義書V1.3/V1.4を絶対基準とし、仕様相違を修正し、未実装機能を追加する。

---

## 📦 Phase 1: 緊急対応の詳細設計

### 1-1. CSV様式ダウンロード機能

#### 1-1-1. 概要
手動でCSVを作成するユーザー向けに、正しい様式のサンプルCSVをダウンロード可能にする。

#### 1-1-2. サンプルCSVファイル仕様

**ファイル名**: `sales_template.csv`  
**配置場所**: `public/templates/sales_template.csv`  
**エンコーディング**: **Shift-JIS**（要件定義書に明記）  
**MIME Type**: `text/csv; charset=Shift_JIS`

**ファイル内容**:
```csv
商品コード,受注数,売上金額（税込）,商品名
RINO-FR010-X-BLK,10,50000,サンプル商品1
RINODO002BLK,5,25000,サンプル商品2
```

**列の説明**:
1. **商品コード**: SKU（親コード変換ルールが適用される）
2. **受注数**: 販売数量
3. **売上金額（税込）**: 税込売上金額（システムが税抜換算）
4. **商品名**: 商品名称（参考情報、マスタ登録には使用しない）

#### 1-1-3. UI設計

**画面**: `/import/sales` (売上CSV取込)  
**配置位置**: ページ上部、ファイル選択エリアの上

**HTML構造**:
```tsx
<div className="bg-blue-50 border border-blue-200 rounded p-4 mb-6">
  <div className="flex items-start gap-3">
    <div className="text-blue-600 text-2xl">📥</div>
    <div className="flex-1">
      <h3 className="font-semibold text-blue-900 mb-1">
        CSV様式をダウンロード
      </h3>
      <p className="text-sm text-blue-700 mb-3">
        ネクストエンジン以外で手動作成する場合は、この様式に従ってください
      </p>
      <a
        href="/templates/sales_template.csv"
        download="売上CSV様式.csv"
        className="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
      >
        CSV様式ダウンロード
      </a>
    </div>
  </div>
  
  <div className="mt-4 pt-4 border-t border-blue-200">
    <div className="flex items-center gap-2">
      <span className="text-blue-600">📋</span>
      <span className="text-sm text-blue-700">
        過去の取込履歴を確認・修正する
      </span>
      <Link 
        href="/import/history" 
        className="text-blue-600 hover:underline text-sm font-medium"
      >
        取込履歴を見る →
      </Link>
    </div>
  </div>
</div>
```

#### 1-1-4. ダウンロード処理

**方式1: 静的ファイル配信（推奨）**
- `public/templates/sales_template.csv` を配置
- Next.jsが自動的に `/templates/sales_template.csv` として配信
- エンコーディング: ファイル作成時にShift-JISで保存

**方式2: API経由（動的生成）**
- エンドポイント: `GET /api/templates/sales-csv`
- レスポンス: Shift-JIS変換したCSVデータ
- ヘッダー: `Content-Type: text/csv; charset=Shift_JIS`

**採用方式**: 方式1（静的ファイル配信）

#### 1-1-5. 修正ファイル
- `public/templates/sales_template.csv` (新規作成)
- `src/app/import/sales/page.tsx` (修正)

---

### 1-2. 広告費の編集・削除機能

#### 1-2-1. 概要
V1.3要件「インライン編集」を実装し、登録後の広告費データを修正・削除可能にする。

#### 1-2-2. API設計

**エンドポイント**: `/api/ad-expenses`

**既存メソッド**:
- `GET`: 広告費一覧取得（実装済み）
- `POST`: 新規広告費登録（実装済み）

**追加メソッド**:

##### PUT: 広告費の編集
```typescript
// Request
PUT /api/ad-expenses
Content-Type: application/json

{
  "id": 123,
  "expenseDate": "2025-12-01",
  "amount": 50000,
  "adCategoryId": 1,
  "memo": "Meta広告 12月分"
}

// Response (成功)
200 OK
{
  "id": 123,
  "expenseDate": "2025-12-01T00:00:00.000Z",
  "amount": 50000,
  "adCategoryId": 1,
  "memo": "Meta広告 12月分",
  "createdAt": "2025-12-01T10:00:00.000Z"
}

// Response (エラー)
400 Bad Request
{
  "error": "必須項目が不足しています"
}

401 Unauthorized
{
  "error": "Unauthorized"
}
```

##### DELETE: 広告費の削除
```typescript
// Request
DELETE /api/ad-expenses?id=123

// Response (成功)
200 OK
{
  "success": true
}

// Response (エラー)
404 Not Found
{
  "error": "広告費が見つかりません"
}

401 Unauthorized
{
  "error": "Unauthorized"
}
```

**認証**: 両メソッドともログイン必須（マスター・スタッフ両方可）

#### 1-2-3. データベース操作

**PUT処理**:
```typescript
await prisma.adExpense.update({
  where: { id: Number(id) },
  data: {
    expenseDate: new Date(expenseDate),
    amount: Number(amount),
    adCategoryId: Number(adCategoryId),
    memo: memo || null
  }
});
```

**DELETE処理**:
```typescript
await prisma.adExpense.delete({
  where: { id: Number(id) }
});
```

#### 1-2-4. UI設計

**画面**: `/ad-expenses` (広告費管理)

**現状**: 右側に新規登録フォーム、左側にテーブル（表示のみ）

**修正後**: テーブルにインライン編集機能を追加

##### テーブル構造
```tsx
<table>
  <thead>
    <tr>
      <th>日付</th>
      <th>カテゴリ</th>
      <th>金額</th>
      <th>メモ</th>
      <th>操作</th> {/* 新規追加 */}
    </tr>
  </thead>
  <tbody>
    {expenses.map(expense => (
      <tr key={expense.id}>
        {editingId === expense.id ? (
          // 編集モード
          <>
            <td>
              <input type="date" value={editDate} onChange={...} />
            </td>
            <td>
              <select value={editCategoryId} onChange={...}>
                {categories.map(c => <option value={c.id}>{c.categoryName}</option>)}
              </select>
            </td>
            <td>
              <input type="number" value={editAmount} onChange={...} />
            </td>
            <td>
              <input type="text" value={editMemo} onChange={...} />
            </td>
            <td>
              <button onClick={handleSave}>保存</button>
              <button onClick={handleCancel}>キャンセル</button>
            </td>
          </>
        ) : (
          // 表示モード
          <>
            <td>{formatDate(expense.expenseDate)}</td>
            <td>{expense.adCategory.categoryName}</td>
            <td>{expense.amount.toLocaleString()}円</td>
            <td>{expense.memo || '-'}</td>
            <td>
              <button onClick={() => startEdit(expense)}>編集</button>
              <button onClick={() => handleDelete(expense.id)}>削除</button>
            </td>
          </>
        )}
      </tr>
    ))}
  </tbody>
</table>
```

##### 状態管理
```typescript
const [editingId, setEditingId] = useState<number | null>(null);
const [editDate, setEditDate] = useState("");
const [editCategoryId, setEditCategoryId] = useState("");
const [editAmount, setEditAmount] = useState("");
const [editMemo, setEditMemo] = useState("");

const startEdit = (expense: AdExpense) => {
  setEditingId(expense.id);
  setEditDate(formatDateForInput(expense.expenseDate));
  setEditCategoryId(String(expense.adCategoryId));
  setEditAmount(String(expense.amount));
  setEditMemo(expense.memo || "");
};

const handleSave = async () => {
  const res = await fetch('/api/ad-expenses', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      id: editingId,
      expenseDate: editDate,
      amount: Number(editAmount),
      adCategoryId: Number(editCategoryId),
      memo: editMemo
    })
  });
  
  if (res.ok) {
    setEditingId(null);
    fetchExpenses(); // リスト再取得
  }
};

const handleDelete = async (id: number) => {
  if (!confirm('この広告費を削除しますか？')) return;
  
  const res = await fetch(`/api/ad-expenses?id=${id}`, {
    method: 'DELETE'
  });
  
  if (res.ok) {
    fetchExpenses(); // リスト再取得
  }
};
```

#### 1-2-5. 修正ファイル
- `src/app/api/ad-expenses/route.ts` (PUT/DELETE追加)
- `src/app/ad-expenses/page.tsx` (UI修正)

---

### 1-3. ダッシュボードメニューの再構成

#### 1-3-1. 概要
要件定義書V1.4に従い、メニューをカテゴリ構造に変更し、「取込履歴」「販路マスタ」への導線を追加。

#### 1-3-2. メニュー構造

**現状（フラット）**:
```
- 商品マスタ管理
- 商品CSV取込
- 売上CSV取込
- 予算設定
- 予算 vs 実績
- PL確認
- 広告費管理
- 税率設定
- アカウント設定
- ユーザー管理（マスター）
- データエクスポート（マスター）
- データ復元（マスター）
```

**修正後（カテゴリ構造）**:
```
📦 商品
  - 商品マスタ管理
  - 商品CSV取込
  - 新商品候補

💰 売上
  - 売上CSV取込
  - 取込履歴 ← 追加

📊 予算・PL
  - 予算設定
  - 予算 vs 実績
  - 月次PL
  - 商品別PL

📢 広告費管理

⚙️ 設定
  - 販路マスタ ← 追加
  - 税率設定
  - アカウント設定
  - ユーザー管理（マスター）
  - データエクスポート（マスター）
  - データ復元（マスター）
```

#### 1-3-3. UI設計

**画面**: `/` (ダッシュボード)

**実装方式**: グループ化されたカードレイアウト

```tsx
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  {/* 商品カテゴリ */}
  <div className="bg-white rounded-lg shadow p-6">
    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
      <span>📦</span>
      <span>商品</span>
    </h3>
    <ul className="space-y-2">
      <li>
        <Link href="/products" className="text-blue-600 hover:underline">
          商品マスタ管理
        </Link>
      </li>
      <li>
        <Link href="/import/products" className="text-blue-600 hover:underline">
          商品CSV取込
        </Link>
      </li>
      <li>
        <Link href="/products/candidates" className="text-blue-600 hover:underline">
          新商品候補
        </Link>
      </li>
    </ul>
  </div>

  {/* 売上カテゴリ */}
  <div className="bg-white rounded-lg shadow p-6">
    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
      <span>💰</span>
      <span>売上</span>
    </h3>
    <ul className="space-y-2">
      <li>
        <Link href="/import/sales" className="text-blue-600 hover:underline">
          売上CSV取込
        </Link>
      </li>
      <li>
        <Link href="/import/history" className="text-blue-600 hover:underline">
          取込履歴
        </Link>
      </li>
    </ul>
  </div>

  {/* 予算・PLカテゴリ */}
  <div className="bg-white rounded-lg shadow p-6">
    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
      <span>📊</span>
      <span>予算・PL</span>
    </h3>
    <ul className="space-y-2">
      <li>
        <Link href="/budget" className="text-blue-600 hover:underline">
          予算設定
        </Link>
      </li>
      <li>
        <Link href="/budget/vs-actual" className="text-blue-600 hover:underline">
          予算 vs 実績
        </Link>
      </li>
      <li>
        <Link href="/pl/monthly" className="text-blue-600 hover:underline">
          月次PL
        </Link>
      </li>
      <li>
        <Link href="/pl/products" className="text-blue-600 hover:underline">
          商品別PL
        </Link>
      </li>
    </ul>
  </div>

  {/* 広告費管理 */}
  <div className="bg-white rounded-lg shadow p-6">
    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
      <span>📢</span>
      <span>広告費管理</span>
    </h3>
    <Link href="/ad-expenses" className="text-blue-600 hover:underline">
      広告費管理
    </Link>
  </div>

  {/* 設定カテゴリ */}
  <div className="bg-white rounded-lg shadow p-6">
    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
      <span>⚙️</span>
      <span>設定</span>
    </h3>
    <ul className="space-y-2">
      <li>
        <Link href="/settings/sales-channels" className="text-blue-600 hover:underline">
          販路マスタ
        </Link>
      </li>
      <li>
        <Link href="/settings/tax-rates" className="text-blue-600 hover:underline">
          税率設定
        </Link>
      </li>
      <li>
        <Link href="/settings/account" className="text-blue-600 hover:underline">
          アカウント設定
        </Link>
      </li>
      {isMaster && (
        <>
          <li>
            <Link href="/settings/users" className="text-blue-600 hover:underline">
              ユーザー管理
            </Link>
          </li>
          <li>
            <Link href="/settings/export" className="text-blue-600 hover:underline">
              データエクスポート
            </Link>
          </li>
          <li>
            <Link href="/settings/restore" className="text-blue-600 hover:underline">
              データ復元
            </Link>
          </li>
        </>
      )}
    </ul>
  </div>
</div>
```

#### 1-3-4. 修正ファイル
- `src/app/page.tsx` (大幅修正)

---

### 1-4. 取込履歴の削除ボタン表示確認

#### 1-4-1. 概要
ユーザー報告により、本番環境で削除ボタンが表示されていない問題を確認・修正。

#### 1-4-2. 現状確認

**実装状況**:
- API: DELETE メソッド実装済み
- フロントエンド: 削除ボタン実装済み（206-211行目）
- 権限制御: `isMaster &&` で条件表示

**コード**:
```tsx
<td className="px-4 py-3 text-center">
  {isMaster && (
    <div className="flex justify-center gap-2">
      <button onClick={() => openEditModal(h)}>
        販路変更
      </button>
      <button onClick={() => handleDelete(h)}>
        削除
      </button>
    </div>
  )}
</td>
```

#### 1-4-3. 問題の可能性

**可能性1: 権限の問題**
- ユーザーがスタッフ権限でログインしている
- 要件: マスター権限のみ削除可能

**可能性2: デプロイの問題**
- ローカルには実装されているが、本番環境にデプロイされていない
- ビルド・デプロイプロセスの確認が必要

#### 1-4-4. 対応方針

**Step 1: 権限確認**
1. ユーザーのログイン権限を確認
2. マスター権限でログインして削除ボタンが表示されるか確認

**Step 2: デプロイ確認**
1. 本番環境のコードバージョンを確認
2. 必要に応じて再ビルド・再デプロイ

**Step 3: 必要に応じた修正**
- 権限ロジックの見直し（要件確認後）
- または、デプロイ手順の見直し

#### 1-4-5. 修正ファイル
- なし（確認作業のみ、必要に応じて再デプロイ）

---

## 🔧 Phase 2: 仕様適合の詳細設計

### 2-1. 広告費管理画面のタブ統合

#### 2-1-1. 概要
V1.3要件「タブ1: 広告費一覧、タブ2: カテゴリ管理」に準拠し、単一画面を2タブ構成に変更。

#### 2-1-2. タブUI設計

**画面**: `/ad-expenses`

**タブ構成**:
- **タブ1**: 広告費一覧（現状の画面 + Phase 1-2の編集・削除機能）
- **タブ2**: カテゴリ管理（`/settings/ad-categories` の内容を移植）

**HTML構造**:
```tsx
export default function AdExpensesPage() {
  const [activeTab, setActiveTab] = useState<'expenses' | 'categories'>('expenses');

  return (
    <div>
      {/* ヘッダー */}
      <header className="bg-white border-b px-6 py-3">
        <h1 className="text-xl font-semibold">広告費管理</h1>
      </header>

      {/* タブナビゲーション */}
      <div className="bg-white border-b">
        <div className="max-w-6xl mx-auto px-6">
          <div className="flex gap-4">
            <button
              onClick={() => setActiveTab('expenses')}
              className={`px-4 py-3 border-b-2 ${
                activeTab === 'expenses'
                  ? 'border-blue-600 text-blue-600 font-medium'
                  : 'border-transparent text-gray-600 hover:text-gray-900'
              }`}
            >
              広告費一覧
            </button>
            <button
              onClick={() => setActiveTab('categories')}
              className={`px-4 py-3 border-b-2 ${
                activeTab === 'categories'
                  ? 'border-blue-600 text-blue-600 font-medium'
                  : 'border-transparent text-gray-600 hover:text-gray-900'
              }`}
            >
              カテゴリ管理
            </button>
          </div>
        </div>
      </div>

      {/* タブコンテンツ */}
      <main className="max-w-6xl mx-auto px-6 py-8">
        {activeTab === 'expenses' ? (
          <ExpensesTab />
        ) : (
          <CategoriesTab />
        )}
      </main>
    </div>
  );
}
```

#### 2-1-3. タブ1: 広告費一覧

**コンポーネント**: `ExpensesTab`

**内容**: Phase 1-2で実装した編集・削除機能を含む広告費一覧

#### 2-1-4. タブ2: カテゴリ管理

**コンポーネント**: `CategoriesTab`

**内容**: `/settings/ad-categories` の内容を移植
- カテゴリ一覧テーブル
- 新規カテゴリ追加フォーム
- インライン編集機能
- 有効/無効トグル

#### 2-1-5. 旧画面の削除

**対応**: `/settings/ad-categories` を削除またはリダイレクト

**リダイレクト実装**:
```tsx
// src/app/settings/ad-categories/page.tsx
'use client';
import { useEffect } from 'react';
import { useRouter } from 'next/navigation';

export default function RedirectPage() {
  const router = useRouter();
  
  useEffect(() => {
    router.replace('/ad-expenses?tab=categories');
  }, [router]);
  
  return <div>リダイレクト中...</div>;
}
```

#### 2-1-6. 修正ファイル
- `src/app/ad-expenses/page.tsx` (大幅修正)
- `src/app/settings/ad-categories/page.tsx` (削除またはリダイレクト化)

---

## 💾 Phase 3: データ整合性の詳細設計

### 3-1. seed.jsの初期データ反映

#### 3-1-1. 概要
`seed.js` に定義されている初期データを本番DBに反映する。

#### 3-1-2. package.json設定

**確認項目**: `prisma.seed` の定義

```json
{
  "name": "rinori-sales-system",
  "prisma": {
    "seed": "node prisma/seed.js"
  }
}
```

**未定義の場合**: 上記を追加

#### 3-1-3. 実行コマンド

```bash
npx prisma db seed
```

**実行タイミング**:
1. 開発環境: 実装完了後
2. 本番環境: デプロイ後（初回のみ）

#### 3-1-4. 反映確認

**販路マスタ**:
```sql
SELECT * FROM sales_channels;
```
期待結果: 5件（EC, モール, 卸, 催事ポップアップ, その他）

**広告費カテゴリ**:
```sql
SELECT * FROM ad_categories;
```
期待結果: 4件（Meta広告, Google広告, アフィリエイト, その他）

**ユーザー**:
```sql
SELECT username, role FROM users;
```
期待結果: admin (master), staff (staff)

#### 3-1-5. upsert処理の確認

**seed.jsの実装**:
```javascript
// 販路マスタ
const defaultSalesChannels = ['EC', 'モール', '卸', '催事ポップアップ', 'その他'];
for (const name of defaultSalesChannels) {
    await prisma.salesChannel.upsert({
        where: { name },
        update: { isActive: true },
        create: { name, isActive: true },
    });
}

// 広告費カテゴリ
const defaultAdCategories = ['Meta広告', 'Google広告', 'アフィリエイト', 'その他'];
for (const categoryName of defaultAdCategories) {
    await prisma.adCategory.findFirst({ where: { categoryName } }).then(async (existing) => {
        if (!existing) {
            await prisma.adCategory.create({
                data: { categoryName, isActive: true },
            });
        }
    });
}
```

**特徴**:
- `upsert` を使用しているため、既存データがあれば更新、なければ作成
- 重複登録は発生しない

---

## 📋 実装チェックリスト

### Phase 1: 緊急対応
- [ ] 1-1. CSV様式ダウンロード機能
  - [ ] `public/templates/sales_template.csv` 作成（Shift-JIS）
  - [ ] `/import/sales` にダウンロードボタン追加
  - [ ] 取込履歴へのリンク追加
- [ ] 1-2. 広告費の編集・削除機能
  - [ ] API: PUT エンドポイント追加
  - [ ] API: DELETE エンドポイント追加
  - [ ] フロントエンド: インライン編集UI実装
  - [ ] フロントエンド: 削除ボタン実装
- [ ] 1-3. ダッシュボードメニュー再構成
  - [ ] カテゴリ構造の実装
  - [ ] 取込履歴リンク追加
  - [ ] 販路マスタリンク追加
- [ ] 1-4. 取込履歴の削除ボタン表示確認
  - [ ] 権限確認
  - [ ] デプロイ確認
  - [ ] 必要に応じて再デプロイ

### Phase 2: 仕様適合
- [ ] 2-1. 広告費管理のタブ統合
  - [ ] タブUI実装
  - [ ] タブ1: 広告費一覧
  - [ ] タブ2: カテゴリ管理
  - [ ] 旧画面の削除またはリダイレクト

### Phase 3: データ整合性
- [ ] 3-1. seed.js反映
  - [ ] package.json確認・修正
  - [ ] `npx prisma db seed` 実行
  - [ ] データ反映確認（販路5件、カテゴリ4件）

---

## 🧪 テスト計画

### 単体テスト

#### CSV様式ダウンロード
- [ ] ダウンロードボタンが表示される
- [ ] クリックでCSVがダウンロードされる
- [ ] ダウンロードしたCSVがShift-JISである
- [ ] CSV内容が正しい（列ヘッダー、サンプル行）

#### 広告費編集・削除
- [ ] 編集ボタンでインライン編集モードになる
- [ ] 編集内容を保存できる
- [ ] キャンセルで元に戻る
- [ ] 削除ボタンで確認ダイアログが表示される
- [ ] 削除実行でデータが削除される

#### ダッシュボードメニュー
- [ ] カテゴリ構造が表示される
- [ ] 各リンクが正しく遷移する
- [ ] マスター権限のみのリンクが制御される

#### タブ統合
- [ ] タブ切り替えが動作する
- [ ] タブ1で広告費一覧が表示される
- [ ] タブ2でカテゴリ管理が表示される
- [ ] 旧画面がリダイレクトされる

### 統合テスト

#### シナリオ1: CSV取込フロー
1. ダッシュボード → 売上CSV取込
2. CSV様式ダウンロード
3. 手動でCSV作成
4. CSV取込実行
5. 取込履歴で確認
6. 必要に応じて販路変更または削除

#### シナリオ2: 広告費管理フロー
1. ダッシュボード → 広告費管理
2. タブ2でカテゴリ追加
3. タブ1で広告費登録
4. 登録した広告費を編集
5. 不要な広告費を削除

---

## 📌 注意事項

### 破壊的変更
- `/settings/ad-categories` の削除（ブックマーク無効化）
- 広告費管理画面のUI変更（タブ化）
- ダッシュボードのメニュー構造変更

### データ影響
- seed.js実行による初期データ追加（既存データには影響なし）
- upsertのため、既存データは更新される

### 後方互換性
- API エンドポイントは変更なし（追加のみ）
- データベーススキーマ変更なし

---

以上
