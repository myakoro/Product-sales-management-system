# Rinori 売上管理システム V1.58 詳細設計 差分案

## 1. 概要
V1.58では、経営目標のトップダウン管理（管理売上予算）の導入と、カテゴリー別PL分析のさらなる視認性向上（粗利構成比・円グラフ）を実施する。

## 2. データベース設計 (SC-18)

### 2-1. モデルの追加 (`prisma/schema.prisma`)
- `ManagementBudget` モデルを追加し、年月単位の目標売上を管理する。
```prisma
// 管理売上予算マスタ
model ManagementBudget {
  periodYm    String   @id @map("period_ym") // YYYY-MM
  amount      Float    @default(0)           // 目標売上（税別）
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("management_budgets")
}
```

## 3. 管理売上予算設定 (SC-18)

### 3-1. API (`/api/settings/management-budget/route.ts`)
- **GET**: 範囲指定された `periodYm` の管理売上予算を取得。
- **POST**: 指定された年月の管理売上予算を保存（Upsert）。
  - **税区分**: 金額は一貫して「税別」として扱う。
  - **権限制限**: `master` 権限ユーザーのみ実行可能。

### 3-2. フロントエンドの入力インターフェース

#### A. 商品予算画面からの「クイック入力」
- **UI**: ヘッダーの目標金額表示をクリックして表示されるモーダル。
- **案分ロジック**: 
  - 入力された合計額を表示月数で均等割し、**整数（円単位）**で保存。
  - 除算の余り（端数）は表示期間の最終月に加算して整合性を保つ。

#### B. 専用設定ページ（階層的入力）
- **パス**: `/app/settings/management-budget/page.tsx`
- **UI構成**: 
  - 年度セレクター、年度全体合計、四半期合計(Q1-Q4)、各月(1-12)の入力欄。
- **連動ロジック**:
  - 年度/四半期入力時：月別へ自動案分（端数最終月寄せ）。
  - 月別入力時：上位の四半期/年度合計値をリアルタイムに合算。

## 4. 商品予算設定の機能拡張 (SC-09)

### 4-1. フロントエンド (`/app/budget/page.tsx`)
- **目標比較表示 (Company Level Visualization)**:
  - ヘッダー部分に、**フィルタの影響を受けない「会社全体」の比較エリア**を設ける。
  - **管理売上予算 (目標)**: 指定期間内の目標合計。
  - **全社商品計画 (計画)**: 指定期間内の全商品の予算合計（フィルタ非連動）。
  - **乖離額 (不足)**: `目標 - 計画`。
- **目的**: 
  - ユーザーが「個別商品の調整」をしている最中でも、常に「会社全体としてあといくら足りないか」を視界に入れるため。

## 5. カテゴリー別PL分析 (SC-13) の強化

### 5-1. フロントエンド (`/app/pl/page.tsx`)
- **集計ロジック**:
  - 各カテゴリーの売上・粗利益の構成比(%)を算出（小数点第1位）。
- **円グラフ (PieChart)**:
  - **構成**:
    - ユーザーが選択したカテゴリー（最大5件）。
    - **その他 (Others)**: 「全社合計」から「選択5件の合計」を引いた全ての値（未選択カテゴリーおよび未分類商品を含む）。
  - **表示切替**: ツールバーで「売上構成 / 粗利構成」を即座にスイッチ。
  - **赤字対応**: 粗利益がマイナスのカテゴリーはグラフ描画から除外し、凡例等でその旨を注釈表示。

---

## 6. セキュリティ・権限
- `master` 権限：全ての設定および表示。
- `staff` 権限：損益・予算の閲覧はできるが、管理売上予算マスタの編集は不可。

---

**作成日**: 2026-02-03  
**対象バージョン**: V1.58  
**前提バージョン**: V1.57
