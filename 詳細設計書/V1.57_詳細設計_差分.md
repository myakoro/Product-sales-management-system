# Rinori 売上管理システム V1.57 詳細設計 差分案

## 1. 概要
V1.57では、NE同期期間の拡大、カテゴリーPLの分析性向上、商品マスタのバグ修正、および予算管理画面のユーザビリティ向上を実施する。

## 2. ネクストエンジン連携 (SC-14) の拡張

### 2-1. フロントエンド (`/settings/nextengine/page.tsx`)
- `generateMonthOptions` 関数を修正し、過去25ヶ月分（当月 ＋ 過去24ヶ月）を生成するように変更。
  - 基準日を2024年1月（現在2026年1月の場合）とし、それ以前は選択不可とする。
  - ソート順は「新しい順（降順）」を維持。

### 2-2. バックエンド (`/api/nextengine/sync/route.ts`)
- 既存のロジックは単月指定であるため、フロントエンドからの `targetYm` をそのまま処理する。
- 同期範囲が広がることによる、NE側APIの取得制限（ウェイト処理）は既存の `nextEngineClient` に任せる。

## 3. カテゴリー別PL分析 (SC-13) の強化

### 3-1. フロントエンド (`/app/pl/page.tsx`)
- **集計ロジック**:
  - 指定された期間・販路フィルタ適用後の、全カテゴリー（未分類含む）の合計売上高 (`totalPeriodSales`) を算出する。
- **UI表示**:
  - カテゴリー別一覧テーブルの売上高列に構成比を追加: `¥1,234,567 (12%)`
  - 構成比 = `(当該カテゴリー売上 / totalPeriodSales) * 100` (整数丸め)
- **グラフツールチップ**:
  - Rechartsの `Tooltip` カスタムコンポーネントを修正し、売上高の項目に構成比を併記。

## 4. 商品マスタ管理 (SC-01/03) のバグ修正

### 4-1. フロントエンド (`/app/products/page.tsx`)
- カテゴリーフィルタの `select` 要素内 `option` の描画ロジックを修正。
- 誤: `cat.categoryName` → 正: `cat.name` (APIレスポンスのフィールド名に合わせる)

## 5. 商品予算設定 (SC-09) の拡張

### 5-1. API (`/api/budget/route.ts`)
- `GET` メソッドにおいて、`Product` 取得時に `category` を `include` する。
- レスポンスに `categoryId` および `categoryName` を含める。

### 5-2. フロントエンド (`/app/budget/page.tsx`)
- **テーブル構成**:
  - 「商品名」の右側に「カテゴリー」列を追加。
- **ソート機能**:
  - `SortKey` に `categoryName` を追加し、ヘッダークリックでソート可能にする。
  - 合計売上高、合計粗利、平均粗利率をリアルタイムに再計算するように修正。
  - **平均粗利率の計算**: `(filteredDataの合計粗利 / filteredDataの合計売上) * 100` による加重平均。

## 6. 商品予算 vs 商品実績 (SC-11) の項目追加

### 6-1. API (`/api/budget/vs-actual/route.ts`)
- レスポンスの `productResults` に以下の項目を追加計算して含める:
  - `budgetGrossProfitRate`: `(budgetGrossProfit / budgetSales) * 100`
  - `actualGrossProfitRate`: `(actualGrossProfit / actualSales) * 100`
- `summary` にも同様の全体平均項目を追加。

### 6-2. フロントエンド (`/app/budget/vs-actual/page.tsx`)
- 商品別一覧テーブルに「粗利率」列を追加。
- 商品ごとに「予算粗利率」と「実績粗利率」を並記する。
- 表示形式: `35.2%` (小数点第1位)

---

## 7. データベース変更
- **変更なし** (既存のカラムおよびリレーションを使用)

---

**作成日**: 2026-01-09  
**対象バージョン**: V1.57  
**前提バージョン**: V1.56
