# Rinori 売上管理システム V1.55 詳細設計 差分案

## 1. データベース設計 (Prisma)

### 1-1. ProductCategory テーブル (新規)
商品カテゴリーのマスタ情報を管理。

```prisma
model ProductCategory {
  id          Int       @id @default(autoincrement())
  name        String    // カテゴリー名（例: 「フリーズドライ」「調味料」）
  displayOrder Int      @default(0) @map("display_order") // 表示順序
  isActive    Boolean   @default(true) @map("is_active") // 有効/無効
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // リレーション
  products    Product[]
  
  @@map("product_categories")
}
```

### 1-2. Product テーブル (既存拡張)
商品マスタにカテゴリーIDを追加。

```prisma
model Product {
  // ...既存フィールド
  categoryId  Int?      @map("category_id") // カテゴリーID（NULL許容）
  
  // リレーション
  category    ProductCategory? @relation(fields: [categoryId], references: [id])
}
```

**変更内容**:
- `categoryId`: カテゴリーIDを追加（NULL許容、未分類商品を許容）
- `category`: ProductCategoryテーブルとのリレーション

---

## 2. API設計

### 2-1. カテゴリーマスタ管理API

#### POST `/api/categories`
カテゴリーを新規作成。

**リクエストボディ**:
```json
{
  "name": "フリーズドライ",
  "displayOrder": 1,
  "isActive": true
}
```

**レスポンス**:
```json
{
  "id": 1,
  "name": "フリーズドライ",
  "displayOrder": 1,
  "isActive": true,
  "createdAt": "2026-01-07T14:00:00Z",
  "updatedAt": "2026-01-07T14:00:00Z"
}
```

**バリデーション**:
- `name`: 必須、1〜50文字
- `displayOrder`: 0以上の整数
- `isActive`: boolean

**権限**: マスター権限のみ

---

#### GET `/api/categories`
カテゴリー一覧を取得。

**クエリパラメータ**:
- `includeInactive`: `true` の場合、無効なカテゴリーも含める（デフォルト: `false`）

**レスポンス**:
```json
[
  {
    "id": 1,
    "name": "フリーズドライ",
    "displayOrder": 1,
    "isActive": true,
    "productCount": 15 // 所属商品数
  },
  {
    "id": 2,
    "name": "調味料",
    "displayOrder": 2,
    "isActive": true,
    "productCount": 8
  }
]
```

**ソート**: `displayOrder` 昇順

---

#### PUT `/api/categories/:id`
カテゴリーを更新。

**リクエストボディ**:
```json
{
  "name": "フリーズドライ商品",
  "displayOrder": 1,
  "isActive": true
}
```

**レスポンス**: 更新後のカテゴリー情報

**権限**: マスター権限のみ

---

#### DELETE `/api/categories/:id`
カテゴリーを削除。

**処理内容**:
1. カテゴリーに紐付いている商品の `categoryId` を `NULL` に設定（未分類に移行）
2. カテゴリーを削除

**レスポンス**:
```json
{
  "message": "カテゴリーを削除しました",
  "affectedProducts": 15 // 未分類に移行した商品数
}
```

**権限**: マスター権限のみ

---

### 2-2. 商品のカテゴリー紐付けAPI

#### POST `/api/categories/:id/products`
カテゴリーに商品を一括で紐付け。

**リクエストボディ**:
```json
{
  "productIds": [1, 2, 3, 4, 5] // 紐付ける商品IDの配列
}
```

**処理内容**:
1. 指定された商品の `categoryId` を更新
2. 既に他のカテゴリーに所属している場合は上書き（1商品1カテゴリー）

**レスポンス**:
```json
{
  "message": "5件の商品をカテゴリーに追加しました",
  "categoryId": 1,
  "addedProductIds": [1, 2, 3, 4, 5]
}
```

**権限**: マスター権限のみ

---

#### DELETE `/api/categories/:id/products`
カテゴリーから商品を一括で削除（未分類に移行）。

**リクエストボディ**:
```json
{
  "productIds": [1, 2, 3] // 削除する商品IDの配列
}
```

**処理内容**:
1. 指定された商品の `categoryId` を `NULL` に設定

**レスポンス**:
```json
{
  "message": "3件の商品をカテゴリーから削除しました",
  "removedProductIds": [1, 2, 3]
}
```

**権限**: マスター権限のみ

---


### 2-4. 商品一覧取得API（既存APIの拡張）

#### GET `/api/products`
商品一覧を取得。カテゴリー管理画面で使用。

**クエリパラメータ**:
- `categoryId`: カテゴリーID（指定した場合、そのカテゴリーの所属商品のみ取得）
  - `categoryId=null`: 未所属商品のみ取得
  - 省略: 全商品を取得

**レスポンス**:
```json
[
  {
    "id": 1,
    "productCode": "RINO-FR010",
    "productName": "フリーズドライ味噌汁",
    "categoryId": 1,
    "categoryName": "フリーズドライ"
  },
  {
    "id": 2,
    "productCode": "RINO-SE010",
    "productName": "調味料セット",
    "categoryId": null,
    "categoryName": null
  }
]
```

**ソート**: `productCode` 昇順

---
### 2-3. カテゴリー別PL分析API

#### GET `/api/pl/category`
カテゴリー別のPL分析データを取得。

**クエリパラメータ**:
- `targetYm`: 対象年月（YYYY-MM形式、必須）
- `sortBy`: ソート項目（`sales`, `grossProfit`, `grossProfitRate`、デフォルト: `sales`）
- `sortOrder`: ソート順（`asc`, `desc`、デフォルト: `desc`）

**レスポンス**:
```json
[
  {
    "categoryId": 1,
    "categoryName": "フリーズドライ",
    "sales": 1500000, // 売上高（税抜）
    "cogs": 900000, // 売上原価
    "grossProfit": 600000, // 粗利
    "grossProfitRate": 40.0 // 粗利率（%）
  },
  {
    "categoryId": 2,
    "categoryName": "調味料",
    "sales": 800000,
    "cogs": 480000,
    "grossProfit": 320000,
    "grossProfitRate": 40.0
  },
  {
    "categoryId": null,
    "categoryName": "未分類",
    "sales": 200000,
    "cogs": 120000,
    "grossProfit": 80000,
    "grossProfitRate": 40.0
  }
]
```

**集計ロジック**:
1. 指定月の `SalesRecord` を取得
2. 商品の `categoryId` でグループ化
3. カテゴリーごとに売上高、売上原価、粗利、粗利率を計算
4. `categoryId` が `NULL` の商品は「未分類」として集計

**ソート**: デフォルトは `sales` 降順（クエリパラメータで変更可能）

---

## 3. UI設計

### 3-1. カテゴリー管理画面 (新規)

**画面パス**: `/settings/categories`

**レイアウト**:
```
┌─────────────────────────────────────────────────────┐
│ カテゴリー管理                                      │
├─────────────────────────────────────────────────────┤
│ [+ 新規カテゴリー作成]                              │
├──────────────────┬──────────────────────────────────┤
│ カテゴリー一覧   │ 選択中のカテゴリー: フリーズドライ│
│                  │                                  │
│ ☑ フリーズドライ │ 所属商品 (15件)                  │
│ ☐ 調味料         │ ┌────────────────────────────┐ │
│ ☐ ギフトセット   │ │ ☑ RINO-FR010 フリーズドライ味噌汁│ │
│ ☐ 季節商品       │ │ ☑ RINO-FR020 フリーズドライスープ│ │
│                  │ │ ...                          │ │
│ [表示順序変更]   │ └────────────────────────────┘ │
│                  │ [選択を解除]                     │
│                  │                                  │
│                  │ 未所属商品 (8件)                 │
│                  │ ┌────────────────────────────┐ │
│                  │ │ ☐ RINO-SE010 調味料セット    │ │
│                  │ │ ☐ RINO-GF010 ギフトボックス  │ │
│                  │ │ ...                          │ │
│                  │ └────────────────────────────┘ │
│                  │ [選択した商品を追加]             │
└──────────────────┴──────────────────────────────────┘
```

**操作フロー**:
1. 左側のカテゴリー一覧からカテゴリーを選択
2. 右側に「所属商品」と「未所属商品」が表示される
3. 未所属商品をチェックボックスで複数選択
4. 「選択した商品を追加」ボタンで一括登録
5. 所属商品をチェックボックスで選択し、「選択を解除」ボタンで削除

**新規カテゴリー作成**:
- モーダルダイアログで「カテゴリー名」「表示順序」を入力
- 「作成」ボタンで登録

**カテゴリー編集**:
- カテゴリー名の右側に「編集」「削除」ボタン
- 編集: モーダルダイアログで名前・表示順序・有効/無効を変更
- 削除: 確認ダイアログ表示後、削除（所属商品は未分類に移行）

---

### 3-2. PL分析画面の拡張 (既存画面の修正)

**画面パス**: `/pl`

**タブ構成**:
```
┌─────────────────────────────────────────────────────┐
│ PL分析 (月次・期間)                                 │
├─────────────────────────────────────────────────────┤
│ [全体PL] [商品別PL] [カテゴリー別PL] ← 新規タブ追加│
├─────────────────────────────────────────────────────┤
│ 対象期間: [2025年12月 ▼] ← デフォルト: 先月        │
├─────────────────────────────────────────────────────┤
│ カテゴリー別PL                                      │
│ ┌───────────────────────────────────────────────┐ │
│ │カテゴリー名  │売上高    │粗利      │粗利率   ││
│ ├───────────────────────────────────────────────┤ │
│ │フリーズドライ│¥1,500,000│¥600,000  │40.0%    ││
│ │調味料        │¥800,000  │¥320,000  │40.0%    ││
│ │ギフトセット  │¥500,000  │¥200,000  │40.0%    ││
│ │未分類        │¥200,000  │¥80,000   │40.0%    ││
│ └───────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

**期間デフォルト値の変更**:
- 画面を開いた際、期間選択のデフォルト値を「先月（前月）」に設定
- 実装: `useEffect` で初期値を `dayjs().subtract(1, 'month').format('YYYY-MM')` に設定

---

## 4. フロントエンド実装詳細

### 4-1. カテゴリー管理画面のState管理

```typescript
// カテゴリー管理画面の状態
interface CategoryManagementState {
  categories: Category[]; // カテゴリー一覧
  selectedCategoryId: number | null; // 選択中のカテゴリーID
  categoryProducts: Product[]; // 選択中のカテゴリーの所属商品
  unassignedProducts: Product[]; // 未所属商品
  selectedProductIds: number[]; // チェックボックスで選択中の商品ID
}
```

**データ取得フロー**:
1. 画面表示時: `GET /api/categories` でカテゴリー一覧を取得
2. カテゴリー選択時: `GET /api/products?categoryId={id}` で所属商品を取得
3. 同時に `GET /api/products?categoryId=null` で未所属商品を取得

**商品追加フロー**:
1. 未所属商品をチェックボックスで選択
2. 「選択した商品を追加」ボタンをクリック
3. `POST /api/categories/{id}/products` で一括登録
4. 成功後、所属商品と未所属商品のリストを再取得

---

### 4-2. PL分析画面の期間デフォルト値

```typescript
// PL分析画面の初期化
useEffect(() => {
  // 先月をデフォルト値に設定
  const lastMonth = dayjs().subtract(1, 'month').format('YYYY-MM');
  setTargetYm(lastMonth);
  
  // PLデータを取得
  fetchPLData(lastMonth);
}, []);
```

---

## 5. バリデーション・エラーハンドリング

### 5-1. カテゴリー名のバリデーション
- **必須チェック**: カテゴリー名が空の場合はエラー
- **文字数制限**: 1〜50文字
- **重複チェック**: 同名のカテゴリーが既に存在する場合はエラー

### 5-2. カテゴリー削除時の確認
- 削除確認ダイアログで、所属商品数を表示
- 例: 「このカテゴリーには15件の商品が所属しています。削除すると、これらの商品は未分類になります。よろしいですか？」

### 5-3. 商品の一括紐付け時のエラー
- 商品IDが存在しない場合: エラーメッセージを表示
- 権限がない場合: 403エラー

---

## 6. パフォーマンス最適化

### 6-1. カテゴリー一覧の取得
- カテゴリー数が少ない（〜100件程度）ため、ページネーション不要
- 所属商品数は `COUNT` クエリで効率的に取得

### 6-2. 商品一覧の取得
- 未所属商品が多い場合（100件以上）は、検索機能を追加（オプション）
- 初期表示時は最大100件まで表示

---

## 7. セキュリティ

### 7-1. 権限制御
- カテゴリーマスタの作成・編集・削除: マスター権限のみ
- カテゴリー別PL分析: 全ユーザー閲覧可能

### 7-2. SQLインジェクション対策
- Prisma ORMを使用し、パラメータ化クエリで実装

---

## 8. マイグレーション

### 8-1. データベースマイグレーション

```bash
# Prismaマイグレーション実行
npx prisma migrate dev --name add_product_categories
```

**マイグレーション内容**:
1. `product_categories` テーブルを作成
2. `products` テーブルに `category_id` カラムを追加
3. 外部キー制約を設定

### 8-2. 既存データの扱い
- 既存の商品は `categoryId` が `NULL`（未分類）として扱う
- ユーザーが段階的にカテゴリー設定を行う運用を想定

---

**作成日**: 2026-01-07  
**対象バージョン**: V1.55  
**前提バージョン**: V1.54（Next Engine API連携完了）
