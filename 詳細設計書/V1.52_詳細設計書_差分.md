# Rinori 売上管理システム V1.52 詳細設計書（差分）

## 1. 概要
本バージョン(v1.52)は、運用上のユーザビリティ改善とデータの精度向上を目的とする。
特に、不要な売上データの取り込み防止機能と、画面遷移・ナビゲーションの強化に重点を置く。

## 2. データベース設計

### 2-1. 新規テーブル: `ExclusionKeyword`
売上取込時に除外する商品コードのルールを管理する。

```prisma
model ExclusionKeyword {
  id        Int      @id @default(autoincrement())
  keyword   String   // 除外対象の文字列 (例: "RINO-FR014-B", "SAMPLE")
  matchType String   // "startsWith" (前方一致) or "includes" (部分一致)
  createdAt DateTime @default(now())
}
```

### 2-2. 既存テーブル変更
なし

## 3. 機能詳細設計

### 3-1. 売上取込時の特定商品コード除外機能
**画面**: `/settings/exclusion-keywords` (新規), `/import/sales` (改修)
**API**: `/api/settings/exclusion-keywords`, `/api/import/sales`

1.  **設定画面**:
    *   キーワードの追加・一覧表示・削除機能を提供。
    *   一致タイプ (`matchType`) を選択可能。

2.  **取込ロジック (`/api/import/sales`)**:
    *   CSVパース直後、SKU正規化やマスタ参照の**前**にフィルタリングを実行。
    *   `ExclusionKeyword` テーブルの全レコードを取得し、各行の識別子（NE: 商品コード, Amazon: ASIN）と比較。
    *   一致したレコードは処理対象から除外し、`excludedCount` として集計結果に含める。
    *   エラーとしては扱わず、正常なスキップとして処理する。

### 3-2. 期間選択ナビゲーション (共通コンポーネント)
**コンポーネント**: `src/components/DateNavigator.tsx`, `src/components/PeriodNavigator.tsx`

1.  **単月選択 (`DateNavigator`)**:
    *   `<` (前月) / `YYYY-MM` (ピッカー) / `>` (翌月) の構成。
    *   ピッカー変更時、およびボタン押下時に即座に `onChange` イベントを発火。

2.  **期間選択 (`PeriodNavigator`)**:
    *   `<` (前の期間) / `YYYY-MM` ~ `YYYY-MM` / `>` (次の期間) の構成。
    *   ボタン押下時は、開始月・終了月をそれぞれ **1ヶ月分** 前後させる。

### 3-3. 商品別PL ソート・導線改善
**画面**: `/pl/products`

1.  **デフォルトソートロジック**:
    *   以下の優先順位キー (`priorityKey`) を付与してソート。
        1. `RINO-FR`... (Priority: 1)
        2. `RINO-BG`... (Priority: 2)
        3. `RINO-SY`... (Priority: 3)
        4. その他 (Priority: 99)
    *   同Priority内は商品コード昇順。

2.  **PL分析からの導線**:
    *   PL分析画面で選択中の「期間 (`startYm`, `endYm`)」と「販路 (`salesChannelId`)」をクエリパラメータとして引き継ぎ遷移する。

### 3-4. 無視リスト参照・復活機能
**画面**: `/products/candidates`
**API**: `/api/products/candidates`

1.  **UI**:
    *   「未登録 (pending)」タブと「無視リスト (ignored)」タブを実装。
    *   タブ切り替え時に API へ `status` パラメータを送信して再取得。

2.  **API**:
    *   `GET /api/products/candidates?status=xxx`: 指定されたステータスの候補を返却。
    *   `PATCH /api/products/candidates/[id]`: ステータス更新 (`pending` ↔ `ignored`)。

### 3-5. 広告費登録 デフォルト日付
**画面**: `/ad-expenses`

1.  **初期値ロジック**:
    *   画面表示（月選択）されている月が「現在の月」と同じ場合 → **今日の日付 (`today`)** をセット。
    *   それ以外の月の場合 → 月初 (`YYYY-MM-01`) をセット。

### 3-6. メニュー名称変更
1.  **対象**: サイドバー、各画面タイトル、ダッシュボードリンク。
2.  **変更**: 「予算vs実績」→「**商品予算vs商品実績**」。

### 3-7. 商品別PL分析 (SC-13) 改善
1.  **期間ナビゲーション**:
    *   `PeriodNavigator` を画面上部に配置。
    *   他のPL画面と同様の「1ヶ月スライド」機能を有効にする。

### 3-8. 商品予算vs商品実績(SC-11) デフォルト設定
- `useState` の初期値において、`startYm` および `endYm` を実行日の「前月」に設定する。

### 3-9. 設定メニュー構成 (v1.53先行実装)
**画面**: `/settings`, 共通ヘッダー

1.  **ヘッダー**:
    *   「設定」リンクを追加。

2.  **設定インデックス画面 (`/settings`)**:
    *   以下の構成でリンクを集約。
        *   **一般**: アカウント設定
        *   **マスター管理**: 販路マスタ、広告カテゴリー、除外キーワード設定
        *   **システム管理 (Masterのみ)**: ユーザー管理、税率設定、データエクスポート/復元

## 4. API インターフェース変更一覧

| メソッド | エンドポイント | 変更概要 |
| :--- | :--- | :--- |
| `POST` | `/api/import/sales` | 除外キーワード判定ロジックの追加、レスポンスに `excludedCount` 追加 |
| `GET` | `/api/settings/exclusion-keywords` | (新規) 除外キーワード一覧取得 |
| `POST` | `/api/settings/exclusion-keywords` | (新規) 除外キーワード作成 |
| `DELETE` | `/api/settings/exclusion-keywords/[id]` | (新規) 除外キーワード削除 |
| `GET` | `/api/products/candidates` | `status` クエリパラメータ対応 (デフォルト: `pending`) |
| `PATCH` | `/api/products/candidates/[id]` | `status` 更新対応 (`ignored` ↔ `pending`) |
