# Rinori 売上管理システム V1.56 詳細設計 差分案

## 1. 概要
V1.56では、V1.55までのデータを視覚的に分析するためのグラフ機能を追加する。
主に「予算vs実績」と「PL推移」の2つの主要画面にグラフエリアを導入し、経営判断をサポートする。

## 2. グラフライブラリ
- **ライブラリ**: `Recharts`
- **選定理由**: React専用設計でレスポンシブ対応が容易であり、カスタマイズ性が高くダークモードとの親和性も良いため。

## 3. API設計

### 3-1. PL推移グラフAPI
カテゴリー別・商品別・全体のPL推移データを取得する。

#### GET `/api/charts/pl-trend`
**クエリパラメータ**:
- `startYm`: 開始年月 (YYYY-MM)
- `endYm`: 終了年月 (YYYY-MM)
- `type`: 集計単位 (`overall` | `product` | `category`)
- `ids`: 商品コードまたはカテゴリーIDのカンマ区切り（`overall`以外で必須）
- `salesChannelId`: 販路ID (任意)

**レスポンス**:
```json
[
  {
    "periodYm": "2025-12",
    "data": [
      {
        "id": "item1", // またはカテゴリーID/名称
        "name": "商品A",
        "sales": 100000,
        "salesPrevYear": 95000,
        "grossProfit": 40000,
        "grossProfitPrevYear": 38000,
        "sga": 10000, // type=overall かつ salesChannelId=未指定 の時のみ算出
        "operatingProfit": 30000, // salesChannelId指定時はnull
        "operatingProfitPrevYear": 28000,
        "grossProfitRate": 40.0
      }
    ]
  }
]
```

**補足**: `AdExpense` には販路情報がないため、特定販路フィルタ適用時の営業利益は「算出不可(null)」として扱い、グラフ上では非表示とする。
---

### 3-2. 予算実績推移グラフAPI
商品別・カテゴリー別の予算達成状況の推移データを取得する。

#### GET `/api/charts/budget-vs-actual`
**クエリパラメータ**:
- `startYm`: 開始年月
- `endYm`: 終了年月
- `type`: `product` | `category`
- `ids`: 商品コードまたはカテゴリーIDのカンマ区切り
- `salesChannelId`: 販路ID

**レスポンス**:
```json
[
  {
    "periodYm": "2025-12",
    "data": [
      {
        "id": "product1",
        "name": "商品名",
        "actualSales": 500000,
        "budgetSales": 450000,
        "prevYearSales": 480000,
        "actualGrossProfit": 200000,
        "budgetGrossProfit": 180000,
        "prevYearGrossProfit": 190000,
        "actualQuantity": 1000,
        "budgetQuantity": 900,
        "prevYearQuantity": 950,
        "achievementRate": 111.1
      }
    ]
  }
]
```

### 3-3. 商品マスタCSV出力 (拡張)
現在表示されている商品リストをCSV出力する。
- **実装場所**: フロントエンド (`/products/page.tsx`)
- **方式**: `papaparse` を使用して、現在表示されている `filteredProducts` ステートをクライアントサイドでCSV変換。
- **仕様**:
  - ファイル名: `rinori_products_YYYYMMDD.csv`
  - 文字コード: UTF-8（BOM付き）
  - 項目: コード, 名称, ASIN, 販売価格, 原価, 区分, ステータス, カテゴリー名
  - **値の変換**: 
    - 区分: `own` → "自社", `purchase` → "仕入"
    - ステータス: `managed` → "管理中", `unmanaged` → "管理外"

---

## 4. UI/UX設計

### 4-1. 共通グラフコンポーネント (`ChartSection.tsx`)
- **配置**: 表（Table）の直下に配置。
- **機能**:
  - `showChart` (boolean) ステータスによる表示/非表示の切り替え。
  - アコーディオン形式のトグルボタン。
  - 表示項目のオンオフ（チェックボックス）。
  - マウスオーバーによるツールチップ（詳細数値表示）。
  - **Recharts対応**: 親要素に `min-height: 400px` を指定し、`ResponsiveContainer` で描画。

### 4-2. 配置・動作詳細
1. **初期状態**: グラフは「表示（開いた状態）」とする。
2. **凡例クリック**: Rechartsのデフォルト機能で特定の線を一時的に非表示にできる。
3. **描画スキップ**: 昨年データが `null` の場合、`connectNulls={false}` を設定し、プロットをスキップする。

---

## 5. ロジック詳細

### 5-1. 昨年対比データの取得
1. 指定された `periodYm` の範囲に対し、12ヶ月マイナスした期間を計算。
2. `SalesRecord` から現期間と昨期間の両方を取得し、メモリ上でマッピングする。
   - `salesChannelId` が指定されている場合はクエリ条件に含める。
3. 昨年データが存在しない月は `null` を返し、フロントエンド側で描画をスキップさせる。

### 5-2. カテゴリー別合算
- 商品マスタの `categoryId` を参照し、各月のレコードをカテゴリーごとに `reduce` して合計値を算出する。
- `categoryId` が `null` のものは「未分類」グループとして集計する。

### 5-3. 商品マスタCSV取込の安全装置
1. **カテゴリー照合ロジック**:
   - 取込時の差分チェック（`/api/products/import/check`）において、CSVのカテゴリー名を現在の `ProductCategory` 項目と照合。
   - DBに存在しないカテゴリー名が入力されている場合、その行を「エラー（警告）」とし、チェックボックスを無効化して登録をブロックする。
   - カテゴリー名が空欄の場合は「未分類（NULL）」として扱う。
2. **文字コード自動判別**:
   - フロントエンド取込時に `TextDecoder` を使用。
   - `Uint8Array` の先頭3バイトでBOM (0xEF, 0xBB, 0xBF) を判定し、なければ Shift-JIS と UTF-8 のデコード試行（エラー有無）で判別する。

### 5-4. 営業利益・広告費の集計制約
1. **論理結合**: 
   - 同一項目内(ids)の複数選択は **OR条件** (SQLの `IN` 句)。
   - 項目間（期間、販路、商品/カテゴリー）はすべて **AND条件**。
2. **販路フィルタの制約**:
   - `MonthlyBudget` および `AdExpense` には `salesChannelId` カラムが存在しないため、特定販路フィルタ適用時は以下の挙動とする。
     - **実績値**: 指定販路で集計 (AND条件)。
     - **予算値・広告費**: 販路別のデータがないため、「全体(Total)」の値を表示、または達成率/営業利益を N/A とする。
     - **結論**: 正確な達成率および営業利益は「販路: すべて」の時のみ算出可能。

### 5-5. データマッピング表 (DB -> API)
集計およびレスポンス生成時、以下のマッピングを厳守する。

| APIフィールド(JSON) | DBテーブル.カラム | 備考 |
| :--- | :--- | :--- |
| `sales` / `actualSales` | `SalesRecord.salesAmountExclTax` | 実績売上 |
| `grossProfit` / `actualGrossProfit` | `SalesRecord.grossProfit` | 実績粗利 |
| `quantity` / `actualQuantity` | `SalesRecord.quantity` | 実績数量 |
| `budgetSales` | `MonthlyBudget.budgetSalesExclTax` | 予算売上 |
| `budgetGrossProfit` | `MonthlyBudget.budgetGrossProfit` | 予算粗利 |
| `budgetQuantity` | `MonthlyBudget.budgetQuantity` | 予算数量 |
| `sga` | `AdExpense.amount` | 広告費合計 |

### 5-6. カテゴリー別集計の整合性
1. `SalesRecord` から `Product` を経由して `categoryId` を参照する。
2. クエリ条件: `SalesRecord.findMany({ where: { product: { categoryId: { in: [ids] } } } })`
3. `categoryId` が `null` の商品は "未分類" (ID: 0 または "null") として集計グループを予約・保持する。
