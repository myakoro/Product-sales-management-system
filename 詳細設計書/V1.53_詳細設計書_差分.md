# Rinori 売上管理システム V1.53 詳細設計書（差分）

## 1. 概要
本バージョン(v1.53)は、予算管理の完遂を目的とし、広告費予算（Ad Budget）の管理およびPL上での予実比較機能を実装する。

## 2. データベース設計

### 2-1. 新規テーブル: `AdBudget`
月ごとの広告カテゴリ別予算を管理する。

```prisma
model AdBudget {
  id              Int        @id @default(autoincrement())
  periodYm        String     @map("period_ym") // YYYY-MM
  adCategoryId    Int        @map("ad_category_id")
  amount          Float      @default(0)
  createdByUserId Int        @map("created_by_user_id")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  adCategory      AdCategory @relation(fields: [adCategoryId], references: [id])
  createdBy       User       @relation(fields: [createdByUserId], references: [id])

  @@unique([periodYm, adCategoryId])
  @@map("ad_budgets")
}
```

### 2-2. 既存テーブル変更
- **`AdCategory`**: `AdBudget[]` のリレーションを追加。
- **`User`**: `AdBudget[]` のリレーションを追加。

---

## 3. Web API 設計

### 3-1. 広告予算 CRUD `POST/GET /api/ad-budgets`
- **`GET /api/ad-budgets?periodYm=YYYY-MM`**:
  - 指定された月の各カテゴリの予算一覧を取得。
- **`POST /api/ad-budgets`**:
  - 複数カテゴリの予算を一括保存（upsert）。
  - Request Body: `{ periodYm, budgets: [{ categoryId, amount }, ...] }`
  - `createdByUserId` は認証ユーザーから自動設定される。
  - 月ごとの予算設定であり、履歴管理は行わない（最新の値が常に有効）。

### 3-2. PL集計 API 拡張 `/api/pl`, `/api/pl/monthly`
- 集計結果に以下のフィールドを追加（予実比較用）。
  - `adBudget`: 期間内の全カテゴリ予算の合計。
  - `adVariance`: `adExpense - adBudget`（実績－予算）
  - `adAchievementRate`: `adExpense / adBudget`
  - `operatingProfitBudget`: `grossProfitBudget - adBudget`
  - `operatingProfitVariance`: `operatingProfit - operatingProfitBudget`
  - `operatingProfitAchievementRate`: `operatingProfit / operatingProfitBudget`
  - **販路フィルタ時の挙動**:
    - `isChannelFiltered === true` の場合、上記全ての項目に `null` を返却する。

---

## 4. UI/UX コンポーネント設計

### 4-1. 広告費管理画面 (タブ拡張)
`/ad-expenses` 画面に「予算設定」タブを追加（既存：実績一覧、カテゴリ管理）。

1. **予算設定タブ**:
   - `DateNavigator` (V1.52導入) で年月を選択。
   - 有効な各広告カテゴリをベースに、入力フォーム（金額）をリスト表示。
   - 「保存」ボタンで一括更新。

### 4-2. 広告費実績一覧画面 (サマリ追加)
実績一覧（タブ1）の上部に、スタッフも閲覧可能なサマリパネルを表示。

- **総予算**: `monthlyTotalBudget`
- **実績合計**: `monthlyTotalActual`
- **予算残高**: `monthlyRemaining` (`Budget - Actual`)
- **UI**: Tailwind CSSを用いた「Stat Card」形式。残高がマイナス（予算超過）の場合はテキストを赤色 (`text-red-600`) または背景を警告色に変更。

### 4-3. PL画面 (予実テーブル)
月次PLおよび期間PLのテーブル構成を変更。

| 項目 | 実績 | 予算 | 差異 | 達成率 |
| :--- | :--- | :--- | :--- | :--- |
| 売上 | ... | - | - | - |
| 原価 | ... | - | - | - |
| 粗利 | ... | (商品予算粗利) | (差異) | ... |
| **広告費** | ... | **(広告予算合計)** | **(実績-予算)** | ... |
| **営業利益** | ... | **(粗利予-広告予)** | **(実績-予算)** | ... |

---

## 5. 権限・バリデーション
1. **スタッフ権限**:
   - 広告入力画面の「予算サマリ」は閲覧可能。
   - 予算値の「登録・変更」は**マスター権限のみ**。
   - PL画面の予実比較（総合計）は非表示のまま維持。
2. **バリデーション**:
   - 予算額に負の値を許可しない。
   - 重複登録の防止（`@@unique` によるDBガード）。

---
以上
