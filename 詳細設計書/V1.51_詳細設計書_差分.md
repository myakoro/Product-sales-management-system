# Rinori 販売管理システム 詳細設計書 V1.51（差分版）

> **注意**: 本書はV1.5からの差分のみを記載しています。完全な設計はV1.5_詳細設計書.mdと併せて参照してください。

## 変更履歴
- V1.5: CSVパース堅牢化（UTF-8/Shift-JIS自動判別、不正クォート補正）
- V1.51: Amazon CSV取込対応

---

## 1. データベース変更

### 1-1. Product（商品マスタ）拡張

```prisma
model Product {
  productCode        String   @id
  name               String
  priceExclTax       Float
  costExclTax        Float
  isSelfManufactured Boolean  @default(true)
  managementStatus   String   @default("active")
  categoryId         Int?
  asin               String?  @unique  // 【V1.51追加】Amazon ASIN
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  salesRecords       SalesRecord[]
  budgets            Budget[]
}
```

**変更点**:
- `asin` 列を追加（String, NULL許可, UNIQUE制約）

### 1-2. ImportHistory（取込履歴）拡張

```prisma
model ImportHistory {
  id             Int          @id @default(autoincrement())
  importType     String       // 'sales' | 'products' | 'ads'
  targetYm       String       // YYYY-MM
  importMode     String       // 'append' | 'overwrite'
  dataSource     String?      // 【V1.51追加】'NE' | 'Amazon'
  salesChannelId Int?
  comment        String?
  recordCount    Int
  userId         Int?
  createdAt      DateTime     @default(now())
  
  salesChannel   SalesChannel? @relation(fields: [salesChannelId], references: [id])
  salesRecords   SalesRecord[]
}
```

**変更点**:
- `dataSource` 列を追加（String, NULL許可、既存データ互換性のため）

---

## 2. アルゴリズム詳細

### 2-1. Amazonフォーマットパース

```typescript
/**
 * Amazon固有の数値フォーマットをパース
 * - カンマ区切り: "3,805" → 3805
 * - 円記号付き: "￥262,240" → 262240
 */
function parseAmazonNumber(value: string): number {
  if (!value || value === '￥0' || value === '0') return 0;
  
  // 円記号を除去
  let cleaned = value.replace(/[￥¥]/g, '');
  // カンマを除去
  cleaned = cleaned.replace(/,/g, '');
  // 数値に変換
  const num = parseInt(cleaned, 10);
  return isNaN(num) ? 0 : num;
}
```

### 2-2. ASIN → 親コード変換

```typescript
/**
 * ASINから親コードを取得
 * @returns 親コード（見つからない場合はnull）
 */
async function convertAsinToProductCode(
  asin: string,
  prisma: PrismaClient
): Promise<string | null> {
  const product = await prisma.product.findFirst({
    where: { asin: asin },
    select: { productCode: true }
  });
  return product?.productCode ?? null;
}
```

### 2-3. Amazon CSV処理フロー

```typescript
interface AmazonCsvRow {
  productCode: string;      // 変換後の親コード
  asin: string;             // （親）ASIN
  title: string;            // タイトル
  quantity: number;         // 注文された商品点数
  salesAmountInclTax: number; // 注文商品の売上額（税込）
  salesAmountExclTax: number; // 売上額（税抜）※計算後
  costAmountExclTax: number;  // 原価（税抜）※マスタから取得
  grossProfit: number;        // 粗利 ※計算後
}

async function processAmazonCsv(
  rows: Papa.ParseResult<Record<string, string>>,
  targetYm: string,
  prisma: PrismaClient
): Promise<{
  validRows: AmazonCsvRow[];
  unregisteredAsins: { asin: string; title: string }[];
}> {
  const validRows: AmazonCsvRow[] = [];
  const unregisteredAsins: { asin: string; title: string }[] = [];
  
  // 対象年月の税率を取得
  const taxRate = await getTaxRateForYm(targetYm, prisma);
  
  for (const row of rows.data) {
    const asin = row['（親）ASIN']?.trim();
    const title = row['タイトル']?.trim() || '';
    const quantity = parseAmazonNumber(row['注文された商品点数']);
    const salesAmountInclTax = parseAmazonNumber(row['注文商品の売上額']);
    
    if (!asin) continue;
    
    // ASIN → 親コード変換 + 商品情報取得
    const product = await prisma.product.findFirst({
      where: { asin: asin },
      select: { productCode: true, costExclTax: true }
    });
    
    if (product) {
      // 税抜換算（HALF UP）
      const salesAmountExclTax = Math.round(salesAmountInclTax / (1 + taxRate));
      
      // 原価計算（数量 × 単価原価）
      const costAmountExclTax = quantity * product.costExclTax;
      
      // 粗利計算
      const grossProfit = salesAmountExclTax - costAmountExclTax;
      
      validRows.push({
        productCode: product.productCode,
        asin,
        title,
        quantity,
        salesAmountInclTax,
        salesAmountExclTax,
        costAmountExclTax,
        grossProfit
      });
    } else {
      // 未登録ASIN
      if (!unregisteredAsins.find(u => u.asin === asin)) {
        unregisteredAsins.push({ asin, title });
      }
    }
  }
  
  return { validRows, unregisteredAsins };
}

/**
 * 対象年月に適用される税率を取得
 */
async function getTaxRateForYm(targetYm: string, prisma: PrismaClient): Promise<number> {
  const taxRate = await prisma.taxRate.findFirst({
    where: { startYm: { lte: targetYm } },
    orderBy: { startYm: 'desc' }
  });
  return taxRate?.rate ?? 0.10; // デフォルト10%
}
```


---

## 3. Web API 変更

### 3-1. 売上CSV取込 `POST /api/import/sales`

**Request変更** (multipart/form-data):
- `file`: CSVファイル
- `targetYm`: 対象年月 (YYYY-MM)
- `importMode`: 'append' | 'overwrite'
- `salesChannelId`: 販路ID (必須)
- `dataSource`: **【V1.51追加】** 'NE' | 'Amazon'
- `comment`: 備考 (任意)

**処理フロー変更**:
```
1. dataSourceに応じてパースロジックを分岐
   - 'NE': 既存のNEパースロジック
   - 'Amazon': Amazonパースロジック（2-3参照）

2. 'Amazon'の場合、未登録ASINチェック
   - 未登録ASINがあれば、一覧を返却（取込中断）

3. 取込実行
   - ImportHistoryにdataSourceを記録
```

**Response（未登録ASIN検出時）**:
```json
{
  "success": false,
  "error": "unregistered_asins",
  "unregisteredAsins": [
    { "asin": "B07W4B3RGM", "title": "日本製 Rinori がま口..." },
    { "asin": "B01IP3V6TM", "title": "（EndMark） 日本製 革職人..." }
  ]
}
```

**Response（続行指示後・正常完了）**:
```json
{
  "success": true,
  "importedCount": 18,
  "skippedCount": 3,
  "historyId": 42
}
```

### 3-2. 未登録ASINスキップ確認 `POST /api/import/sales/confirm`

**新規API**: 未登録ASIN警告後の続行確認用

**Request**:
```json
{
  "tempFileId": "xxx",
  "skipUnregisteredAsins": true
}
```

**Response**: 通常の取込完了レスポンス

### 3-3. 商品マスタAPI拡張

**PATCH /api/products/[productCode]** - ASIN更新対応

**Request**:
```json
{
  "asin": "B07W4B3RGM"
}
```

**バリデーション**:
- ASIN重複チェック（他商品で使用中の場合は400エラー）

### 3-4. 取込履歴API拡張

**GET /api/import-histories** - レスポンスにdataSource追加

```json
{
  "histories": [
    {
      "id": 42,
      "importType": "sales",
      "targetYm": "2025-12",
      "importMode": "append",
      "dataSource": "Amazon",
      "salesChannelName": "モール",
      "comment": "12月分Amazon売上",
      "recordCount": 18,
      "createdAt": "2025-12-22T10:00:00Z"
    }
  ]
}
```

---

## 4. UI/UXコンポーネント設計

### 4-1. 売上CSV取込画面

```tsx
// データソース選択
const [dataSource, setDataSource] = useState<'NE' | 'Amazon'>('NE');

<label>データソース</label>
<select 
  value={dataSource} 
  onChange={(e) => setDataSource(e.target.value as 'NE' | 'Amazon')}
>
  <option value="NE">NE (CSV)</option>
  <option value="Amazon">Amazon (CSV)</option>
</select>
```

### 4-2. 未登録ASIN警告ダイアログ

```tsx
interface UnregisteredAsinDialogProps {
  asins: { asin: string; title: string }[];
  onContinue: () => void;
  onCancel: () => void;
}

const UnregisteredAsinDialog: React.FC<UnregisteredAsinDialogProps> = ({
  asins, onContinue, onCancel
}) => (
  <div className="fixed inset-0 bg-black/50 flex items-center justify-center">
    <div className="bg-white rounded-lg p-6 max-w-2xl max-h-[80vh] overflow-auto">
      <h2 className="text-xl font-bold text-amber-600 mb-4">
        ⚠️ 未登録のASINが見つかりました
      </h2>
      <p className="mb-4 text-gray-600">
        以下のASINは商品マスタに登録されていないため、スキップされます。
      </p>
      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="p-2 text-left">ASIN</th>
            <th className="p-2 text-left">タイトル</th>
          </tr>
        </thead>
        <tbody>
          {asins.map(({ asin, title }) => (
            <tr key={asin} className="border-t">
              <td className="p-2 font-mono text-sm">{asin}</td>
              <td className="p-2 text-sm truncate max-w-md">{title}</td>
            </tr>
          ))}
        </tbody>
      </table>
      <div className="flex justify-end gap-3">
        <button onClick={onCancel} className="px-4 py-2 border rounded">
          キャンセル
        </button>
        <button 
          onClick={onContinue}
          className="px-4 py-2 bg-blue-600 text-white rounded"
        >
          続行（スキップして取込）
        </button>
      </div>
    </div>
  </div>
);
```

### 4-3. 商品マスタ編集（ASIN列追加）

```tsx
// 商品編集フォームにASIN入力欄を追加
<label>ASIN（Amazon）</label>
<input
  type="text"
  value={product.asin || ''}
  onChange={(e) => setProduct({ ...product, asin: e.target.value })}
  placeholder="例: B07W4B3RGM"
  className="border rounded px-3 py-2 w-full"
/>
```

### 4-4. 取込履歴画面（データソース列追加）

```tsx
<table>
  <thead>
    <tr>
      <th>取込日時</th>
      <th>種別</th>
      <th>データソース</th>  {/* 追加 */}
      <th>対象年月</th>
      <th>販路</th>
      <th>モード</th>
      <th>件数</th>
      <th>コメント</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    {histories.map(h => (
      <tr key={h.id}>
        <td>{formatDate(h.createdAt)}</td>
        <td>{h.importType}</td>
        <td>{h.dataSource || 'NE'}</td>  {/* 追加 */}
        <td>{h.targetYm}</td>
        {/* ... */}
      </tr>
    ))}
  </tbody>
</table>
```

---

## 5. マイグレーション

### 5-1. Prismaマイグレーション

```bash
npx prisma migrate dev --name add_asin_and_datasource
```

生成されるSQL:
```sql
-- Product.asin追加
ALTER TABLE "Product" ADD COLUMN "asin" TEXT;
CREATE UNIQUE INDEX "Product_asin_key" ON "Product"("asin");

-- ImportHistory.dataSource追加
ALTER TABLE "ImportHistory" ADD COLUMN "dataSource" TEXT;
```

### 5-2. 既存データの扱い
- `Product.asin`: NULL（既存商品はASIN未設定）
- `ImportHistory.dataSource`: NULL（既存取込履歴は'NE'として表示）

---

## 6. バリデーション・エラー処理

### Amazon CSV取込

| エラー条件 | エラーメッセージ |
|---|---|
| 必須列不足 | 「（親）ASIN列が見つかりません」 |
| 全行未登録ASIN | 「取り込める商品がありません」 |
| 数値パースエラー | 該当行をスキップ、警告表示 |

### 商品マスタ（ASIN登録）

| エラー条件 | エラーメッセージ |
|---|---|
| ASIN重複 | 「このASINは既に他の商品に登録されています」 |

---

以上
