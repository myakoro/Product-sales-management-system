# Rinori 売上管理システム V1.54 詳細設計 差分案

## 1. データベース設計 (Prisma)

### 1-1. NEAuth テーブル (新規)
NEの認証トークンを管理。
```prisma
model NEAuth {
  id            Int      @id @default(1) // 常に1レコード想定
  accessToken   String
  refreshToken  String
  expiresAt     DateTime // アクセストークン有効期限
  refreshesAt   DateTime // リフレッシュトークン有効期限 (3日)
  updatedAt     DateTime @updatedAt
}
```

### 1-2. NEShopMapping テーブル (新規)
NEの店舗IDとRinoriの販路を紐付け。1つの販路に複数のNE店舗を紐付け可能（N:1）。
```prisma
model NEShopMapping {
  neShopId    Int      @id // NE側のユニークな店舗ID
  channel     Channel  @relation(fields: [channelId], references: [id])
  channelId   Int      // Rinori側の販路ID
}
```

### 1-3. SalesRecord テーブル (既存拡張)
二重取込防止のため外部IDを追加（schema.prismaには反映済み）。
```prisma
model SalesRecord {
  // ...既存フィールド
  externalOrderId String? @unique @map("external_order_id")
}
```

## 2. API設計

### 2-1. 認証フロー (OAuth 2.0)
1. **GET `/api/auth/nextengine/login`**
   - NEログインページへリダイレクト。
2. **GET `/api/auth/nextengine/callback`**
   - NEからのコールバックを受け取り。
   - `uid`, `state` を使用して `accessToken`, `refreshToken` を取得し `NEAuth` に保存。

### 2-2. 同期ロジック

#### 取得・検索要件
- **対象API**: `receiveorder_row/search`（受注明細探索）を主軸とする。
- **出力タイプ**: 「商品コード単位で出力」相当のデータを取得。
- **検索フィルタ**:
    - `receive_order_date` (受注日): ユーザーが指定した**「対象月」の月初から月末**まで。
    - `receive_order_order_status_id`: 20 (出荷確定済) のみ。
    - `receive_order_shop_id`: 選択された販路に紐づくNE店舗ID（複数可）。

#### データマッピング
| Rinori フィールド | NE API フィールド | 変換・処理 |
| :--- | :--- | :--- |
| **売上日** | (固定) | 同期対象月の「月初日」等を一括設定（日別分析は行わない） |
| **型番** | `receive_order_row_goods_id` | `convertSkuToParentCode()` を適用 |
| **数量** | `receive_order_row_quantity` | |
| **税込額** | `receive_order_row_unit_price` × 数量 | APIからの生データを使用 |
| **販路** | (指定) | 同期実行時にユーザーが選択した販路を適用 |
| **外部注文ID** | `receive_order_row_id` | NEの受注明細IDを保存（重複防止用） |

#### 同期シーケンス
1. **パラメータ指定**: UIから `targetYm` (YYYY-MM) / `salesChannelId` を受け取る。
2. **APIリクエスト**: 
    - `receiveorder_row/search` APIを使用。
    - **使用フィールド**: `receive_order_row_id`, `receive_order_row_goods_id`, `receive_order_row_quantity`, `receive_order_row_unit_price`, `receive_order_row_order_id` 等を明示的に指定。
    - **検索フィルタ**: `receive_order_date` に対し、指定された `targetYm` の月初（01日）から月末（末日）を範囲として指定。
    - 同時にステータス「20:出荷確定品」で絞り込み、指定期間内の全明細を取得。
3. **既存データ削除 (上書き)**:
    - 指定された `targetYm` かつ `salesChannelId` に紐づく実績・履歴を一旦クリア（既存CSV取込の仕様を踏襲）。
4. **共通処理の実行**:
    - 取得データを内部的に変換し、既存の共通プログラム（`POST /api/import/sales` 内の保存処理）へ引き渡し。
    - **日付の扱い**: 既存CSV取込と同様のロジックに流し込み、PLの月次整合性を担保する。

## 3. UI設計補足
- **同期実行画面 (SC-18)**:
    - 月選択プルダウン、販路選択、同期実行ボタン。
    - 処理中はローディングUIを表示。
    - 完了後の履歴（DataSource="API"）リンク。
- **設定画面 (SC-17)**:
    - `NEShopMapping` 管理用テーブル。
    - **表示内容**: 「NE店舗ID」「NE店舗名」「Rinori販路選択（プルダウン）」。
    - **店舗名の取得**: 設定画面表示時に NE の `shop/search` 等から最新の店舗情報を取得・表示。

## 4. セキュリティ・制約
- **個人情報の保護**: 受注明細ベースでの取得を徹底し、個人を特定可能な情報は取得段階で除外する。
- **例外処理・耐障害性**:
    - **トークンの自動更新**: 同期処理中にアクセストークンが期限切れ（2時間）にならないよう、実行前にリフレッシュを行う。
    - **レートリミット対応**: 大量データ取得時のAPI負荷制限（429エラー等）を考慮し、必要に応じてリトライや待機処理を入れる。
    - **通信中断**: ネットワークエラー等が発生した場合は同期を中断し、ユーザーにエラー内容を通知する。

---
> [!NOTE]
> 自動同期（Cron等）やキャンセルの自動追跡は、要件定義に基づき本フェーズでは除外・将来課題とする。
