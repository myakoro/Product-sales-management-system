# Rinori 売上管理システム V1.565 詳細設計 追加分

## 1. 概要
V1.56で実装されたグラフ機能において、当初の要件に含まれていたが未実装となっている「複数商品/カテゴリーの比較機能」および「全分析画面へのグラフ配置」を具体化する。
本設計は、ユーザーがリストから項目を選択し、最大5件までの比較推移を視覚化することを目的とする。

## 2. 実装対象画面と配置

| 画面名 | ファイルパス | グラフ追加位置 / 変更内容 |
| :--- | :--- | :--- |
| **商品別PL分析** | `/src/app/pl/products/page.tsx` | 商品一覧テーブルの下に `ChartSection` を追加 |
| **商品予算 vs 商品実績** | `/src/app/budget/vs-actual/page.tsx` | 全体サマリーと商品別一覧の間に `ChartSection` を追加 |
| **全体/カテゴリーPL** | `/src/app/pl/page.tsx` | 既存のグラフを複数比較ロジックに適合するよう改修 |

## 3. 画面共通UI仕様

### 3-1. 比較対象の選択UI (Table)
- **チェックボックスの導入**: 
  - 各分析テーブルの左端（第一列）に「比較」用のチェックボックスを配置。
- **選択制限ロジック**:
  - 最大選択数は **5件** とする。
  - 5件選択中の場合、他のチェックボックスを非活性化（Disabled）にするか、チェック時にトースト等のJ-Alertで「比較は最大5件までです」と通知する。
- **全解除機能**:
  - テーブルヘッダーのチェックボックスをクリックした際は、選択を全解除する（全選択は5件制限のため無効）。

### 3-2. グラフ項目の制御 (Dashboard)
- **「昨年データ」の一括表示切替**:
  - 項目別チェックボックスとは別に、「昨年対比を表示」という共通トグル/チェックボックスを追加。
  - これがOFFの場合、すべての昨年実績ライン（点線）を非表示にする。
- **グラフタイプの切替 (Line/Bar)**:
  - 「折れ線」と「棒」を切り替えるトグルスイッチ、またはタブボタンを配置。
  - デフォルトは「折れ線」。切り替え時は `recharts` のコンポーネントを `LineChart` から `BarChart` に切り替える。

### 3-3. 販路フィルタ適用時のUI制約
- **予算・達成率項目の制御**:
  - 販路（Sales Channel）フィルタが「すべて」以外に設定されている場合、グラフの「予算」「達成率」のチェックボックスを非活性（Disabled）にする。
  - グラフエリア内に「※販路別の予算データがないため、販路絞り込み中は予算比較を表示できません」という注釈を表示する。

### 3-4. 分析対象（全体/個別）に応じたUI項目の動的表示
- **「営業利益」の表示制御**:
  - **全体PL画面** 以外（商品別分析・カテゴリー別分析）では、グラフ設定の **「営業利益」および「昨年同月営業利益」のチェックボックス自体を非表示（Hidden）** にする。
  - これは、本システムにおいて営業利益（販管費按分後）は全体ベースでのみ集計・算出可能なためである。

### 3-5. アコーディオン（開閉トグル）の挙動
- **デフォルト状態**: 
  - 初期描画時はアコーディオンを **「開（Open）」** 状態とする。
- **案内表示（Placeholder）**:
  - 比較対象（商品/カテゴリー）が1つも選択されていない場合、グラフ描画エリアの中央に「左の表から比較したい項目を選択してください（最大5件）」というメッセージを大きく表示し、空のグラフを見せない工夫をする。

## 4. API連携とデータ整形

### 4-1. 複数IDによるデータ取得
- API (`/api/charts/pl-trend` および `/api/charts/budget-vs-actual`) の `ids` クエリパラメータに、選択されたID（商品コード等）をカンマ区切りで渡す。
  - 例: `?ids=RINO-FR01,RINO-FR02,RINO-SY01`

### 4-2. フロントエンドでのデータ整形
- APIから返却される「月別データの中の複数商品配列」を、Rechartsの `LineChart` が処理可能なフラットなオブジェクト形式に変換する。
- **整形後イメージ**:
  ```json
  [
    {
      "periodYm": "2025-12",
      "sales_RINO-FR01": 100000,
      "sales_RINO-FR02": 80000,
      "achievement_RINO-FR01": 110.5,
      ...
    }
  ]
  ```

## 5. グラフ描画仕様 (Recharts)

### 5-1. カラーマッピング
比較時の視認性を確保するため、選択順またはID順に以下の固定カラーパレットを割り当てる。
1.  `#3B82F6` (Blue)
2.  `#10B981` (Green)
3.  `#F59E0B` (Amber)
4.  `#8B5CF6` (Violet)
5.  `#EF4444` (Red)

### 5-2. 動的ライン生成
- `selectedIds` ステートに基づいて、`<Line />` コンポーネントをループで生成する。
- ラインのラベル（凡例名）は `商品名 + 項目名` とする。

### 5-3. 左右のY軸マッピング (Axes)
- **左軸 (YAxisId="left") / 単位: 円**:
  - 売上、粗利、営業利益の実績・予算・昨年データ。
- **右軸 (YAxisId="right") / 単位: % または 個**:
  - 達成率（%）、粗利率（%）、数量（個）。
- **スケール混在時の優先順位**:
  - 「数量（個）」と「各利率（%）」が同時に選択された場合、右Y軸のスケールは **「数量」を優先** して自動計算する。
  - その際、利率ライン（%）が数量の絶対値により底に張り付いて見づらくなる場合は、**ツールチップのみで正確な数値を補完**し、スケールを無理に統合しない（またはRechartsの `domain` を動的に調整する）。

### 5-4. 初期表示（デフォルト表示項目）
全ての項目を最初から表示すると視認性が悪くなるため、初期状態では以下の項目のみチェックをONとする。
- **予算実績グラフ (SC-11)**: 「実績売上」「予算売上」「達成率(%)」の3点。
- **PL推移グラフ (SC-12/13)**: 「売上高」「粗利」「粗利率(%)」の3点。

### 5-5. 凡例（Legend）の連動
- Rechartsの凡例をクリックした際、特定のラインの `hide` 属性を切り替えるインタラクティブ機能を実装する。

## 6. 成功基準
- [ ] すべての分析画面でグラフエリアが表示され、デフォルトでは非表示または全体データが表示されている。
- [ ] 表のチェックボックスを操作することで、グラフ上のラインが即座に同期・更新される。
- [ ] 最大5商品までの比較が、異なる色で明確に区別して表示される。
- [ ] 昨年データのON/OFF制御がグラフ全体に適用される。

## 7. 特論：データの整合性と例外処理

### 7-1. 未分類 (Unclassified) の識別子定義
- テーブル上で「未分類」を選択した場合、APIの `ids` パラメータには定数文字列 `"unclassified"` を渡す。
- API側（`route.ts`）では、`ids` 配列に `"unclassified"` が含まれる場合、`categoryId: null` の商品データを集計対象に含めるロジックを実装する。

### 7-2. 棒グラフ選択時のスタック仕様
- 棒グラフ (`BarChart`) を選択し、かつ複数項目（売上と粗利など）を選択した場合、棒を横に並べる（`layout="vertical"` は使用せず、通常の `Bar` を並べる）設定とする。
- 複数商品比較時は、商品ごとに棒をグループ化して表示する。
