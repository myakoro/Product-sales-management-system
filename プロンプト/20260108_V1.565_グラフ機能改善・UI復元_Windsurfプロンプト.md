# タスク：Rinori売上管理システム V1.565 グラフ機能改善・UI復元実装

## 【背景と現状】
バックエンド（API）の実装および論理監査は、パートナーAI（Antigravity）によって完了しています。
- **対象API**: `/api/charts/pl-trend`, `/api/charts/budget-vs-actual`
- **修正内容**: 複数アイテムの個別比較ロジック、"unclassified" IDの統一、昨年データの厳密な存在判定（将来月のnull化）、販路フィルタ適用時の予算整合性ガードなどを実装済み。
- **整合性**: V1.55のカテゴリー機能との論理矛盾がないことを確認済み。

## 【依頼内容】
以下のドキュメントを「絶対的な正解（Single Source of Truth）」とし、フロントエンドのUI実装および既存UIの復元を行ってください。

### 参照ドキュメント
1. `詳細設計書/V1.565_詳細設計_追加分.md`（メイン指示書）
2. `詳細設計書/V1.56_詳細設計_差分.md`
3. `要件定義書/V1.56_要件定義書_差分.md`
4. `要件定義書/V1.55_要件定義書_差分.md`（復元用）

### 実装の柱
1. **比較グラフのUI構築**:
   - 商品別・カテゴリー別画面での「複数選択チェックボックス」による動的なグラフプロット。
   - 設計書規定のカラーパレット（10色）の適用。
   - 「数量」と「%」が混在する際のY軸スケール表示ロジックの実装（数量優先、%はツールチップ）。
2. **V1.55機能の復元**:
   - `src/app/products/page.tsx` において、消失している「カテゴリー名列」と「カテゴリーフィルタ（プルダウン）」のUIを復元すること。
   - `handleExportCSV` において、カテゴリー未設定時に「未分類」と出力されることを確認（API側と同期済み）。
3. **表示の出し分け（V1.565追加分）**:
   - 各画面において、営業利益関連のUI（凡例、チェックボックス、表）の表示/非表示を画面タイプ（全体・商品別・カテゴリー別）に応じて制御すること。

## 【重要：実装プロセス・ルール】
1. **即座の実装禁止**: コードを書き換える前に、必ず現在のファイル状況と設計ドキュメントをマッピングした「実装計画書」を作成してください。
2. **ユーザーへの質問（必須）**: 計画段階で、以下の点について必ずユーザーに質問を投げ、回答を得るまで実装を開始しないでください。
   - 既存のUIコンポーネントとの配置の兼ね合い（デザインの崩れがないか）。
   - 特定のボタンやフィルタの挙動の微細な確認。
   - その他、実装者が「推測」で補おうとした箇所。
3. **APIの不変性**: APIロジックは監査済みのため、フロント側での型定義の不整合など致命的な理由がない限り、勝手に変更を加えないでください。

**「勝手に推測して進めるのではなく、最適なUI体験のためにユーザーと対話すること」を最優先してください。**
