# V1.58 UI実装指示（Windsurf用）

## 前提条件
- ✅ データベース（`management_budgets`テーブル）は作成済み
- ✅ API（`/api/settings/management-budget`）は実装済み
- ✅ 開発サーバーは正常に起動中（http://localhost:3000）

---

## 実装するUI（3画面）

### 1. 管理売上予算設定画面
**パス:** `/app/settings/management-budget/page.tsx`（新規作成）

**要件:**
- 年度セレクター（2024年〜現在年度）
- 年度全体の目標入力フィールド
- 四半期（Q1〜Q4）の目標入力フィールド
- 月別（1〜12月）の目標入力フィールド

**案分ロジック:**
- 年度入力時: 12ヶ月で均等割（端数は12月に加算）
- 四半期入力時: 3ヶ月で均等割（端数は最終月に加算）
- 月別入力時: 直接更新
- 月別変更時: 四半期・年度合計を再計算して表示

**API連携:**
```typescript
// GET: 既存データの取得
const response = await fetch('/api/settings/management-budget?startYm=2026-01&endYm=2026-12');
const budgets: Array<{ periodYm: string; amount: number; updatedAt: string }> = await response.json();

// POST: 保存
await fetch('/api/settings/management-budget', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ 
    budgets: [
      { periodYm: '2026-01', amount: 10000000 },
      { periodYm: '2026-02', amount: 10000000 }
    ]
  })
});
```

**権限:** `master` ロールのみアクセス可能

**メニュー追加:** 
- 既存の設定メニュー（例：`/app/settings/layout.tsx` または該当するナビゲーションコンポーネント）に「管理売上予算」項目を追加
- 表示位置：「広告予算設定」の下など、予算関連の設定と並べる

---

### 2. 商品予算設定画面の拡張
**パス:** `/app/budget/page.tsx`（既存ファイルを修正）

**追加要素（2箇所）:**

#### 2-1. ヘッダーサマリの拡張
ヘッダーサマリ部分に以下を追加:
- **管理売上予算（目標）**: 表示期間の目標合計
- **全社商品予算（計画）**: 表示期間の全商品予算合計（**フィルタ非連動**）
- **乖離額（不足分）**: `目標 - 計画`
  - 正の数（不足）: 赤字で「あと ¥X,XXX 不足」
  - 0または負（達成）: 青/緑で「目標達成」

**重要:** 
- 商品検索やカテゴリーフィルタを適用しても、「計画」は全商品の合計を表示する
- 期間変更（PeriodNavigator）に連動して、目標・計画・乖離を再計算する

**データ取得例:**
```typescript
const response = await fetch(`/api/settings/management-budget?startYm=${startYm}&endYm=${endYm}`);
const budgets: Array<{ periodYm: string; amount: number }> = await response.json();
const targetAmount = budgets.reduce((sum, b) => sum + b.amount, 0);
```

#### 2-2. クイック入力モーダル（オプション機能）
ヘッダーの「目標金額」をクリックすると、モーダルが開く:
- 現在の表示期間（例：2026-04〜2026-06）の合計目標金額を入力
- 保存時、入力額を月数で均等割して各月に保存
- 端数は最終月に加算

**実装優先度:** 低（時間があれば実装）

---

### 3. カテゴリー別PL画面の拡張
**パス:** `/app/pl/page.tsx`（既存ファイルを修正）

**追加要素:**

#### 3-1. 粗利構成比の表示
- テーブルに「粗利構成比 (%)」列を追加
- 計算式: `(カテゴリー粗利 / 全体粗利) * 100`
- 表示: 小数点第1位まで
- **注意:** 「売上構成比 (%)」は既に実装済み（V1.57）なので、そのまま残す

#### 3-2. 円グラフ（PieChart）
- **ライブラリ:** Recharts（既にインストール済み）

**カテゴリー選択UI:**
- テーブルの各行にチェックボックスを追加
- ユーザーが最大5つのカテゴリーを選択可能
- 選択されたカテゴリーのみを円グラフに個別表示

**データ構成:**
- 選択された最大5カテゴリー（個別スライス）
- 「その他」（未選択カテゴリー + 未分類商品の合計を1つのスライスに集約）
- **合計6スライス**で構成

**切替機能:** 
- 売上構成 / 粗利構成をトグルボタンで切替
- 切替時にグラフを再描画

**赤字対応:** 
- 粗利がマイナスのカテゴリーはグラフから除外
- グラフ下部に「※赤字カテゴリーはグラフから除外されています」と注釈を表示

**端数処理:**
- 各スライスの構成比を小数点第1位で表示
- 合計が100%にならない場合、「その他」の値で調整（例：99.8% → 100.0%）

**動的更新:**
- 期間変更や販路フィルタの変更時、グラフを自動的に再描画
- カテゴリー選択の変更時も即座に反映

**データ取得:**
```typescript
// 既存のAPIを使用
const response = await fetch(`/api/pl/category?startYm=${startYm}&endYm=${endYm}&salesChannelId=${salesChannelId}`);
const categories: Array<{
  categoryId: number | null;
  categoryName: string;
  sales: number;
  cogs: number;
  grossProfit: number;
  grossProfitRate: number;
}> = await response.json();

// 全体合計を計算
const totalSales = categories.reduce((sum, cat) => sum + cat.sales, 0);
const totalGrossProfit = categories.reduce((sum, cat) => sum + cat.grossProfit, 0);

// 選択されたカテゴリーと「その他」を分離
const selectedCategories = categories.filter(cat => selectedIds.includes(cat.categoryId));
const otherCategories = categories.filter(cat => !selectedIds.includes(cat.categoryId));

// 「その他」の合計
const otherSales = otherCategories.reduce((sum, cat) => sum + cat.sales, 0);
const otherGrossProfit = otherCategories.reduce((sum, cat) => sum + cat.grossProfit, 0);

// 円グラフ用データ
const pieData = [
  ...selectedCategories.map(cat => ({
    name: cat.categoryName,
    value: isGrossProfitMode ? cat.grossProfit : cat.sales,
    ratio: isGrossProfitMode 
      ? (cat.grossProfit / totalGrossProfit) * 100
      : (cat.sales / totalSales) * 100
  })),
  {
    name: 'その他',
    value: isGrossProfitMode ? otherGrossProfit : otherSales,
    ratio: isGrossProfitMode
      ? (otherGrossProfit / totalGrossProfit) * 100
      : (otherSales / totalSales) * 100
  }
];
```

---

## 不明点がある場合
**勝手に判断せず、必ず質問してください。**

特に以下の点について不明な場合は質問すること:
- UIのレイアウトやデザイン
- エラーハンドリングの方法
- 既存コンポーネントとの統合方法
- データの表示形式
- 既存の実装との整合性
- チェックボックスの配置場所

---

## 参考ドキュメント
- [要件定義書](file:///c:/Users/takuy/Desktop/Rinori売上管理システム/要件定義書/V1.58_要件定義書_差分.md)
- [詳細設計書](file:///c:/Users/takuy/Desktop/Rinori売上管理システム/詳細設計書/V1.58_詳細設計_差分.md)
