# Rinori 売上管理システム 要件定義書 V1.52（差分：ユーザビリティ改善・運用フィックス）

## 1. 概要
v1.51運用における「使いづらさ」や「データの違和感」を解消し、日々の運用負荷を軽減することを目的とする。

## 2. 機能要件

### 2-1. 売上取込時の特定商品コード除外機能
**課題**: 商品コード正規化により、集計対象外にしたい派生SKU（例: `RINO-FR014-B`）まで集計されてしまう。ユーザー自身で除外対象を管理したい。

**要件**:
1. **除外キーワード管理**:
   - 画面: 「設定 > 除外キーワード設定」画面（新規追加）。
   - 機能: 除外したい商品コードの一部（前方一致または部分一致ルール）を登録・削除できる。
   - 初期データ: なし（ユーザーが登録）
2. **取込時の除外判定**:
   - 売上CSV取込時、SKU変換処理の**前**にチェックを行う。
   - 登録されたキーワードに一致（前方一致推奨）する行は、ログに残しつつ取り込み対象から完全に除外する。

### 2-2. 期間選択の簡易移動（前へ/次へ）機能
**課題**: 月次推移を確認する際、プルダウンでの年月変更が手間である。

**要件**:
- **対象画面**:
  - 月次PL画面
  - 期間PL画面
  - 広告費管理画面（単月表示時）
  - 商品予算vs商品実績画面（旧: 予算vs実績）
- **UI**: 期間指定表示（例: `2025年10月`）の左右に `<` `>` ボタンを配置。
- **挙動**:
  - 単月指定の場合: 前月 / 翌月 へ移動。
  - 期間指定の場合（期間PL）: 期間の幅（月数）を維持してスライド（例: 10~12月(3ヶ月) → 1~3月へ）。

### 2-3. 商品別PLのデフォルト並び順変更
**課題**: 重要なFR系商品がリスト下部に埋もれてしまう。

**要件**:
- **デフォルトソート順**: 以下の優先度で表示する。
  1. `RINO-FR` で始まる商品コード
  2. `RINO-BG` で始まる商品コード
  3. `RINO-SY` で始まる商品コード
  4. その他（商品コード昇順）

### 2-4. PL分析画面からの導線追加
**課題**: 全体PLを見た後、詳細（商品別）を見るためにメニューを経由する必要がある。

**要件**:
- 月次PL / 期間PL画面の上部または下部に、「商品別PLを見る」ボタンまたはリンクを設置する。
- 遷移時、現在閲覧している「期間」「販路」条件を引き継ぐ。

### 2-5. 無視リストの参照と復活機能
**課題**: 「新商品候補」で一度「無視」を選択すると、二度と画面に出なくなり、誤操作時のリカバリーができない。

**要件**:
- **画面**: 「商品を登録 > 新商品候補一覧」画面。
- **UI**: タブ切り替えを追加。
  - `[未登録（保留）]` (デフォルト): 従来通り `pending` の候補を表示。
  - `[無視リスト]`: `ignored` ステータスの候補を表示。
- **復活機能**: 「無視リスト」タブにて、各行に「復活（保留に戻す）」ボタンを設置。押下するとステータスが `pending` に戻り、未登録タブに移動する。

### 2-6. 広告費登録時のデフォルト日付変更
**課題**: 発生日の入力漏れや変更の手間。

**要件**:
- 広告費登録（新規行）の「発生日」初期値を、デフォルトで**アクセス当日**の日付とする。
  - ただし、表示中の月と現在月が異なる場合は、表示月の1日をデフォルトとする。

### 2-7. メニュー名称変更
**課題**: 「予算vs実績」が何を表しているか曖昧。

**要件**:
- サイドメニューおよび画面タイトルの「予算vs実績」を「**商品予算vs商品実績**」に変更する。

### 2-8. 設定メニューの集約（追加要件）
**課題**: 設定項目へのアクセスがトップページ経由のみで不便。

**要件**:
- **ヘッダー変更**: グローバルヘッダーに「設定」リンクを追加する。
- **設定一覧画面**: `/settings` ページを作成し、以下へのリンクを集約する。
  - アカウント設定
  - 販路マスタ、広告カテゴリー、除外キーワード
  - ユーザー管理、税率設定、エクスポート/復元 (Masterのみ)

---

## 3. データベース変更点
- **`ExclusionKeyword` テーブル（新規）**: 除外キーワードを保存するためのテーブルを追加。
    - `id`, `keyword` (String), `matchType` (String: startsWith/includes), `createdAt`

## 4. 既存影響
- 売上取込ロジック: 除外判定ステップの追加。
