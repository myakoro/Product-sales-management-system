# Rinori 売上管理システム V1.54 要件定義 差分案

## 1. 概要
従来のCSV手動ダウンロード・アップロードによる工数を削減するため、ネクストエンジン (NE) APIと連携し、売上データを取得・同期する機能を追加する。

## 2. 機能要件

### 2-1. ネクストエンジン接続
- **認証連携**: ユーザーがシステム上でNEへの連携許可を行い、APIアクセス権を確立できること。
- **権限制御**: NE連携の設定および同期操作は、管理者（マスター権限）のみが実行可能とする。

### 2-2. 売上データの同期
- **同期方式**: ユーザーによる**「対象月」および「販路」の指定同期**。
    - 従来のCSVインポートと同様に、月（例: 2023年12月）を選択して実行する。
    - **一貫した自動処理**: システムが指定された月の月初から月末までのデータをNEから直接取得し、自動で登録を完結させる。
- **取得対象**: 
    - NE側で「出荷確定済み」となっている売上実績。
    - 基本的に、NEから手動でダウンロードしてくるCSVと同等のデータを取得対象とする。
- **データの整合性**:
    - 同一の期間・販路を再度同期した場合、**既存の実績データを「上書き（更新）」**することで、常に最新のNE側の状態を反映し、二重計上を防止する。
- **管理外商品の扱い**:
    - 商品マスタで「管理外」として設定されている型番については、APIで取得された場合でも売上実績には計上（保存）せずスキップする。

### 2-3. 設定と変換
- **店舗対応（マッピング）**: 
    - NEの各店舗IDを、Rinori側のどの「販路」として集計するかをユーザーが定義できる。
    - **複数選択（N:1）の対応**: **一つの「販路」に対して、複数のNE店舗を紐付け可能**とする。（例: 「楽天店」と「楽天2号店」を合わせて、Rinori側の「楽天市場」販路として集計する）
    - **分かりやすさの考慮**: 設定画面ではID番号だけでなく、「店舗名」も併記（例: ID11: RINO本体）し、どの店舗を指しているか一目で判断できるようにする。
- **型番・マスタ連携**: 
    - 取得した売上データは、既存の変換ルール（SKU→親コード）を適用する。
    - マスタ未登録の商品が検知された場合、既存の「新商品候補」フローに自動で引き渡す。

### 2-4. 計算と保存
- **現行ロジックの継承**:
    - API経由での取得データも、保存時の計算（税込単価から税抜への換算・整数丸め処理等）は現在のCSVアップロード機能と全く同じ基準で行う。
- **対象外項目**: 
    - NEの「受注明細」データに含まれない送料・手数料等の項目は、売上分析の対象外とする（現行通り）。

### 2-5. ユーザーインターフェース (UI) と通知
- **処理状態のフィードバック**:
    - 同期実行中（API通信中）は、ユーザーに「処理中」であることがわかる画面表示（プログレスバー等）を行う。
- **エラー通知**:
    - 認証切れや通信エラーにより同期が失敗した場合、その理由がユーザーにわかるように通知を行う。
- **実行履歴**:
    - APIによる同期結果（実行日時、対象期間、取込件数）を、従来の取込履歴と同様にシステム上で確認できること。

## 3. 非機能要件
- **個人情報の保護**: 分析に不要な顧客名や住所等の個人情報は、本システムのデータベースには保存しない。

## 4. 運用ルールの変更
- ユーザーはCSVの手動アップロード作業の代わりに、画面上の同期ボタンによるデータ更新が可能となる。
