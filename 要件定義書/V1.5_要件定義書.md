# Rinori 売上管理システム 要件定義書 V1.5（統合版・完全決定版）

## 変更履歴
- V1.0: 初版
- V1.1: ユーザー権限追加、SKU変換ルール変更
- V1.2: SC-10期間予算編集画面を全商品一覧入力方式に変更
- V1.3: ユーザビリティ改善（SC-09とSC-10統合、SC-14とSC-15統合、SC-03一括選択追加）
- V1.4: 販路別PL対応、取込履歴・販路マスタ・予算vs実績0行フィルタ追加
- V1.5: CSVパース堅牢化（UTF-8/Shift-JIS自動判別、不正クォート補正）

---

## 1. プロジェクト概要

本システムは、小規模D2Cブランド **Rinori（リノリ）** の販売実績・予算・PL（損益）を、商品単位・販路単位・月単位・期間単位で可視化するための社内向けWebアプリケーションである。

**ネクストエンジン（NE）** 出力データを基礎に、商品マスタ・売上実績・広告費・予算を一元管理する。

### 1-1. 設計思想
- **将来拡張性**: Rinori以外のブランドへ横展開可能な設計（ブランドIDによる分離等）を前提とする。
- **データ粒度**: 現状は月次単位だが、DB構造は日次（`sales_date`）集計に対応可能な予約カラムを保持する。
- **ブラウザ**: PC版 Google Chrome 限定。

---

## 2. 目的と達成価値

### 2-1. 経営判断の迅速化
- 商品（型番）別の数量・売上・原価・粗利を月次で可視化。
- 予算 vs 実績（数量・売上）の進捗をシンプルかつリアルタイムに把握。
- 月次PL（売上−原価−広告費＝利益）の即時算出。
- 任意期間（3ヶ月・6ヶ月・期首〜現在・手動範囲）の柔軟な集計。

### 2-2. 運用効率化
- NE売上CSVをアップロードするだけで実績入力が完了する。
- 商品一覧CSV/売上CSVからの商品マスタ差分登録を自動化。
- 商品マスタの原価未設定などを自動検知し、ミスを回避。
- イベント売上などの手入力実績も柔軟に追加できる。
- 管理したくない商品は完全に集計から除外できる（廃盤や例外商品）。

---

## 3. 利用ユーザーと権限

### 3-1. マスター権限（オーナー）
すべての画面・設定・機能にアクセス可能。

### 3-2. スタッフ権限（スタッフ）
**アクセス許可**:
- 広告費入力
- 例外実績入力（手入力実績）
- 商品別の実績・予算 vs 実績・PL閲覧

**🔴 非公開情報・機能（スタッフには見せない）**:
- 月次PL・期間PLの「総合計」行すべて（総売上、総原価、総粗利、総広告費、総利益）
- 各項目に関連する「率」情報（原価率、粗利率、広告率、利益率）
- ユーザー管理機能、データエクスポート・復元機能（メニューおよびアクセス権を制限）
- ※各商品別の実績・PLは閲覧OK

### 3-3. ユーザー管理機能

#### 自分のパスワード変更機能（全ユーザー共通）
- 入力項目: 現在のパスワード、新しいパスワード、確認用
- 現在のパスワードが正しくない場合はエラー
- パスワードはハッシュ化して保存

#### ユーザー管理機能（マスター権限のみ）
- ユーザー一覧表示（ユーザー名、権限種別、作成日時）
- ユーザー新規作成（ユーザー名、権限種別、初期パスワード）
- 権限変更（最後のマスターは変更・削除不可）
- パスワードリセット（一時パスワードを画面表示）

---

## 4. SKU → 親コード変換ルール（必須要件）

NE売上CSV・商品一覧CSVの商品コードを、本システムで管理する「親コード（型番）」に変換する。

### 変換ルール（優先順）
1. **Rule1（RINO- 形式）**: `r"^(RINO-[A-Z0-9]+)"`
   - 例: `RINO-FR010-X-BLK` → `RINO-FR010`
2. **Rule2（ハイフンなし形式）**: `r"^(RINO[A-Z]+[0-9]{3,4})"`
   - 例: `RINODO002BLK` → `RINODO002`
3. **Rule3（その他）**: 元SKUをそのまま親コードとして採用（仕入商品など）

ルールは 1 → 2 → 3 の順で評価し、最初に一致したものを採用。

---

## 5. CSV取込仕様

### 5-1. 売上CSV（NE）取込

#### アップロード前に必須選択
- 対象年月（YYYY-MM）
- 販路（必須）【V1.4追加】- プルダウンで選択
- 取込モード:
  - 追加モード（差分追加・累積）
  - 上書きモード（その月・その販路の実績を全削除して入れ直す）
  - **上書きモードの挙動**: 「対象年月」かつ「選択された販路」の実績のみを全削除して入れ直す。**この際、置き換え対象となった過去の取込履歴（ImportHistory）自体も物理削除し、履歴を重複させない。** 他の販路データは破壊しない。
- コメント（任意）- 備考として履歴に保存

#### CSV列の対応
- SKU → 親コードへ変換
- 数量 → NEの「受注数」
- 売上金額（税込） → 税率設定に基づき **税抜換算（四捨五入/HALF UP）**
- 原価 → 商品マスタから自動取得
- 粗利 → 売上税別 − 原価（自動）

#### 堅牢なパース仕様【V1.5追加】
- **エンコーディング自動判別**: UTF-8とShift-JISを自動検知
- **不正クォート補正**: フィールド末尾の異常な二重引用符を正規表現で補正
- **空フィールド保護**: `""`（空フィールド）を破壊せず、列ズレを防止

#### CSVテンプレート
- Shift-JIS形式の `sales_template.csv` を提供
- ダウンロードボタンを売上CSV取込画面に配置

#### 注意点
- 売上日（日付列）が無いため、実績は対象年月単位で管理
- 日次集計は将来拡張（DBには `sales_date` カラムを確保、NULL運用）

#### 実績の即時反映
取込完了後、月次PL・商品PL・予算vs実績などすべての集計が即時更新される。

### 5-2. 商品一覧CSV取込（マスタ整備）
- SKU → 親コード変換
- マスタ未登録 → 新規候補
- マスタと差異 → 更新候補
- 原価（税別）＝ CSV左から3列目
- 定価（税別）＝ CSVの販売価格
- ユーザーが選択した行のみマスタに登録・更新
- 在庫数などは無視

### 5-3. 売上CSVからの新商品検知
- 売上CSV内に存在するがマスタに無い親コードは「新商品候補」へ
- 候補一覧画面でまとめて管理（毎回ポップアップではない）
- ユーザーは「管理中で登録」または「管理外として扱う」を選択可能

---

## 6. 商品マスタ仕様

### 項目
- 親コード（PK）
- 商品名
- 販売価格（税別）
- 原価（税別）
- 自社 / 仕入フラグ
- 管理ステータス（管理中 / 管理外）
- 商品カテゴリ（NULL許可）【将来拡張用】
- 登録日・更新日

### 商品カテゴリについて【将来拡張用】
- 現時点ではUIに表示せず、DB設計のみ準備
- 将来的に商品を分類する際に使用（例: トップス、ボトムス、ワンピースなど）
- カテゴリマスタテーブルで管理し、商品マスタから参照
- NULL許可（カテゴリ未設定でも運用可能）

### 挙動
- **管理外の商品**: 売上CSVに存在しても集計に含めない、予算設定画面にも出さない
- **ソート**: 全項目で可能
- **フィルタ**: 自社/仕入、管理中/管理外
- **検索**: 商品名・親コードの部分一致

### 警告機能
管理中商品のうち「原価・販売価格など必須項目」が未設定のものがあれば:
- トップページに警告表示
- 不完全マスタ一覧へのリンク

---

## 7. 税率設定
- 初期値: 10%
- 追加形式: 「何年何月から何％」を登録
- 対象年月の税抜換算は、その月に有効な税率を使用

---

## 8. 予算管理（最重要領域）

### 8-1. 月別予算（商品×月）
各月ごとに:
- 予算数量（入力）
- 予算売上（販売価格×数量、自動計算／編集可）
- 予算原価（原価×数量、自動）
- 予算粗利（売上−原価、自動）

「管理中」の商品のみ表示。

### 8-2. 期間予算（全商品一覧で入力）【V1.2変更】

#### 画面構成
- **期間設定エリア**: 開始年月・終了年月を選択、「表示」ボタンで管理中の全商品を一覧表示
  - **初期表示【V1.571追加】**: 開始年月は「当月」、終了年月は「当月+2ヶ月」（計3ヶ月間）
- **期間合計サマリ（画面上部）**: 全商品の合計売上・合計粗利をリアルタイム表示

#### テーブル列構成（左から順に）
1. 商品コード（固定列）
2. 商品名（固定列）
3. 期間合計数量（入力欄、固定列）← ここに入力
4. 期間売上（税別）（自動計算、固定列）
5. 期間粗利（自動計算、固定列）
6. 01月〜（自動配分、スクロール）

#### リアルタイム自動計算
1. 期間合計数量を入力（例: 60）
2. → 即座に期間売上・粗利を計算
   - 期間売上 = 期間合計数量 × 販売価格（税別）
   - 期間粗利 = 期間合計数量 × (販売価格 - 原価)
3. → 月別数量を自動配分（等分、端数は最終月に寄せる）
4. → 画面上部のサマリも更新

月別数量を手動変更した場合:
1. → 期間合計数量を自動再計算（全月の合計）
2. → 期間売上・粗利を再計算

#### 月別数量の自動配分
期間内の月数に応じて数量を等分割（端数は最終月に寄せる）
- 例: 2025-01〜06（6ヶ月）、60個 → 各月10個
- 例: 2025-01〜03（3ヶ月）、100個 → 33, 33, 34（余り1を最終月に加算）

#### 期間合計 vs 合計ズレ警告
画面上部で:
- 期間合計数量（入力値）
- 現在の月別合計数量
- ズレ量（+3 / −2など）
をリアルタイム表示。ズレた状態で保存する場合は警告。

### 8-3. 期間予算の保持
期間予算そのものを履歴として保存し、後から「なぜこの数字になったのか」を確認できる。

---

## 9. 予算 vs 実績（進捗管理）
- 単月／複数月／任意期間を指定可能
- 商品別に: 予算数量、実績数量、数量達成率、予算売上（税別）、実績売上（税別）、売上達成率
- すべてリアルタイム更新

### 0行表示/非表示トグル【V1.4追加】
- チェックボックス: 「予算・実績がどちらも0の商品の行を非表示にする」
- 初期値: チェックON（非表示）
- チェック状態変更で即座に反映（ページリロード不要）

---

## 10. PL（損益計算）

### 10-1. 月次PL
表示項目:
- 売上（税別）、原価（税別）、粗利、広告費、営業利益（粗利−広告費）
- 率（％）を必ず併記: 原価率、粗利率、広告率、利益率
- ※スタッフ権限では総合計・率は非表示

### 10-2. 期間PL（任意範囲）【V1.3改善】

#### 期間選択方式（ラジオボタンで選択）
- **方式1: プリセット期間** - 単月、3ヶ月、6ヶ月、期首〜現在
- **方式2: 任意の期間** - 開始年月（YYYY-MM）〜 終了年月（YYYY-MM）

#### UI動作
- ラジオボタンで選択した方式のみが有効
- 非選択の方式はグレーアウト（disabled）
- 「表示」ボタンで選択中の方式で期間を決定

#### 販路フィルタ【V1.4追加】
- 「販路」プルダウンを追加（全販路 + 各販路）
- 全販路: 全売上を対象に集計
- 特定販路: その販路の売上のみ集計

### 10-3. 商品別PL
商品ごとに: 売上（税別）、原価（税別）、粗利、原価率（％）、粗利率（％）
- 商品別には広告費配賦しない（将来拡張）
- 販路フィルタ対応【V1.4追加】
- **ソート優先順位**: 商品コード（親コード）の特定の接頭辞に基づき以下の順で表示する。
  1. `RINO-FR` (最優先)
  2. `RINOBG`
  3. `RINO-SY`
  4. その他（昇順）

---

## 11. 広告費管理【V1.3改善】

### 画面構成（タブ方式）
- **タブ1: 広告費一覧**
  - 既存の広告費を一覧表示
  - インライン編集（行をクリックして直接編集）【V1.4.5追加】
  - 最下行に新規追加行を常に表示
  - 削除ボタン【V1.4.5追加】

- **タブ2: カテゴリ管理**
  - カテゴリ一覧テーブル
  - カテゴリ名の編集（インライン）
  - 新規カテゴリ追加
  - 削除ボタン

### 広告費の項目
- 日付（YYYY-MM-DD）
- 金額
- カテゴリ（ドロップダウン選択）
- メモ

### カテゴリマスタ
- カテゴリ名（例: META広告、Google広告、展示会費、アンバサダー）
- 作成日・更新日

---

## 12. 販路マスタ仕様【V1.4追加】

### 目的
- 売上実績を「販路」単位で集計・分析
- 販路名称の表記ゆれを防止

### 販路マスタテーブル
- id（PK, 自動採番）
- name（販路名）
- is_active（有効フラグ: true=有効、false=非表示）
- created_at, updated_at

### 初期データ
- EC、モール、卸、催事ポップアップ、その他

### 販路マスタ設定画面
- メニュー位置: 「設定 > 販路マスタ」
- 機能: 一覧表示、新規追加、名称編集、有効/非表示切替

---

## 13. 取込履歴管理

売上CSV・商品一覧CSV・広告費CSV すべてに対し履歴を保存:
- 取込種別、対象年月、モード（追加／上書き）、販路【V1.4追加】、コメント【V1.4追加】、取込日時、件数、実行ユーザー

### 取込履歴画面の拡張【V1.4追加】
- メニュー位置: 「売上 > 取込履歴」
- 初期表示: 最新100件
- ページングや検索で過去分を参照可能

### 取込単位での販路変更機能【V1.4追加】
対象の取込履歴に紐づく全売上レコードの販路を一括変更

### 取込単位での削除機能【V1.4追加】
対象の取込履歴に紐づく全売上レコードを削除（確認ダイアログあり）

---

## 14. 画面一覧

- トップページ（ダッシュボード）【V1.4.5カテゴリ構成化】
- 売上CSV取込画面（CSV様式ダウンロード機能付き【V1.4.5追加】）
- 商品一覧CSV取込画面
- 新商品候補一覧
- 商品マスタ一覧・編集
- 期間予算編集画面（全商品一覧入力方式）
- 予算 vs 実績画面（0行フィルタ付き【V1.4追加】）
- 月次／期間PL画面（販路フィルタ付き【V1.4追加】）
- 商品別PL画面（販路フィルタ付き【V1.4追加】）
- 広告費管理画面（タブ方式【V1.3改善】、インライン編集【V1.4.5追加】）
- 販路マスタ設定画面【V1.4追加】
- 税率設定画面
- 取込履歴画面（販路変更・削除機能付き【V1.4追加】）
- コード変換チェック画面
- アカウント設定画面
- ユーザー管理画面（マスター権限のみ）
- データエクスポート画面（マスター権限のみ）
- データ復元画面（マスター権限のみ）

### ダッシュボードメニュー構成【V1.4.5追加】
```
📦 商品
  - 商品マスタ管理
  - 商品CSV取込
  - 新商品候補

💰 売上
  - 売上CSV取込
  - 取込履歴

📊 予算・PL
  - 予算設定
  - 予算 vs 実績
  - 月次PL
  - 商品別PL

📢 広告費管理

⚙️ 設定
  - 販路マスタ
  - 税率設定
  - アカウント設定
  - ユーザー管理（マスター）
  - データエクスポート（マスター）
  - データ復元（マスター）
```

---

## 15. 非機能要件
- ブラウザ: PC版Chromeのみサポート
- 同時アクセス: 想定3名以内
- データ容量: CSV月次運用に耐えれば十分
- バックアップ/ログ: 設計側に委譲（最低限の履歴保持あれば可）

---

## 16. 将来拡張（設計で潰さない範囲で）
- マルチブランド化（ブランドID追加）
- API連携（広告費自動取込: META / Google 等）
- 日次PL / 日次推移グラフ
- 商品別広告費配賦ロジック
- 期間予算の自動配分アルゴリズム（重み・季節係数）
- 取込履歴単位の部分ロールバック
- 商品カテゴリによる集計

---
以上
