Rinori 販売管理システム

詳細設計書_V1.4（販路別PL・取込履歴改善）**

変更履歴：
- V1.4-01: 初版作成（販路マスタ、販路別PL、取込履歴拡張、予算vs実績0行フィルタ）


1. ドキュメント概要

本書は「Rinori 売上管理システム 要件定義書_V1.4」で定義した以下の機能について、
DB・API・画面単位の詳細設計を示す。

- 販路マスタ管理
- 売上CSV取込時の販路必須選択＆備考保存
- 合計PL／商品別PLの販路別集計
- 予算 vs 実績画面の「予算・実績がどちらも0行の非表示」トグル
- 取込履歴画面の拡張（販路表示・販路変更・取込単位削除）

V1.3 までの基本仕様（SKU変換、予算管理、PL計算、画面遷移など）は
「要件定義書_V1.3」「仕様書/*.md」を前提とし、本書では V1.4 追加分のみを記載する。


2. 対象機能一覧（V1.4）

2-1. 販路マスタ管理
- 新規テーブル: 販路マスタ（sales_channels）
- 新規画面: 販路マスタ設定画面（メニュー: 設定 > 販路マスタ）

2-2. 売上CSV取込（SC-02拡張）
- 入力項目に「販路（必須）」と「コメント（備考）」を追加
- 取込時に選択された販路IDを売上レコードと取込履歴に保存

2-3. 合計PL／商品別PLの販路別集計（SC-12, SC-13拡張）
- 画面上部に「販路」プルダウンを追加
- 選択された販路IDで sales_records をフィルタして集計

2-4. 予算 vs 実績 0行フィルタ（SC-11拡張）
- 「予算・実績がどちらも0の商品の行を非表示にする」チェックボックス
- デフォルト ON（非表示）
- フロント側で一覧表示のみにフィルタを適用

2-5. 取込履歴画面の拡張（SC-04拡張）
- 一覧に「販路」「コメント／備考」列を追加
- 取込単位での「販路変更」機能
- 取込単位での「この取込を削除」機能


3. DB 詳細設計

3-1. 販路マスタテーブル（sales_channels）

● 目的
- 売上実績の集計軸となる「販路」をマスタ管理する。
- 販路名の表記ゆれを防ぎ、PLや商品別PL、取込履歴で安定した集計を可能にする。

● テーブル定義（論理）

- テーブル名: sales_channels

| 論理名      | 物理名         | 型        | Nullable | 備考                         |
|-------------|----------------|-----------|----------|------------------------------|
| ID          | id             | INT       | NO       | PK, auto increment           |
| 販路名      | name           | VARCHAR   | NO       | 例: EC, モール, 卸など       |
| 有効フラグ  | is_active      | BOOLEAN   | NO       | true=有効, false=非表示     |
| 作成日時    | created_at     | DATETIME  | NO       | デフォルト CURRENT_TIMESTAMP |
| 更新日時    | updated_at     | DATETIME  | NO       | 更新トリガ or アプリ更新     |

● 初期データ
- EC
- モール
- 卸
- 催事ポップアップ
- その他
（is_active = true で登録）

3-2. 売上レコードテーブル拡張（sales_records）

● 目的
- 各売上実績を「どの販路の売上か」と紐づける。

● 追加カラム

| 論理名      | 物理名          | 型       | Nullable | 備考                                  |
|-------------|-----------------|----------|----------|---------------------------------------|
| 販路ID      | sales_channel_id| INT      | YES      | sales_channels.id を参照する外部キー |

● 運用
- V1.4以降に新規登録される売上レコード:
  - 売上CSV取込時に必ず販路を選択させるため、sales_channel_id は NULL にならない想定。
- V1.4導入前に登録済みの売上レコード:
  - 運用方針として、V1.4導入時に「売上データは一旦全削除」し、以後は販路を必ず付与して運用する。
  - 商品マスタ等は残す。

※現行実装との整合（重要）
- Prismaの現行スキーマでは、SalesRecord には以下が存在する:
  - importHistoryId（import_histories へのFK）
  - salesDate（DateTime, NOT NULL）
- よって、V1.4で販路を導入する場合も「取込履歴（ImportHistory）と売上レコード（SalesRecord）の紐づけ」は importHistoryId を主軸とする。
- 販路変更・削除は、原則として importHistoryId 単位で売上レコードを一括更新/削除する。

3-3. 取込履歴テーブル拡張（import_histories）

※既存仕様（要件定義書_V1.3 の「12. 取込履歴管理」）を前提とする。

● 追加・確認項目

| 論理名      | 物理名          | 型       | Nullable | 備考                                      |
|-------------|-----------------|----------|----------|-------------------------------------------|
| 販路ID      | sales_channel_id| INT      | YES      | 売上CSV取込時に選択した販路IDを保存      |
| コメント    | comment         | TEXT     | YES      | 画面で入力した備考（期間メモなど）        |

● 関連
- sales_channel_id は sales_channels.id を参照する（FK）。
- import_histories と sales_records の関連（既存）:
  - import_histories.id = sales_records.import_history_id（想定）
  - 実際の物理名・FK名は既存実装に合わせる。

4. API 詳細設計

4-1. 売上CSV取込API 拡張（/api/sales/import, SC-02）

※既存の POST /api/sales/import を拡張する。

● リクエスト
- メソッド: POST
- 形式: multipart/form-data
- パラメータ:
  - file: CSVファイル（必須）
  - targetYm: 対象年月（YYYY-MM, 必須）
  - importMode: 取込モード（"append" / "overwrite" 等, 必須）
  - comment: コメント（任意, テキスト）
  - salesChannelId: 販路ID（必須, 数値）

● バリデーション
- salesChannelId が未指定 or 存在しないID:
  - 400 Bad Request を返し、取込処理を行わない。
- それ以外の既存バリデーション（CSVフォーマット、対象年月、モード etc）は V1.3 と同様。

● 挙動
1. salesChannelId を受け取り、sales_channels テーブルに存在チェック。
2. CSVを解析し、既存ロジックに従って sales_records を生成する。
3. 生成されるすべての sales_records に、sales_channel_id = salesChannelId を設定する。
4. import_histories レコードを1件作成し、以下を保存する:
  - import_type（売上CSV）
  - target_ym
  - import_mode（追加／上書き）
  - comment
  - sales_channel_id
  - 件数 など
5. レスポンスとして、登録件数やエラー件数など既存情報を返す。

● 上書き（overwrite）時の削除範囲（要件上の重要ポイント）
- 上書きモードは、言い換えると「同じ月・同じ販路の売上を、今回のCSVの内容で入れ直す」モードである。
- V1.4では販路別運用のため、上書きで消す範囲は必ず以下に限定する。
  - 対象年月 = targetYm
  - 販路 = salesChannelId（取込画面で選択した販路）
- つまり「他の販路」や「他の月」の売上は、上書きの対象外であり削除しない。
- 上書き時の削除は、取込履歴（ImportHistory）単位で整合が取れるように行う。
  - 対象年月と販路が一致する過去の売上CSV取込履歴を対象として、その履歴に紐づく売上レコードを削除してから、今回の取込を登録する。
  - V1.4の方針として、上書きで置き換え対象となった「過去の売上CSV取込履歴」も同時に削除する（履歴を残さない）。

4-2. 販路マスタAPI（新規, /api/sales-channels）

● エンドポイント一覧
- GET /api/sales-channels
  - 概要: 販路マスタ一覧を取得
  - クエリパラメータ:
    - activeOnly (optional, boolean): true の場合 is_active=true のみ返却

- POST /api/sales-channels
  - 概要: 新しい販路を追加
  - Body(JSON): { name: string }
  - 挙動: name で新規レコード作成（is_active=true）

- PATCH /api/sales-channels/[id]
  - 概要: 指定IDの販路名・有効フラグを更新
  - Body(JSON): { name?: string, isActive?: boolean }

※実際のルーティング構成（[id] ディレクトリ構成）は Next.js の既存API構造に合わせて実装する。

4-3. PL用API拡張（/api/pl, SC-12）

※既存の PL用API を拡張し、販路IDフィルタを追加する。

● リクエスト
- メソッド: GET
- クエリパラメータ（既存＋追加）:
  - startYm, endYm など既存パラメータ
  - salesChannelId (optional, number)
    - 指定なし or 0 → 全販路
    - 正の数値 → そのIDの販路に限定

● 挙動
- salesChannelId が指定された場合:
  - sales_records テーブルから、sales_channel_id = salesChannelId のレコードのみ抽出して集計。
- 指定なしの場合:
  - 既存通り、全レコードを対象とする（全販路合算）。

● 広告費（AdExpense）の扱い（V1.4 方針確定）
- 広告費は販路別には持たず、「全体合算」として保持する。
- そのため、販路別PLでは広告費を差し引かず、営業利益も表示しない。
- 具体的には、以下の表示方針とする。
  - 全販路PL（salesChannelId 未指定/0）: 売上・原価・粗利・広告費・営業利益を表示する。
  - 販路別PL（salesChannelId 指定あり）: 売上・原価・粗利のみ表示し、広告費・営業利益は表示しない。
- APIレスポンスについては、実装時の扱いを以下いずれかで統一する（推奨はA）。
  - 推奨A: 販路別の場合は adExpense / operatingProfit を返さない（null返却またはフィールド省略）
  - 案B: 常に返すが、販路別の場合は画面で非表示（値の解釈ミス防止のため注意）

4-4. 商品別PL用API拡張（/api/pl/products, SC-13）

● リクエスト
- メソッド: GET
- クエリパラメータ:
  - 期間関連（既存）
  - salesChannelId (optional, number)

● 挙動
- PL API と同様、salesChannelId が指定された場合は sales_channel_id でフィルタして商品別PLを集計する。

4-5. 取込履歴API拡張（/api/import-histories, SC-04）

※実際のエンドポイント名は既存実装に合わせる（ここでは /api/import-histories と仮定）。

● GET /api/import-histories
- 概要: 取込履歴一覧を取得
- クエリパラメータ例:
  - limit: 取得件数（デフォルト 100）
  - offset: ページング用オフセット
  - fromYm, toYm: 対象年月範囲フィルタ
  - salesChannelId: 販路フィルタ
  - keyword: コメント・ファイル名等に対するLIKE検索

● PATCH /api/import-histories/[id]/channel
- 概要: 指定取込履歴に紐づく売上レコードの販路IDを一括変更
- Body(JSON): { salesChannelId: number }
- 挙動:
  1. sales_channels から対象IDの存在チェック
  2. import_histories.id = [id] に紐づく sales_records の sales_channel_id を一括更新
  3. import_histories.sales_channel_id も同時に更新
  4. 更新件数をレスポンスで返却

● DELETE /api/import-histories/[id]
- 概要: 指定取込履歴に紐づく売上レコードを一括削除
- 挙動:
  1. import_histories.id = [id] に紐づく sales_records を削除
  2. import_histories レコード自体も物理削除する（履歴を残さない）。
  3. 削除後、PL・商品別PL・予算 vs 実績などの集計は最新状態を反映する。

● 現行実装との整合（重要）
- Prismaスキーマ上、ImportHistory は SalesRecord と 1対多で関連している。
- よって「取込単位削除」は importHistoryId に紐づく SalesRecord の deleteMany が最も安全。

- overwrite（上書き）時は、以下の手順で「同一の対象年月・同一の販路」のデータを入れ直す（案1）。
  1. 対象年月（targetYm）と販路（salesChannelId）が一致する、過去の売上CSV取込履歴（importType='sales'）を特定する。
  2. その取込履歴に紐づく売上レコード（SalesRecord）を一括削除する。
  3. その取込履歴（ImportHistory）自体も物理削除する（履歴を残さない）。
  4. その後、今回のCSV取込で新しい取込履歴を作成し、売上レコードを登録する。

5. 画面詳細設計

5-1. 売上CSV取込画面（SC-02 拡張）

● 入力エリア（拡張）
- 対象年月（YYYY-MM）: 既存
- 取込モード（追加／上書き）: 既存
- CSVファイル: 既存
- コメント（任意）: 既存
- 販路（必須）【V1.4追加】
  - 種別: セレクトボックス
  - 選択肢: /api/sales-channels?activeOnly=true の結果
  - 未選択時: エラーメッセージ「販路を選択してください」表示、取込ボタン disabled or バリデーションエラー

● ボタン
- 「取込開始」ボタン押下時:
  - 入力チェック（販路含む）
  - 問題なければ /api/sales/import へリクエスト

5-2. 販路マスタ設定画面

● メニュー
- 設定 > 販路マスタ

● 構成
- 一覧テーブル
  - 列: 販路名、状態（有効／非表示）、作成日、更新日、操作
  - 行ごとに:
    - 販路名: テキスト入力（インライン編集）
    - 状態: トグル or セレクト（有効／非表示）
    - 操作: 削除ボタン（※過去データへの影響を考慮し、基本は is_active=false での非表示運用を推奨）

- 新規追加行
  - 販路名テキストボックス＋「追加」ボタン

● データ取得・更新
- 初期表示時: GET /api/sales-channels
- 追加: POST /api/sales-channels
- 更新: PATCH /api/sales-channels/[id]

5-3. PL画面（SC-12 拡張）

● 期間・フィルタエリア
- 既存の期間選択 UI の横に「販路」セレクトを追加。
  - 初期値: 「全販路」
  - 選択肢: 全販路 + 販路マスタの is_active=true の一覧

● 表示ロジック
- 「表示」ボタン押下時、/api/pl に salesChannelId パラメータを付与してリクエスト。
- レスポンスを用いて表示する項目は、販路の選択状態によって切り替える。
  - 全販路: 売上・原価・粗利・広告費・営業利益・各率を表示。
  - 販路別: 売上・原価・粗利のみ表示し、広告費・営業利益は表示しない。
- 権限制御（スタッフ権限では総合計非表示等）は既存ロジックを再利用。

5-4. 商品別PL画面（SC-13 拡張）

● 期間・検索エリア
- 既存の「期間種別」「商品検索」の横に「販路」セレクトを追加。
  - 初期値: 「全販路」
  - 選択肢: PL画面と同様

● 表示ロジック
- 条件変更時、「表示」ボタン押下で /api/pl/products に salesChannelId を付与して取得。
- 取得結果を既存のテーブル（商品コード、商品名、販売数量、売上、原価、粗利、平均単価、原価率、粗利率）に反映。
- 商品コードのソート優先ルール（RINO-FR → RINOBG → RINO-SY → その他）は既存のまま適用。

5-5. 予算 vs 実績画面（SC-11 拡張）

● フィルタエリアの拡張
- 商品別一覧テーブルの直上に、以下のチェックボックスを追加。
  - ラベル: 「予算・実績がどちらも0の商品の行を非表示にする」
  - 初期状態: チェック ON

● 表示ロジック
- APIレスポンスとしては、すべての商品行を取得する必要がある。
  （チェックOFF時に「予算も実績も0の商品」を表示するため）
- 現行実装では、予算・実績が完全に0の商品はサーバ側で除外（continue）しているため、
  V1.4では以下のいずれかに変更する必要がある。
  - 推奨案A: サーバ側では除外しない（全商品を返す）→ クライアントでデフォルトONのフィルタ
  - 案B: APIに includeZero=true/false を追加し、OFF時だけ全商品返却（画面切替時は再取得が必要）
- 本書では推奨案A（再取得不要で即時反映）を前提とする。
- クライアント側で、チェックボックスの状態に応じて表示行をフィルタする。
  - ON の場合:
    - 予算数量・実績数量・予算売上・実績売上など、関連する数値がすべて 0 の行を除外。
  - OFF の場合:
    - 除外せず全件表示。

5-6. 取込履歴画面（SC-04 拡張）

● メニュー
- 売上 > 取込履歴

● 一覧テーブル
- 列例:
  - 取込日時
  - 取込種別
  - 対象年月
  - 取込モード（追加／上書き）
  - 販路
  - コメント／備考
  - 件数
  - 実行ユーザー
  - 操作（販路変更／この取込を削除）

● 操作: 販路変更
- 行末に「販路変更」ボタン。
- クリック時にモーダル or ダイアログを表示:
  - 項目: 新しい販路（セレクトボックス）
  - ボタン: 「保存」
- 保存時: PATCH /api/import-histories/[id]/channel を呼び出し、成功後に一覧を再取得 or 行だけ更新。

● 操作: この取込を削除
- 行末に「この取込を削除」ボタン。
- クリック時に確認ダイアログ:
  - メッセージ例: 「この取込に紐づく売上データがすべて削除されます。よろしいですか？」
- OK の場合: DELETE /api/import-histories/[id] を呼び出し、成功後に一覧から該当行を削除。

● ページング・検索
- 初期表示: 最新 100 件を取得
- 画面下部にページング UI（前へ／次へ、ページ番号等）
- 検索条件:
  - 期間（対象年月 from/to）
  - 販路
  - コメントキーワード
- 検索条件を指定して「検索」ボタン押下で GET /api/import-histories を呼ぶ。

6. バリデーション・エラー表示方針

6-1. 売上CSV取込
- 販路未選択:
  - クライアント側: 赤字バリデーションメッセージ「販路を選択してください」表示。
  - サーバ側: salesChannelId 不正の場合は 400 エラーとエラーメッセージを返却。

6-2. 販路マスタ
- 名前未入力での追加は禁止（ボタン disabled またはエラー）。
- 既存販路名との重複は運用に応じて許容 or 警告（実装時に決定）。

6-3. 取込履歴の販路変更
- 指定された販路IDが存在しない場合:
  - 400 or 404 エラーを返却し、UI側でエラーメッセージ表示。

7. 既存データへの影響・移行

- V1.4導入時の移行方針として、既存の売上データ（sales_records）は一旦すべて削除する。
- 商品マスタ（products）および予算データ等は残す。
- 併せて、売上CSV取込履歴（import_histories の importType='sales'）についても、
  実態データが無くなることで履歴が混乱しないよう、一旦削除する。
- これにより、V1.4以降は「売上データには必ず販路が付与される」状態で運用を開始する。

以上
