# Rinori 売上管理システム V1.56 要件定義 差分案

## 1. 概要
V1.55で実装した商品カテゴリー機能を基盤として、データの可視化機能を強化する:
1. **商品予算 vs 商品実績 (SC-11) のグラフ機能**: 商品別/カテゴリー別の予算実績推移をグラフで表示
2. **PL分析 (月次・期間) のグラフ機能**: 全体PL/商品別PL/カテゴリー別PLの月次推移をグラフで表示

> [!NOTE]
> **V1.55の前提条件**  
> 本バージョンは、V1.55で実装された商品カテゴリー機能が完了していることを前提とします。カテゴリー別グラフを表示するには、カテゴリーマスタと商品の紐付けが必要です。

## 2. 機能要件

### 2-1. 商品予算 vs 商品実績 (SC-11) のグラフ機能

#### 2-1-1. グラフの種類と表示内容
- **グラフタイプ**: 
  - 折れ線グラフまたは棒グラフで月次推移を表示
  - ユーザーが切り替え可能（推奨: 折れ線グラフをデフォルト）
- **表示データ**: 
  - X軸: 月（例: 2025年10月、2025年11月、2025年12月）
  - Y軸（左）: 金額（円）
  - Y軸（右）: 数量（個）または達成率（%）
  - **表示項目（チェックボックスで選択可能）**:
    - **予算売上**（折れ線または棒、左軸）
    - **実績売上**（折れ線または棒、左軸）
    - **昨年同月実績売上**（折れ線または棒、左軸）
    - **予算粗利**（折れ線または棒、左軸）
    - **実績粗利**（折れ線または棒、左軸）
    - **昨年同月実績粗利**（折れ線または棒、左軸）
    - **予算数量**（折れ線または棒、右軸）
    - **実績数量**（折れ線または棒、右軸）
    - **昨年同月実績数量**（折れ線または棒、右軸）
    - **達成率（%）**（折れ線、右軸）
  - **デフォルト表示**: 予算売上、実績売上、達成率（他の項目は初期状態で非表示、ユーザーが選択可能）
  - **表示項目の選択**: グラフ上部または横にチェックボックスを配置し、リアルタイムでグラフに反映

#### 2-1-2. 表示対象の選択
- **商品別 / カテゴリー別の切り替え**: 
  - **商品別モード**: 
    - 商品一覧からチェックボックスで1つまたは複数の商品を選択（最大5商品程度・比較表示）
    - 各商品の予算・実績を個別に表示
  - **カテゴリー別モード**: 
    - カテゴリー一覧からチェックボックスで1つまたは複数のカテゴリーを選択（比較表示）
    - 各カテゴリー（「未分類」を含む）に所属する商品の予算・実績を合算して表示
- **期間選択**: 
  - デフォルト: 直近12ヶ月
- **データの性能**: 
  - 実績データは確定した「売上数」を使用する。
  - **昨年同月実績**: データが存在しない月は「描画スキップ（プロットせず、線を結ばない）」として処理する。
- **フィルタ連動**:
  - すべてのグラフは、現在選択されている「販路（SalesChannel）」フィルタを適用する。

#### 2-1-3. グラフの配置
- **配置場所**: 
  - 既存の各画面（予算実績表、PL表）のすぐ下、または上に配置。
  - **表示/非表示の切り替え**: 開閉トグル（アコーディオン形式）を設置し、デフォルトは「開」とする。

#### 2-1-4. インタラクティブ機能
- **ツールチップ**: 
  - グラフ上の各データポイントにマウスオーバーすると、詳細数値を表示
  - 例（商品別）: 「2025年12月 [商品名]: 予算売上 ¥500,000 / 実績売上 ¥567,890 / 昨年同月実績売上 ¥520,000 / 予算粗利 ¥200,000 / 実績粗利 ¥227,156 / 昨年同月実績粗利 ¥208,000 / 予算数量 1,000個 / 実績数量 1,136個 / 昨年同月実績数量 1,040個 / 達成率 113.6%」
  - 例（カテゴリー別）: 「2025年12月 [カテゴリー名]: 予算売上 ¥1,200,000 / 実績売上 ¥1,345,678 / 昨年同月実績売上 ¥1,150,000 / 予算粗利 ¥480,000 / 実績粗利 ¥538,271 / 昨年同月実績粗利 ¥460,000 / 予算数量 2,500個 / 実績数量 2,789個 / 昨年同月実績数量 2,300個 / 達成率 112.1%」
  - 表示項目は、ユーザーが選択した項目のみ表示（全項目を常に表示する必要はない）
- **凡例**: 
  - 商品名またはカテゴリー名と色の対応を表示
  - 凡例をクリックすると、その商品/カテゴリーのグラフ表示/非表示を切り替え
- **表示項目の選択UI**: 
  - グラフ上部または横にチェックボックスを配置
  - 例: ☑ 予算売上 ☑ 実績売上 ☐ 昨年同月実績売上 ☐ 予算粗利 ☐ 実績粗利 ☐ 昨年同月実績粗利 ☐ 予算数量 ☐ 実績数量 ☐ 昨年同月実績数量 ☑ 達成率
  - チェックボックスの変更は即座にグラフに反映（リロード不要）

---

### 2-2. PL分析 (月次・期間) のグラフ機能

#### 2-2-1. グラフの種類と表示内容
- **グラフタイプ**: 
  - 折れ線グラフまたは棒グラフで月次推移を表示
  - ユーザーが切り替え可能（推奨: 折れ線グラフをデフォルト）
- **表示データ**: 
  - X軸: 月（例: 2025年10月、2025年11月、2025年12月）
  - Y軸（左）: 金額（円）
  - Y軸（右）: 粗利率（%）
  - **表示項目の制限**:
    - **売上高**（折れ線または棒、左軸）
    - **昨年同月実績売上高**（折れ線または棒、左軸）
    - **粗利（売上総利益）**（折れ線または棒、左軸）
    - **昨年同月実績粗利**（折れ線または棒、左軸）
    - **営業利益**（「全体PL」モードのみ選択可能、商品/カテゴリー別では非表示）
    - **昨年同月実績営業利益**（「全体PL」モードのみ選択可能）
    - **粗利率（%）**（折れ線、右軸）
  - **デフォルト表示**: 売上高、粗利、粗利率
  - **表示項目の選択**: グラフ上部または横にチェックボックスを配置し、リアルタイムでグラフに反映
  - **未分類商品の扱い**: カテゴリー別グラフにおいて、categoryId=NULLの商品は「未分類」として集計・表示する。

#### 2-2-2. 対象期間の指定
- **期間選択**: 
  - ユーザーが開始月と終了月を指定（例: 2025年1月〜2025年12月）
  - デフォルト: 直近12ヶ月
- **データの集計**: 
  - 指定期間内の各月のPL実績を集計してグラフ化
  - 売上実績が存在しない月は0として表示（または非表示オプション）
  - **昨年同月実績**: 各月の1年前のデータを自動取得して表示
    - 例: 2025年12月を表示する場合、2024年12月の実績を「昨年同月実績」として表示
    - 昨年同月のデータが存在しない場合は0または非表示

#### 2-2-3. 表示オプション
- **全体PL / 商品別PL / カテゴリー別PL**: 
  - **全体PL**: 全体の月次推移
  - **商品別PL**: 特定商品を選択した場合、その商品の月次推移
    - 複数商品を選択可能（最大5商品程度、各商品を異なる色で表示）
  - **カテゴリー別PL**: 特定カテゴリーを選択した場合、そのカテゴリーの月次推移
    - 複数カテゴリーを選択可能（カテゴリー比較が可能）
- **グラフの配置**: 
  - 既存のPL分析画面（表形式）の下部または別タブにグラフを表示
  - 表とグラフを同時に確認できる構成を推奨

#### 2-2-4. インタラクティブ機能
- **ツールチップ**: 
  - グラフ上の各データポイントにマウスオーバーすると、詳細数値を表示
  - 例: 「2025年12月: 売上高 ¥1,234,567 / 昨年同月実績売上高 ¥1,100,000 / 粗利 ¥456,789 / 昨年同月実績粗利 ¥407,000 / 粗利率 37.0%」
- **ドリルダウン（オプション機能）**: 
  - グラフ上の特定月をクリックすると、その月の詳細PL（商品別内訳）に遷移
- **凡例**: 
  - 商品名またはカテゴリー名と色の対応を表示
  - 凡例をクリックすると、その商品/カテゴリーのグラフ表示/非表示を切り替え

---

### 2-3. 商品マスタのCSV出力機能 (SC-03拡張)

#### 2-3-1. 機能概要
- **目的**: 商品マスタの一括更新ワークフロー（DL → 編集 → 取込）を補助するため、現在のマスタ情報をCSV形式で出力する。
- **配置場所**: 商品マスタ一覧画面 (`/products`) の上部（「新規登録」ボタンの横など）。
- **動作**: 
  - 現在適用されている検索キーワード、商品区分フィルタ、管理ステータスフィルタの結果を反映した一覧をダウンロード。
  - クライアントサイドでのCSV生成（`papaparse`等を使用）により、追加のAPIリクエストを最小限に抑える。
  - **出力形式**: Excel互換性を考慮し、文字化けに強い「BOM付きUTF-8」を採用。

#### 2-3-2. 出力フォーマット
- 文字コード: UTF-8 (BOM付き)
- ヘッダー行: あり
- 項目列:
  1. 商品コード
  2. 商品名
  3. ASIN
  4. 販売価格（税別）
  5. 原価（税別）
  6. 商品区分 (自社/仕入)
  7. 管理ステータス (管理中/管理外)
  8. カテゴリー

---

## 3. 非機能要件

### 3-1. パフォーマンス
- **グラフ描画速度**: 
  - 12ヶ月分のデータを1秒以内に描画できること
  - 大量データ（商品数100以上、期間24ヶ月以上）でも3秒以内に表示

### 3-2. ユーザビリティ
- **レスポンシブ対応**: 
  - グラフはPC・タブレットで適切に表示されること
  - スマートフォンでは簡易表示または横スクロール対応
- **直感的な操作**: 
  - グラフの期間変更・表示項目の切り替えは、リロードなしで即座に反映
  - チェックボックスのON/OFFでグラフがリアルタイムに更新される

### 3-3. アクセシビリティ
- **カラーパレット**: 
  - 色覚異常の方にも識別しやすい配色を使用
  - 推奨カラーパレット:
    - 予算売上/売上高: 青系（#3B82F6）
    - 実績売上: 緑系（#10B981）
    - 予算粗利/粗利: オレンジ系（#F59E0B）
    - 実績粗利: 紫系（#8B5CF6）
    - 営業利益: 赤系（#EF4444）
    - 達成率/粗利率: グレー系（#6B7280）

---

## 4. UI/UX要件

### 4-1. グラフ表示画面の共通仕様
- **グラフライブラリ**: 
  - Chart.js、Recharts、ApexCharts等の軽量で視覚的に優れたライブラリを使用
  - ダークモード対応（既存UIに合わせる）
- **レイアウト**: 
  - グラフは画面幅いっぱいに表示（レスポンシブ対応）
  - 表示項目選択チェックボックスは、グラフ上部に配置
  - 商品/カテゴリー選択は、グラフ左側または上部に配置

### 4-2. 商品予算vs実績画面の拡張
- **画面構成**: 
  - 上部: 期間選択、商品別/カテゴリー別切り替え
  - 中部: 表形式の予算実績データ（既存）
  - 下部: グラフ表示エリア（新規）
    - グラフON/OFFボタン
    - 表示項目選択チェックボックス
    - グラフ本体

### 4-3. レイアウトの統一
- **UI共通仕様**:
  - PL分析画面も「別タブ」ではなく、既存の表の下に「開閉トグル付き」でグラフを配置する形式に統一し、表の数値とグラフを同時に比較できるようにする。

---

## 5. 実装優先順位

### Phase 1（最優先）
1. **PL分析 (月次・期間) のグラフ機能**
   - 全体PLの月次推移グラフ
   - 表示項目選択機能（チェックボックス）
   - ツールチップ表示
2. **商品マスタのCSV出力機能**
   - 商品一覧画面へのダウンロードボタン設置
   - CSV生成・ダウンロードロジック実装

### Phase 2（高優先）
2. **商品予算 vs 商品実績 (SC-11) のグラフ機能**
   - 商品別モードのグラフ表示
   - 表示項目選択機能（チェックボックス）
   - ツールチップ表示

### Phase 3（中優先）
3. **カテゴリー別グラフの拡張**
   - PL分析のカテゴリー別グラフ
   - 商品予算vs実績のカテゴリー別グラフ
   - カテゴリー比較機能（複数カテゴリー選択）

### Phase 4（低優先・オプション）
4. **高度なインタラクティブ機能**
   - ドリルダウン機能（グラフから詳細画面へ遷移）
   - グラフのエクスポート機能（PNG/PDF）
   - グラフ設定の保存機能（ユーザー設定として保存）

---

## 6. 技術的考慮事項

### 6-1. グラフライブラリの選定
- **推奨: Recharts**
  - Reactとの親和性が高い
  - レスポンシブ対応が容易
  - カスタマイズ性が高い
  - TypeScript対応
- **代替案: Chart.js**
  - 軽量で高速
  - 豊富なプラグイン
  - ドキュメントが充実

### 6-2. データ取得の最適化
- **API設計**: 
  - グラフ表示専用のAPIエンドポイントを作成（例: `/api/charts/budget-vs-actual`, `/api/charts/pl-trend`）
  - 必要なデータのみを取得（不要なフィールドは除外）
  - キャッシュ機能の実装（同一期間の再取得を防ぐ）

### 6-3. フロントエンドの状態管理
- **表示項目の状態**: 
  - チェックボックスの状態をReact Stateで管理
  - ローカルストレージに保存し、次回訪問時に復元（オプション）
- **選択商品/カテゴリーの状態**: 
  - 複数選択の状態を配列で管理
  - 選択変更時にグラフを再描画

---

## 7. 成功基準

### 7-1. 機能面
- [ ] PL分析画面で、月次推移グラフが表示される
- [ ] 商品予算vs実績画面で、予算と実績のグラフが表示される
- [ ] 表示項目をチェックボックスで選択すると、グラフがリアルタイムに更新される
- [ ] 複数商品/カテゴリーを選択すると、異なる色で同時に表示される
- [ ] ツールチップで各データポイントの詳細数値が確認できる

### 7-2. UX面
- [ ] グラフが直感的で、経営判断に役立つ情報が得られる
- [ ] グラフの描画が高速（12ヶ月分のデータを1秒以内）
- [ ] 既存のPL分析機能との操作性が統一されている
- [ ] カテゴリー比較により、商品ラインナップの傾向が把握できる
- [ ] 昨年同月実績が正しく表示され、昨対比較ができる

### 7-3. パフォーマンス面
- [ ] 大量データ（商品数100以上、期間24ヶ月）でも3秒以内に表示
- [ ] グラフの操作（ズーム、パン等）が滑らか

---

## 8. V1.55との依存関係

> [!IMPORTANT]
> **V1.55の完了が前提条件**  
> 本バージョンは、V1.55で実装された以下の機能に依存します:
> - 商品カテゴリーマスタ（CRUD機能）
> - 商品のカテゴリー紐付け機能
> - カテゴリー別PL集計機能
> 
> V1.55が完了していない場合、カテゴリー別グラフ機能は実装できません。

---

**作成日**: 2026-01-07  
**対象バージョン**: V1.56  
**前提バージョン**: V1.55（商品カテゴリー機能完了）
