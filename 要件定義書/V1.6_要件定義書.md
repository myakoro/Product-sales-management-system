# Rinori 売上管理システム 要件定義書 V1.6（統合版）

## 変更履歴
- V1.0: 初版
- V1.1: ユーザー権限追加、SKU変換ルール変更
- V1.2: SC-10期間予算編集画面を全商品一覧入力方式に変更
- V1.3: ユーザビリティ改善（SC-09とSC-10統合、SC-14とSC-15統合、SC-03一括選択追加）
- V1.4: 販路別PL対応、取込履歴・販路マスタ・予算vs実績0行フィルタ追加
- V1.5: CSVパース堅牢化（UTF-8/Shift-JIS自動判別、不正クォート補正）
- V1.51: Amazon CSV取込対応（ASIN照合・データソース選択）
- V1.52: ユーザビリティ改善（除外キーワード、期間ナビゲーション、ソート順改善等）
- V1.53: 広告費予算管理（広告費月間予算設定、PL予実比較）
- V1.54: ネクストエンジンAPI連携（売上データ自動同期）
- V1.55: 商品カテゴリー機能（カテゴリーマスタ、カテゴリー別PL分析）
- V1.56: グラフ可視化機能（予算vs実績グラフ、PL推移グラフ、商品マスタCSV出力）
- V1.57: 分析強化（NE過去データ同期、構成比表示、カテゴリーフィルタ改善、粗利率表示）
- V1.58: 管理売上予算（トップダウン目標管理）、カテゴリーPL円グラフ、粗利構成比
- V1.581: 商品予算設定の未保存変更破棄防止
- **V1.6: 統合版（V1.5〜V1.581の全差分を統合）**

---

## 1. プロジェクト概要

本システムは、小規模D2Cブランド **Rinori（リノリ）** の販売実績・予算・PL（損益）を、商品単位・販路単位・カテゴリー単位・月単位・期間単位で可視化するための社内向けWebアプリケーションである。

**ネクストエンジン（NE）** 出力データおよびNE APIを基礎に、商品マスタ・売上実績・広告費・予算を一元管理する。

### 1-1. 設計思想
- **将来拡張性**: Rinori以外のブランドへ横展開可能な設計（ブランドIDによる分離等）を前提とする。
- **データ粒度**: 現状は月次単位だが、DB構造は日次（`sales_date`）集計に対応可能な予約カラムを保持する。
- **ブラウザ**: PC版 Google Chrome 限定。

---

## 2. 目的と達成価値

### 2-1. 経営判断の迅速化
- 商品（型番）別の数量・売上・原価・粗利を月次で可視化。
- 予算 vs 実績（数量・売上）の進捗をシンプルかつリアルタイムに把握。
- 月次PL（売上−原価−広告費＝利益）の即時算出。
- 任意期間（3ヶ月・6ヶ月・期首〜現在・手動範囲）の柔軟な集計。
- カテゴリー別の売上・粗利構成比を円グラフ等で視覚的に把握。
- 管理売上予算（トップダウン目標）と商品積み上げ予算の乖離を常時確認。

### 2-2. 運用効率化
- NE売上CSVをアップロードするだけで実績入力が完了する。
- NE API連携により、CSV手動ダウンロード不要で売上データを自動同期。
- Amazon Business Report CSVの取込にも対応。
- 商品一覧CSV/売上CSVからの商品マスタ差分登録を自動化。
- 商品マスタの原価未設定などを自動検知し、ミスを回避。
- イベント売上などの手入力実績も柔軟に追加できる。
- 管理したくない商品は完全に集計から除外できる（廃盤や例外商品）。
- 除外キーワード設定により、特定SKUを取込時に自動除外。

---

## 3. 利用ユーザーと権限

### 3-1. マスター権限（オーナー）
すべての画面・設定・機能にアクセス可能。

### 3-2. スタッフ権限（スタッフ）
**アクセス許可**:
- 広告費入力
- 例外実績入力（手入力実績）
- 商品別の実績・予算 vs 実績・PL閲覧
- 広告費入力画面のサマリ情報（月間総予算・実績合計・予算残高）の閲覧

**非公開情報・機能（スタッフには見せない）**:
- 月次PL・期間PLの「総合計」行すべて（総売上、総原価、総粗利、総広告費、総利益）
- 各項目に関連する「率」情報（原価率、粗利率、広告率、利益率）
- ユーザー管理機能、データエクスポート・復元機能（メニューおよびアクセス権を制限）
- 管理売上予算マスタの編集（閲覧は可能）
- ※各商品別の実績・PLは閲覧OK

### 3-3. ユーザー管理機能

#### 自分のパスワード変更機能（全ユーザー共通）
- 入力項目: 現在のパスワード、新しいパスワード、確認用
- 現在のパスワードが正しくない場合はエラー
- パスワードはハッシュ化して保存

#### ユーザー管理機能（マスター権限のみ）
- ユーザー一覧表示（ユーザー名、権限種別、作成日時）
- ユーザー新規作成（ユーザー名、権限種別、初期パスワード）
- 権限変更（最後のマスターは変更・削除不可）
- パスワードリセット（一時パスワードを画面表示）

---

## 4. SKU → 親コード変換ルール（必須要件）

NE売上CSV・商品一覧CSVの商品コードを、本システムで管理する「親コード（型番）」に変換する。

### 変換ルール（優先順）
1. **Rule1（RINO- 形式）**: `r"^(RINO-[A-Z0-9]+)"`
   - 例: `RINO-FR010-X-BLK` → `RINO-FR010`
2. **Rule2（ハイフンなし形式）**: `r"^(RINO[A-Z]+[0-9]{3,4})"`
   - 例: `RINODO002BLK` → `RINODO002`
3. **Rule3（その他）**: 元SKUをそのまま親コードとして採用（仕入商品など）

ルールは 1 → 2 → 3 の順で評価し、最初に一致したものを採用。

---

## 5. CSV取込仕様

### 5-1. 売上CSV（NE）取込

#### アップロード前に必須選択
- 対象年月（YYYY-MM）
- データソース（NE CSV / Amazon CSV）
- 販路（必須）- プルダウンで選択
- 取込モード:
  - 追加モード（差分追加・累積）
  - 上書きモード（その月・その販路の実績を全削除して入れ直す）
  - **上書きモードの挙動**: 「対象年月」かつ「選択された販路」の実績のみを全削除して入れ直す。**この際、置き換え対象となった過去の取込履歴（ImportHistory）自体も物理削除し、履歴を重複させない。** 他の販路データは破壊しない。
- コメント（任意）- 備考として履歴に保存

#### データソースによる動作切替

| 項目 | NE (CSV) | Amazon (CSV) |
|---|---|---|
| 商品コード列 | 商品コード（SKU） | （親）ASIN |
| 数量列 | 受注数 | 注文された商品点数 |
| 売上金額列 | 売上金額（税込） | 注文商品の売上額 |
| コード変換 | SKU→親コード変換ルール | ASIN→親コード（マスタ照合） |

#### CSV列の対応（NE形式）
- SKU → 親コードへ変換
- 数量 → NEの「受注数」
- 売上金額（税込） → 税率設定に基づき **税抜換算（四捨五入/HALF UP）**
- 原価 → 商品マスタから自動取得
- 粗利 → 売上税別 − 原価（自動）

#### Amazon CSV固有仕様
- **使用列**: （親）ASIN、タイトル、注文された商品点数、注文商品の売上額
- **B2B売上**: 通常売上（B2Bなし列）のみを取込対象とする。B2B列は無視。
- **数値パース**: カンマ区切り（例: `"3,805"`）、円記号付き金額（例: `"￥262,240"`）を適切にパース。
- **ASIN → 親コード変換**: 商品マスタに登録されたASINを照合し、対応する親コードを取得。
- **未登録ASIN**: 取込前に警告ダイアログを表示。「続行」でスキップ取込、「キャンセル」で中止。新商品候補には登録しない。

#### 除外キーワード機能
- 売上CSV取込時、SKU変換処理の**前**に除外キーワードチェックを行う。
- 登録されたキーワードに一致（前方一致）する行は、ログに残しつつ取込対象から完全に除外する。
- 「設定 > 除外キーワード設定」画面で管理。

#### 堅牢なパース仕様
- **エンコーディング自動判別**: UTF-8とShift-JISを自動検知
- **不正クォート補正**: フィールド末尾の異常な二重引用符を正規表現で補正
- **空フィールド保護**: `""`（空フィールド）を破壊せず、列ズレを防止

#### CSVテンプレート
- Shift-JIS形式の `sales_template.csv` を提供
- ダウンロードボタンを売上CSV取込画面に配置

#### 注意点
- 売上日（日付列）が無いため、実績は対象年月単位で管理
- 日次集計は将来拡張（DBには `sales_date` カラムを確保、NULL運用）

#### 実績の即時反映
取込完了後、月次PL・商品PL・予算vs実績などすべての集計が即時更新される。

### 5-2. 商品一覧CSV取込（マスタ整備）
- SKU → 親コード変換
- マスタ未登録 → 新規候補
- マスタと差異 → 更新候補
- 原価（税別）＝ CSV左から3列目
- 定価（税別）＝ CSVの販売価格
- ユーザーが選択した行のみマスタに登録・更新
- 在庫数などは無視

### 5-3. 売上CSVからの新商品検知
- 売上CSV内に存在するがマスタに無い親コードは「新商品候補」へ
- 候補一覧画面でまとめて管理（毎回ポップアップではない）
- ユーザーは「管理中で登録」または「管理外として扱う」を選択可能

---

## 6. ネクストエンジンAPI連携

### 6-1. 接続・認証
- ユーザーがシステム上でNEへの連携許可を行い、APIアクセス権を確立できること。
- NE連携の設定および同期操作は、管理者（マスター権限）のみが実行可能。

### 6-2. 売上データの同期
- **同期方式**: ユーザーによる「対象月」および「販路」の指定同期。
- **取得対象**: NE側で「出荷確定済み」となっている売上実績。
- **データの整合性**: 同一の期間・販路を再度同期した場合、既存の実績データを「上書き（更新）」し、二重計上を防止。
- **管理外商品の扱い**: 商品マスタで「管理外」の型番はスキップ。
- **過去データ同期**: 最大で過去2年前（2024年1月〜）からの同期が可能。1ヶ月ずつの既存同期方式を維持。

### 6-3. 店舗マッピング
- NEの各店舗IDを、Rinori側のどの「販路」として集計するかをユーザーが定義できる。
- **複数選択（N:1）の対応**: 一つの「販路」に対して、複数のNE店舗を紐付け可能。
- 設定画面ではID番号だけでなく「店舗名」も併記。

### 6-4. 型番・マスタ連携
- 取得した売上データは、既存の変換ルール（SKU→親コード）を適用。
- マスタ未登録の商品が検知された場合、既存の「新商品候補」フローに自動で引き渡す。

### 6-5. 計算と保存
- API経由での取得データも、保存時の計算（税込単価から税抜への換算・整数丸め処理等）は現在のCSVアップロード機能と全く同じ基準で行う。
- NEの「受注明細」データに含まれない送料・手数料等の項目は、売上分析の対象外。

### 6-6. UI・通知
- 同期実行中は「処理中」表示（プログレスバー等）。
- 認証切れや通信エラー時は理由を通知。
- 同期結果（実行日時、対象期間、取込件数）を取込履歴と同様に確認可能。
- 個人情報（顧客名・住所等）は本システムのDBには保存しない。

---

## 7. 商品マスタ仕様

### 項目
- 親コード（PK）
- 商品名
- 販売価格（税別）
- 原価（税別）
- 自社 / 仕入フラグ
- 管理ステータス（管理中 / 管理外）
- 商品カテゴリ（NULL許可）
- ASIN（NULL許可、ユニーク制約、商品マスタ編集画面で手動登録、1つのASINは1つの親コードにのみ紐づく（1対1））
- 登録日・更新日

### 商品カテゴリー
- ユーザーが任意のカテゴリー名を設定可能（例: 「フリーズドライ」「調味料」「季節商品」等）
- カテゴリーの表示順序を設定可能
- カテゴリーの有効/無効を切り替え可能
- 1商品1カテゴリー（複数カテゴリーへの同時所属は不可）
- カテゴリー未設定の許容（未分類商品の存在を許容）
- カテゴリー削除時、紐付いていた商品は「未分類」に自動移行
- カテゴリーマスタの編集は管理者（マスター権限）のみ

### 商品のカテゴリー紐付け
- カテゴリー編集画面で、そのカテゴリーに所属する商品を**複数選択**して一括登録
- チェックボックスまたは選択リストで、既存の商品マスタから複数商品を選択可能
- **画面構成**: 左側にカテゴリー一覧（作成・編集・削除）、右側に選択中カテゴリーの所属商品一覧、下部に未所属商品一覧（チェックボックス＋「追加」ボタンで一括登録）

### 挙動
- **管理外の商品**: 売上CSVに存在しても集計に含めない、予算設定画面にも出さない
- **ソート**: 全項目で可能
- **フィルタ**: 自社/仕入、管理中/管理外、カテゴリー（全カテゴリー表示）
- **検索**: 商品名・親コードの部分一致

### 商品マスタCSV出力
- 商品マスタ一覧画面の上部にダウンロードボタンを配置。
- 現在適用されている検索・フィルタ結果を反映した一覧をCSV出力。
- 出力形式: BOM付きUTF-8。
- 出力列: 商品コード、商品名、ASIN、販売価格（税別）、原価（税別）、商品区分、管理ステータス、カテゴリー。

### 警告機能
管理中商品のうち「原価・販売価格など必須項目」が未設定のものがあれば:
- トップページに警告表示
- 不完全マスタ一覧へのリンク

---

## 8. 税率設定
- 初期値: 10%
- 追加形式: 「何年何月から何％」を登録
- 対象年月の税抜換算は、その月に有効な税率を使用

---

## 9. 予算管理

### 9-1. 商品予算（商品×月）
各月ごとに:
- 予算数量（入力）
- 予算売上（販売価格×数量、自動計算／編集可）
- 予算原価（原価×数量、自動）
- 予算粗利（売上−原価、自動）

「管理中」の商品のみ表示。

### 9-2. 商品予算設定画面 (SC-09)

#### 画面構成
- **期間設定エリア**: 開始年月・終了年月を選択、期間ナビゲーター（前月/次月ボタン）で移動可能
  - **初期表示**: 開始年月は「当月」、終了年月は「当月+2ヶ月」（計3ヶ月間）
- **期間合計サマリ（画面上部）**: 全商品の合計売上・合計粗利・粗利率をリアルタイム表示
  - サマリはフィルタ結果に基づいて動的に計算（加重平均粗利率）
- **目標比較表示**: ヘッダーに管理売上予算（目標）・全社商品計画（計画）・乖離額（不足）を表示
- **カテゴリーフィルタ**: カテゴリー列を追加し、カテゴリー名でのフィルタ・ソートが可能
- **商品検索**: 商品コード・商品名の部分一致検索

#### テーブル列構成（左から順に）
1. 商品コード（固定列）
2. 商品名（固定列）
3. カテゴリー（固定列）
4. 期間合計数量（入力欄、固定列）
5. 期間売上（税別）（自動計算、固定列）
6. 期間粗利（自動計算、固定列）
7. 01月〜（自動配分、スクロール）

#### リアルタイム自動計算
**入力パターンA: 期間合計から入力**
1. 期間合計数量を入力（例: 60）
2. → 即座に期間売上・粗利を計算
3. → 月別数量を自動配分（等分、端数は最終月に寄せる）
4. → 画面上部のサマリも更新

**入力パターンB: 月別数量から入力**
1. 任意の月の数量を直接編集
2. → 期間合計数量を自動再計算（全月の合計）
3. → 期間売上・粗利を再計算
4. → サマリ更新

#### 月別数量の自動配分
期間内の月数に応じて数量を等分割（端数は最終月に寄せる）
- 例: 2025-01〜06（6ヶ月）、60個 → 各月10個
- 例: 2025-01〜03（3ヶ月）、100個 → 33, 33, 34（余り1を最終月に加算）

#### 期間合計 vs 月別合計ズレ警告
画面上部で:
- 期間合計数量（入力値）
- 現在の月別合計数量
- ズレ量（+3 / −2など）
をリアルタイム表示。ズレた状態で保存する場合は警告。

#### フィルタ適用時の保存整合性
- 検索やフィルタで表示を絞り込んでいる最中に「保存」を実行しても、非表示になっている他の商品の予算データが消失・リセットされないことを保証する。

#### 未保存変更の破棄防止
- 予算数量（期間合計または月別）を編集した状態で、保存ボタンを押さずに期間ナビゲーターで別の期間へ移動しようとした場合、確認ダイアログを表示する。
  - メッセージ: 「変更が保存されていません。変更を破棄して移動しますか？」
  - 「OK」: 変更を破棄し、新しい期間のデータを取得・表示する。
  - 「キャンセル」: 期間移動を中止し、現在の編集状態を維持する。
- 変更検知ロジック: データ取得直後の各商品の予算データのスナップショットを保持し、現在の状態と比較して差分がある場合を「未保存変更あり」と判定する。
- 保存成功後はスナップショットを更新し、直後の期間移動では確認ダイアログを表示しない。

### 9-3. 管理売上予算（トップダウン目標）(SC-18)
- **概要**: 商品単位の予算とは別に、年月単位で「本来達成すべき売上目標」を保持する。
- **設定単位**: 年月単位 (YYYY-MM)。
- **金額単位**: すべて「税別（税抜）」で管理する。
- **権限管理**: 設定・編集は「管理者 (master)」のみ可能。スタッフは閲覧のみ。
- **計算への影響**: 他の損益計算には一切影響を与えない。あくまで「比較参照用」の数値。
- **データ保持**: データベースに年月と目標金額をペアで保存（`ManagementBudgets` テーブル）。
- **専用設定ページ**: `/settings/management-budget` に年度セレクター、年度全体合計、四半期合計(Q1-Q4)、各月(1-12)の入力欄を配置。
  - 年度/四半期入力時：月別へ自動案分（端数最終月寄せ）。
  - 月別入力時：上位の四半期/年度合計値をリアルタイムに合算。
- **商品予算画面との連動**: 商品予算設定画面のサマリ領域に目標・計画・乖離額を表示。期間に連動して動的に合計。

### 9-4. 広告費予算
- **予算設定画面**: 「広告費管理 > 広告予算設定」タブ。
- 「対象年月」と「有効な広告カテゴリ」ごとに予算額を入力・保存。
- `AdBudget` テーブルに保存。ユニークキー: `(periodYm, adCategoryId)`。
- 広告費入力画面の上部に月間総予算・実績合計・予算残高のサマリを表示（スタッフも閲覧可）。

### 9-5. 期間予算の保持
期間予算そのものを履歴として保存し、後から「なぜこの数字になったのか」を確認できる。

---

## 10. 商品予算 vs 商品実績（進捗管理）(SC-11)

> **メニュー名称**: 「予算vs実績」から「**商品予算vs商品実績**」に変更済み。広告費予算との混同を防止するため。
- 単月／複数月／任意期間を指定可能
- 商品別に: 予算数量、実績数量、数量達成率、予算売上（税別）、実績売上（税別）、売上達成率
- **粗利率**: 予算粗利率と実績粗利率を表示（実績売上が0の場合は `0%` または `-`）
- すべてリアルタイム更新
- **デフォルト期間**: 現在のシステム日付の「先月〜先月」
- **期間ナビゲーション**: 前月/次月ボタンで移動可能

### 0行表示/非表示トグル
- チェックボックス: 「予算・実績がどちらも0の商品の行を非表示にする」
- 初期値: チェックON（非表示）
- チェック状態変更で即座に反映（ページリロード不要）

### グラフ機能
- **グラフタイプ**: 折れ線グラフまたは棒グラフで月次推移を表示（切り替え可能）
- **表示データ**: 予算売上、実績売上、昨年同月実績売上、予算粗利、実績粗利、昨年同月実績粗利、予算数量、実績数量、昨年同月実績数量、達成率（チェックボックスで選択可能）
- **デフォルト表示**: 予算売上、実績売上、達成率
- **表示対象の選択**: 商品別モード（最大5商品比較）/ カテゴリー別モード
- **期間**: デフォルト直近12ヶ月
- **昨年同月実績**: データが存在しない月は描画スキップ
- **販路フィルタ連動**
- **インタラクティブ機能**: ツールチップ、凡例クリックで表示/非表示切り替え
- **配置**: 既存の表の下に開閉トグル付きで配置

---

## 11. PL（損益計算）

### 11-1. 月次PL
表示項目:
- 売上（税別）、原価（税別）、粗利、広告費、営業利益（粗利−広告費）
- 率（％）を必ず併記: 原価率、粗利率、広告率、利益率
- ※スタッフ権限では総合計・率は非表示

### 11-2. 期間PL（任意範囲）

#### 期間選択方式（ラジオボタンで選択）
- **方式1: プリセット期間** - 単月、3ヶ月、6ヶ月、期首〜現在
- **方式2: 任意の期間** - 開始年月（YYYY-MM）〜 終了年月（YYYY-MM）
- **デフォルト期間**: 先月（前月）

#### UI動作
- ラジオボタンで選択した方式のみが有効
- 非選択の方式はグレーアウト（disabled）
- 「表示」ボタンで選択中の方式で期間を決定

#### 販路フィルタ
- 「販路」プルダウンを追加（全販路 + 各販路）
- 全販路: 全売上を対象に集計
- 特定販路: その販路の売上のみ集計

#### 広告費予実比較
- 「広告費」行および「営業利益」行に、実績値に加えて「予算」「差異」「達成率」を表示。
- **広告予算**: その期間の `AdBudget` の合計。
- **営業利益予算**: `(商品予算の粗利合計) − (集計対象期間の広告予算合計)`。
- **差異の解釈**:
  - 広告費: `実績 － 予算`。プラスなら「予算オーバー（赤字表示）」。
  - 営業利益: `実績 － 予算`。プラスなら「予算達成（青字表示）」。
- **達成率**: `実績 ÷ 予算`。予算が0の場合は「`-`」または「`0%`」表示（ゼロ除算回避）。
- **特定販路選択時**: 広告費・営業利益の予実比較項目は非表示。

### 11-3. 商品別PL
商品ごとに: 販売数量、売上（税別）、原価（税別）、粗利、平均単価、原価率（％）、粗利率（％）
- 商品別には広告費配賦しない（将来拡張）
- 販路フィルタ対応
- 期間ナビゲーション（前月/次月ボタン）
- **ソート優先順位**: 商品コード（親コード）の特定の接頭辞に基づき以下の順で表示する。
  1. `RINO-FR` (最優先)
  2. `RINOBG`
  3. `RINO-SY`
  4. その他（昇順）

### 11-4. カテゴリー別PL分析
- カテゴリーごとの売上高、売上原価、粗利、粗利率を集計・表示。
- カテゴリー未設定の商品は「未分類」として別途集計。
- **売上構成比**: `(当該カテゴリー売上 / 全カテゴリー合計売上) * 100`（整数表示）。合計売上が0の場合は `(0%)` または `(-)` と表示し、ゼロ除算を回避する。
- **粗利構成比**: `(当該カテゴリーの粗利 / 全カテゴリー合計粗利) * 100`。合計粗利が0の場合も同様。
- **円グラフ（PieChart）**:
  - ユーザーが選択したカテゴリー（最大5件）を個別スライスとして表示。
  - 残りは「その他」として1つのスライスに集約（合計6スライス）。
  - 「売上構成比」と「粗利構成比」を切り替え可能。
  - 小数点第一位まで表示。
  - 粗利益がマイナスのカテゴリーはグラフ描画から除外し注釈表示。
  - 期間変更や販路フィルタに連動して動的更新。
- **ソート機能**: 各カラム（売上高、粗利、粗利率）でソート可能（デフォルト: 売上高降順）

### 11-5. PL推移グラフ機能
- **グラフタイプ**: 折れ線グラフまたは棒グラフで月次推移を表示（切り替え可能）
- **表示データ**: 売上高、昨年同月実績売上高、粗利、昨年同月実績粗利、営業利益（全体PLのみ）、昨年同月実績営業利益（全体PLのみ）、粗利率（チェックボックスで選択可能）
- **デフォルト表示**: 売上高、粗利、粗利率
- **表示オプション**: 全体PL / 商品別PL（最大5商品）/ カテゴリー別PL
- **期間**: デフォルト直近12ヶ月
- **昨年同月実績**: データが存在しない場合は0または非表示
- **未分類商品**: カテゴリー別グラフでは「未分類」として集計・表示
- **インタラクティブ機能**: ツールチップ、凡例クリックで表示/非表示切り替え
- **配置**: 既存の表の下に開閉トグル付きで配置

### PL画面からの導線
- 月次PL / 期間PL画面に「商品別PLを見る」ボタンまたはリンクを設置。
- 遷移時、現在閲覧している「期間」「販路」条件を引き継ぐ。

---

## 12. 広告費管理

### 画面構成（タブ方式）
- **タブ1: 広告費一覧**
  - 既存の広告費を一覧表示
  - インライン編集（行をクリックして直接編集）
  - 最下行に新規追加行を常に表示
  - 削除ボタン
  - **デフォルト日付**: アクセス当日。表示中の月と現在月が異なる場合は表示月の1日。

- **タブ2: カテゴリ管理**
  - カテゴリ一覧テーブル
  - カテゴリ名の編集（インライン）
  - 新規カテゴリ追加
  - 削除ボタン

- **タブ3: 広告予算設定**
  - 対象年月と有効な広告カテゴリごとに予算額を入力・保存

### 広告費の項目
- 日付（YYYY-MM-DD）
- 金額
- カテゴリ（ドロップダウン選択）
- メモ

### カテゴリマスタ
- カテゴリ名（例: META広告、Google広告、展示会費、アンバサダー）
- 作成日・更新日

---

## 13. 販路マスタ仕様

### 目的
- 売上実績を「販路」単位で集計・分析
- 販路名称の表記ゆれを防止

### 販路マスタテーブル
- id（PK, 自動採番）
- name（販路名）
- is_active（有効フラグ: true=有効、false=非表示）
- created_at, updated_at

### 初期データ
- EC、モール、卸、催事ポップアップ、その他

### 販路マスタ設定画面
- メニュー位置: 「設定 > 販路マスタ」
- 機能: 一覧表示、新規追加、名称編集、有効/非表示切替

---

## 14. 取込履歴管理

売上CSV・商品一覧CSV・広告費CSV・NE API同期 すべてに対し履歴を保存:
- 取込種別、データソース（NE/Amazon/API）、対象年月、モード（追加／上書き）、販路、コメント、取込日時、件数、実行ユーザー

### 取込履歴画面
- メニュー位置: 「売上 > 取込履歴」
- 初期表示: 最新100件
- ページングや検索で過去分を参照可能

### 取込単位での販路変更機能
対象の取込履歴に紐づく全売上レコードの販路を一括変更

### 取込単位での削除機能
対象の取込履歴に紐づく全売上レコードを削除（確認ダイアログあり）

---

## 15. 新商品候補一覧

### タブ構成
- **未登録（保留）タブ**（デフォルト）: `pending` の候補を表示
- **無視リストタブ**: `ignored` ステータスの候補を表示

### 一括操作機能
- **一括管理中登録**: 選択した候補を一括で「管理中」として商品マスタに登録
- **一括管理外登録**: 選択した候補を一括で「管理外」として商品マスタに登録
- **一括無視**: 選択した候補を一括で「無視リスト」に移動
- **一括未登録戻し**: 無視リスト内の候補を選択し、一括で「未登録（pending）」に戻す

---

## 16. 画面一覧

- トップページ（ダッシュボード）
- 売上CSV取込画面（CSV様式ダウンロード・データソース選択付き）
- 商品一覧CSV取込画面
- 新商品候補一覧（タブ方式・一括操作付き）
- 商品マスタ一覧・編集（ASIN列・CSV出力付き）
- 商品カテゴリー管理画面
- 商品予算設定画面（カテゴリーフィルタ・目標比較・未保存変更防止付き）
- 商品予算 vs 商品実績画面（グラフ・粗利率付き）
- 月次／期間PL画面（販路フィルタ・広告費予実比較・グラフ付き）
- 商品別PL画面（販路フィルタ・期間ナビゲーション付き）
- カテゴリー別PL画面（構成比・円グラフ付き）
- 広告費管理画面（タブ方式・インライン編集・広告予算設定付き）
- NE連携設定画面（店舗マッピング・同期実行）
- 販路マスタ設定画面
- 管理売上予算設定画面
- 除外キーワード設定画面
- 税率設定画面
- 取込履歴画面（販路変更・削除機能付き）
- コード変換チェック画面
- アカウント設定画面
- ユーザー管理画面（マスター権限のみ）
- データエクスポート画面（マスター権限のみ）
- データ復元画面（マスター権限のみ）
- 設定一覧画面（`/settings`）

### ダッシュボードメニュー構成
```
商品
  - 商品マスタ管理
  - 商品CSV取込
  - 新商品候補
  - カテゴリー管理

売上
  - 売上CSV取込
  - NE連携同期
  - 取込履歴

予算・PL
  - 予算設定
  - 予算 vs 実績
  - 月次PL
  - 商品別PL
  - カテゴリー別PL

広告費管理

設定
  - 販路マスタ
  - 管理売上予算設定
  - 除外キーワード設定
  - 税率設定
  - アカウント設定
  - ユーザー管理（マスター）
  - データエクスポート（マスター）
  - データ復元（マスター）
```

---

## 17. 期間ナビゲーション共通仕様

### 対象画面
- 商品予算設定画面
- 商品予算 vs 商品実績画面
- 商品別PL分析画面

### UI
- 期間指定表示の左右に `<` `>` ボタンを配置。

### 挙動
- 単月指定の場合: 前月 / 翌月 へ移動。
- 期間指定の場合: 常に **1カ月分** 前後へスライド（例: 10~12月 → 11月~翌1月）。

---

## 18. グラフ共通仕様

### グラフライブラリ
- Recharts（Reactとの親和性が高い）を使用。

### カラーパレット
- 予算売上/売上高: 青系（#3B82F6）
- 実績売上: 緑系（#10B981）
- 予算粗利/粗利: オレンジ系（#F59E0B）
- 実績粗利: 紫系（#8B5CF6）
- 営業利益: 赤系（#EF4444）
- 達成率/粗利率: グレー系（#6B7280）

### レイアウト
- グラフは画面幅いっぱいに表示（レスポンシブ対応）
- 表示項目選択チェックボックスはグラフ上部に配置
- 既存の表の下に開閉トグル付きで配置（表とグラフを同時に確認可能）

### パフォーマンス
- 12ヶ月分のデータを1秒以内に描画
- 大量データ（商品数100以上、期間24ヶ月以上）でも3秒以内に表示

---

## 19. 非機能要件
- ブラウザ: PC版Chromeのみサポート
- 同時アクセス: 想定3名以内
- データ容量: CSV月次運用に耐えれば十分
- バックアップ/ログ: 設計側に委譲（最低限の履歴保持あれば可）
- 個人情報の保護: 分析に不要な顧客名や住所等はDBに保存しない

---

## 20. 将来拡張（設計で潰さない範囲で）
- マルチブランド化（ブランドID追加）
- API連携（広告費自動取込: META / Google 等）
- 日次PL / 日次推移グラフ
- 商品別広告費配賦ロジック
- 期間予算の自動配分アルゴリズム（重み・季節係数）
- 取込履歴単位の部分ロールバック
- グラフのエクスポート機能（PNG/PDF）
- グラフ設定の保存機能（ユーザー設定として保存）

---

**作成日**: 2026-02-09
**対象バージョン**: V1.6（統合版）
**統合元バージョン**: V1.5 〜 V1.581
