# Rinori 売上管理システム 要件定義書 V1.53（差分：予算管理の完遂）

> **注意**: 本書はV1.52からの差分のみを記載しています。完全な要件はV1.5_要件定義書.mdおよび各差分ファイルと併せて参照してください。

## 1. 概要
本バージョン(v1.53)は、商品予算に続き「広告費予算」の管理機能を実装することで、PL（損益）における予実分析を完結させることを目的とする。

## 2. 機能要件

### 2-1. 広告費の月間予算設定機能
**要件**:
1. **予算設定画面**:
   - 画面: 「広告費管理 > 広告予算設定」タブ。
   - 機能: 「対象年月」と「有効な広告カテゴリ（isActive: true）」ごとに予算額を入力・保存できる。
   - 入力方式: 月ごとの直接入力。
2. **データの永続化**:
   - `AdBudget` テーブルに保存。ユニークキー: `(periodYm, adCategoryId)`。

### 2-2. 広告費入力画面での予算表示（権限の更新）
**要件**:
- **表示項目**: 広告費一覧画面（実績入力画面）の上部に、選択中の月のサマリを表示。
  - **月間総予算**: その月の全カテゴリの合計予算。
  - **実績合計**: その月に入力済みの全カテゴリの合計実績。
  - **予算残高**: 総予算 － 実績合計。
- **権限の更新**: 
  - V1.5では「スタッフは総広告費を閲覧不可」としていたが、**本画面のサマリ情報に限り、スタッフ権限でも閲覧可能**とする。（「今月あといくら使えるか」を現場で判断するため）

### 2-3. PL分析画面での予実比較
**要件**:
- **対象画面**: 月次PL画面、期間PL画面。
- **追加項目**: 「広告費」行および「営業利益」行に、実績値に加えて「予算」「差異」「達成率」を表示する。
- **計算定義**:
  - **広告予算**: その期間の `AdBudget` の合計。
  - **営業利益予算**: `(商品予算の粗利合計) － (集計対象期間の広告予算合計)`。
  - **達成率**: `実績 ÷ 予算`。予算が0の場合は「-」または「0%」表示（エラー回避）。
  - **差異の解釈**:
    - **広告費**: `実績 － 予算`。プラスなら「予算オーバー（赤字表示）」、マイナスなら「予算内」。
    - **営業利益**: `実績 － 予算`。プラスなら「予算達成（青字表示）」、マイナスなら「未達成」。
- **販路フィルタ時の挙動**:
  - **「全販路」表示時**: 既存の広告実績、および本件の広告予算・予実比較項目をすべて表示・計算に含める。
  - **「特定販路」選択時**: 既存仕様に合わせ、広告費・営業利益に関する予実比較項目（予算・実績・差異・達成率）はすべて非表示（または "-" 表示）とする。
- **権限**: スタッフ権限は引き続きPL画面（総合計情報）にはアクセス不可。

## 3. データベース変更点
- **`AdBudget` テーブル (新規)**:
  - `id`: PK
  - `periodYm`: String (YYYY-MM)
  - `adCategoryId`: Int (FK to AdCategory)
  - `amount`: Float
  - `createdByUserId`: Int (FK to User) - 登録・更新者
  - `createdAt`, `updatedAt`

## 4. 既存影響と矛盾回避
- **用語の統一**: V1.52で「予算vs実績」を「商品予算vs商品実績」に改称したため、本機能（広告予算）と混同しないようUI上の文言に注意する。
- **権限の例外規定**: 2-2で述べた通り、現場運用のため広告入力画面でのみスタッフへの「総額」公開を許可する。

---
以上
