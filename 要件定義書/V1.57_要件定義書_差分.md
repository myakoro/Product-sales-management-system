# Rinori 売上管理システム V1.57 要件定義 差分案

## 1. 概要
V1.56で実装した可視化機能およびマスタ管理機能を洗練させ、より深い分析と利便性を向上させる。
1. **NE連携の過去データ取得対応**: 過去2年分（2024年1月〜）の同期を可能にする。
2. **カテゴリー分析の強化**: カテゴリー別PLに売上構成比を表示。
3. **商品マスタ・予算管理の操作性向上**: フィルタ、ソート、集計表示の改善。
4. **予算実績管理の項目拡充**: 粗利率の表示。

## 2. 機能要件

### 2-1. ネクストエンジン連携設定 (SC-14) の拡張
- **過去データ同期の期間拡大 (A案: 月別選択範囲の拡張)**:
  - 同期実行時の「対象月」プルダウンの選択肢を拡大する。
  *   選択可能な範囲を、最大で過去2年前（今なら2024年1月）からとする。
  *   1ヶ月ずつ稼働させる既存の同期方式を維持。
  - 大量データのフェッチに伴うタイムアウトや二重登録の防止策（既存ロジックの改善）を継続。

### 2-2. カテゴリー別PL分析 (SC-13) の強化
- **売上構成比（貢献率）の表示**:
  - 表示対象期間における各カテゴリーの売上高の右側に、全体売上に占める割合を表示する。
  - 表示形式: `¥1,234,567 (15%)`
  - 割合の計算: `(当該カテゴリー売上 / 選択期間・選択販路における全カテゴリー合計売上) * 100`
    - ※合計売上には「未分類」の商品の売上高も含める。販路フィルタが適用されている場合は、そのフィルタ後の合計値を分母とする。
  - 小数点は切り捨て、整数表示とする。
  - 割合の対象売上が0の場合は `(0%)` または `(-)` と表示し、エラーを回避する。
  - グラフだけでなく、表形式のデータにも反映する。

### 2-3. 商品マスタ管理 (SC-01/03) の改善
- **カテゴリーフィルタの修正**:
  - 商品マスタ一覧画面の「カテゴリー」フィルタにおいて、マスタに登録されているすべての「有効なカテゴリー」が表示されるように修正する。
  - 「未分類」および「すべて」も引き続き選択可能とする。

### 2-4. 商品予算設定 (SC-09) の拡張
- **カテゴリー別ソートの追加**:
  - 予算設定一覧において、カテゴリー列を追加し、カテゴリー名でのソートを可能にする。
- **動的集計表示（ヘッダーカード）**:
  - 画面上部に表示されている「合計売上高」「合計粗利」「平均粗利率」の数値を、現在のフィルタおよびソート結果に基づいて動的に計算・表示する。
  - **計算ロジック**:
    - 合計値: フィルタ後の全行の単純合計。
    - 平均粗利率: `(フィルタ後の合計粗利 / フィルタ後の合計売上) * 100` の**加重平均**で算出する（各商品の利率の単純算術平均ではない）。
  - これにより、特定のカテゴリーのみを抽出した際の予算合計とそのカテゴリーの目標利率を正確に把握できるようにする。
- **フィルタ適用時の保存整合性**:
  - 検索やフィルタで表示を絞り込んでいる最中に「保存」を実行しても、非表示になっている（フィルタアウトされている）他の商品の予算データが消失・リセットされないことを保証する。

### 2-5. 商品予算 vs 商品実績 (SC-11) の項目追加
- **粗利率の表示**:
  - 予算実績比較の一覧表に「粗利率」列を追加する。
  - 表示項目:
    - **予算粗利率**: 商品マスタおよび予算設定に基づく目標値。
    - **実績粗利率**: `(実績粗利 / 実績売上) * 100` で算出。
  - これにより、目標利率と実利率の乖離を商品単位で確認しやすくする。
  - 実績売上が0の場合は `0%` または `-` と表示し、ゼロ除算を回避する。
  - 表の列数増加に伴い、視認性が低下しないようフォントサイズや列幅、またはテーブルの横スクロール設定を適切に調整する。

### 2-6. 新商品候補一覧の操作性向上 (SC-04)
- **一括操作機能の追加**:
  - 新商品候補一覧において、複数の商品を選択した際の一括操作（バルクアクション）を可能にする。
  - **一括管理中登録**: 選択した候補を一括で「管理中」ステータスとして商品マスタに登録する。
  - **一括管理外登録**: 選択した候補を一括で「管理外」ステータスとして商品マスタに登録する。
  - **一括無視**: 選択した候補を一括で「無視リスト（status: ignored）」に移動する。
  - **一括未登録戻し**: 無視リスト内の候補を選択し、一括で「未登録（status: pending）」に戻す。

---

## 3. 非機能要件

### 3-1. パフォーマンス
- **大量データ同期**:
  - 2年分のデータ同期を実行した際、ブラウザのタイムアウトやサーバー側のメモリ不足を回避するため、適切なバッチ処理または並列処理（NE側制限内）を維持する。

### 3-2. ユーザビリティ
- **視覚的階層**:
  - 構成比の表示（例: 15%）は、メインの金額よりもやや控えめなスタイル（例: 薄いグレー）にし、情報のノイズを抑える。

---

## 4. UI/UX要件

### 4-1. 設定画面
- NE同期セクションに「同期開始年月」を選択するプルダウンを追加。

### 4-2. 予算実績画面
- 表の末尾または適切な位置に「粗利率」列を追加。パーセンテージ表示。

---

## 5. 成功基準

### 5-1. 機能面
- [ ] 2024年1月を指定してNE同期を実行し、データが正しく取り込まれること。
- [ ] カテゴリー別PL画面で、(15%) のような構成比が表示されること。
- [ ] 商品マスタで、全カテゴリーがフィルタに表示されること。
- [ ] 商品予算設定で、カテゴリーフィルタをかけると上部の合計値が連動して変わること。
- [ ] 商品予算vs実績で、粗利率がパーセント表示されること。
- [ ] 新商品候補一覧で、複数選択後に「一括無視」や「管理外登録」が正常に実行されること。

---

**作成日**: 2026-01-09  
**対象バージョン**: V1.57  
**前提バージョン**: V1.56
