Rinori 販売管理システム

要件定義書_V1.4（販路別PL・取込履歴改善）**

変更履歴：
- V1.0: 初版
- V1.1: ユーザー権限追加、SKU変換ルール変更、画面削除
- V1.2: SC-10期間予算編集画面を全商品一覧入力方式に変更
- V1.3: ユーザビリティ改善（SC-09とSC-10統合、SC-14とSC-15統合、SC-03一括選択追加）
- V1.4: 販路別PL対応、取込履歴・販路マスタ・予算vs実績0行フィルタ追加

0. 本書について（V1.4 追加分）

本書は「Rinori 売上管理システム 要件定義書_V1.3（完全版）」を前提とし、
V1.4 で追加・変更される要件のみを追記するドキュメントである。

基本仕様・画面一覧・非機能要件などの全体像は V1.3 版を参照し、
本書では V1.4 での拡張・変更点（販路別PL・取込履歴改善・予算vs実績表示オプション）を定義する。


1. V1.4 で追加・変更されるテーマ一覧

1-1. 販路別PL対応

- 売上CSV取込時に「販路」を必須選択できるようにする。
- 販路マスタを新設し、PL画面・商品別PL画面で「販路別」の集計・絞り込みができるようにする。

1-2. 取込履歴の運用改善

- 売上CSV取込履歴から、過去に取り込んだデータを「販路変更」または「削除」できるようにする。
- 取込履歴に「備考／コメント」を表示し、対象を特定しやすくする。

1-3. 予算 vs 実績：0行の表示／非表示切替

- 「予算も実績も 0」の商品行を、画面上のチェックボックスで表示／非表示切替できるようにする。
- デフォルトは「非表示 ON」とする。

1-4. 取込履歴の一覧表示・保持方針

- 取込履歴は基本的に無期限に保持し、削除はユーザーの操作によって行う。
- 画面表示は最新 100 件を初期表示とし、ページングや検索で過去分を参照できるようにする。


2. 販路マスタ仕様（新規）

2-1. 目的

- 売上実績を「販路」単位で集計・分析できるようにするため、
  テキスト自由入力ではなく、マスタ管理された「販路」を用意する。
- 販路名称の表記ゆれを防ぎ、PL・商品別PL・取込履歴などで安定した集計軸を提供する。

2-2. 販路マスタテーブル

● 項目（例）

- id（PK, 自動採番）
- name（販路名、例：EC／モール／卸／催事ポップアップ／その他）
- is_active（有効フラグ: true=有効、false=非表示）
- created_at（作成日時）
- updated_at（更新日時）

2-3. 初期データ

V1.4 初期リリース時点で、以下の販路をマスタに登録しておく。

- EC
- モール
- 卸
- 催事ポップアップ
- その他

2-4. 販路マスタ設定画面

● 画面位置

- メニュー: 「設定 > 販路マスタ」

● 機能概要

- 販路一覧表示
  - 表示項目: 販路名、状態（有効／非表示）、作成日時、更新日時
- 新規販路追加
  - 入力: 販路名
  - 作成時は is_active=true（有効）で登録
- 販路名の編集
  - 既存販路の名称を変更可能
- 有効／非表示フラグの切替
  - is_active を true/false で切り替え可能
  - false（非表示）の販路は、今後のプルダウンには出さないが、過去データは残す

● 制約

- 過去の売上が紐づいている販路については、原則として物理削除しない。
  - 過去実績の集計に影響を与えないため。
  - 実装としては「非表示フラグ（is_active=false）」で対応する。


3. 売上CSV取込と販路の紐づけ（V1.4 追加）

3-1. 入力項目の拡張

V1.3 時点の「5-1. 売上CSV（NE）取込」に、以下の項目を追加する。

● アップロード前に必須選択する項目（拡張）

- 対象年月（YYYY-MM）       ※既存
- 取込モード（追加／上書き） ※既存
- コメント（任意）           ※既存
- 販路（必須）【V1.4 追加】
  - 入力形式: プルダウン
  - 選択肢: 販路マスタのうち is_active=true のもの
  - 未選択の状態では「取込開始」ボタンを押せない（バリデーションエラーとする）。

● 備考／コメント

- 既存の「コメント」欄を、売上CSV取込履歴に紐づく「備考」として保存する。
- 例: 「2025/12/01〜2025/12/07 売上（楽天）」 など。

3-2. 売上レコードへの保存仕様

- 売上レコード（sales_records 相当）に、以下のカラムを追加する。
  - sales_channel_id（販路マスタの id を参照）

- 1つの CSV 取込につき、選択された販路は 1つである前提とする。
  - 当該 CSV から生成されるすべての売上レコードに、同じ sales_channel_id を設定する。

- 取込モードが「上書き」の場合も、更新後の売上レコードには選択された販路を設定する。

3-3. 取込履歴への保存仕様（拡張）

- 12. 取込履歴管理の項目を拡張し、以下を保存する。
  - 販路（sales_channel_id）
  - コメント（備考テキスト）

- 取込履歴画面では、
  - 販路名（マスタ名）
  - コメント（例: 「12/1〜12/7 売上」）
  を一覧上に表示し、ユーザーがどの期間・どの販路の取込かを判断しやすくする。


4. PL画面・商品別PL画面の販路別集計（V1.4 追加）

4-1. 合計PL画面（SC-12: PL画面）の拡張

● 目的

- 現状は「全販路合算」の PL を表示しているが、V1.4 では「販路別」の PL を確認できるようにする。

● 画面仕様（拡張）

- 期間選択エリアの近くに、「販路」プルダウンを追加する。

  - 項目名: 販路
  - 選択肢:
    - 全販路
    - 販路マスタの is_active=true のすべての販路
  - 初期値: 「全販路」

- 集計ロジック

  - 「全販路」選択時:
    - 既存通り、全ての sales_records を対象に月次PL／期間PLを計算する。

  - 特定の販路を選択時:
    - sales_channel_id が選択された販路のレコードのみを対象に、売上・原価・粗利・広告費・営業利益等を集計する。

- 権限制御

  - V1.3 時点の権限制御（スタッフ権限には総合計を非表示等）はそのまま適用する。

4-2. 商品別PL画面（SC-13: 商品別PL）の拡張

● 目的

- 商品別PLを「販路別」に確認し、どの販路のどの商品が好調／不調かを把握できるようにする。

● 画面仕様（拡張）

- 期間選択エリアの近くに、「販路」プルダウンを追加する。

  - 項目名: 販路
  - 選択肢:
    - 全販路
    - 販路マスタの is_active=true のすべての販路
  - 初期値: 「全販路」

- 集計ロジック

  - 「全販路」選択時:
    - 既存通り、全ての sales_records を対象に商品別PLを計算する。

  - 特定の販路を選択時:
    - sales_channel_id が選択された販路のレコードのみを対象に、
      販売数量・売上（税別）・原価（税別）・粗利・平均単価・原価率・粗利率を集計する。

- ソート・表示仕様

  - 既存のソート仕様（商品コードの優先順: RINO-FR → RINOBG → RINO-SY → その他）は維持する。
  - 販路フィルタは、データ取得段階またはフロント側のフィルタで適用し、
    その後にソート処理を行う。


5. 予算 vs 実績画面の 0行表示／非表示トグル（V1.4 追加）

5-1. 目的

- 予算も実績も 0 の商品行は、一覧としてはノイズになりやすい。
- 一方で、必要に応じて「0の行も含めて全体を確認したい」ケースもある。
- そのため、ユーザーが画面上で「0行の表示／非表示」を即座に切り替えられるようにする。

5-2. 画面仕様（SC-11: 予算 vs 実績一覧 の拡張）

● チェックボックス追加

- 予算 vs 実績一覧テーブルの上部に、以下のチェックボックスを追加する。

  - ラベル: 「予算・実績がどちらも0の商品の行を非表示にする」
  - 初期値: チェック ON（非表示）

● 挙動

- チェック ON（デフォルト）:
  - 以下の条件をすべて満たす商品行を一覧から除外する。
    - 予算数量 = 0
    - 実績数量 = 0
    - 予算売上（税別） = 0
    - 実績売上（税別） = 0
  - 集計そのもの（合計行やサマリ）のロジックは変更しない（必要に応じて実装側判断）。

- チェック OFF:
  - 条件にかかわらず、すべての商品行を表示する。

- フィルタの適用タイミング:
  - 画面上でチェック状態を変更したタイミングで即座に反映される（ページリロード不要）。


6. 取込履歴画面の拡張（販路変更・削除／備考表示）（V1.4 追加）

6-1. 目的

- 「誤った販路で CSV を取り込んでしまった」「2回前の取込が間違っていたのでやり直したい」といったケースで、
  すべてを再取込するのは手間がかかる。
- そのため、過去の取込単位で「販路を変更する」「まるごと削除する」ことができるようにする。
- また、備考コメント（例: 12/1〜12/7売上）を見ながら対象を特定しやすくする。

6-2. 取込履歴画面のメニュー位置

- メインメニューの「売上」配下に以下を配置する。
  - 売上CSV取込
  - 取込履歴（SC-04）

6-3. 取込履歴一覧の表示項目

- 表示項目（例）:
  - 取込日時
  - 取込種別（売上CSV / 商品一覧CSV / 広告費CSV など）
  - 対象年月
  - 取込モード（追加／上書き）
  - 販路（V1.4 追加）
  - コメント／備考（V1.4 追加）
  - 件数
  - 実行ユーザー
  - 操作（販路変更／削除）

- 一覧表示の初期状態:
  - 最新の取込履歴から 100 件を表示
  - それ以前はページングまたは絞り込み条件で参照可能とする（実装側詳細に委譲）。

6-4. 取込単位での販路変更機能

● 操作フロー

1. ユーザーが「取込履歴」画面を開く。
2. 対象の行の「販路」列や「備考」「対象年月」を確認し、誤っている取込を特定する。
3. 行末の「販路変更」ボタンをクリックする。
4. ダイアログが開き、新しい販路をプルダウンで選択する。
5. 「保存」または「変更を実行」ボタンで確定する。

● 挙動

- 対象の取込履歴レコードに紐づいている、すべての売上レコードの sales_channel_id を、
  新しく選択された販路の id に一括更新する。
- 注意点:
  - `period_ym` や `sales_date` など、年月・日付に関する情報は変更しない。
  - あくまで「どの販路として扱うか」のみを変更する。

6-5. 取込単位での削除機能

● 操作フロー

1. ユーザーが「取込履歴」画面を開く。
2. 対象の行の「備考」「対象年月」「販路」などを確認し、削除したい取込を特定する。
3. 行末の「この取込を削除」ボタンをクリックする。
4. 「この取込に紐づく売上データがすべて削除されます。よろしいですか？」
   といった確認ダイアログを表示し、ユーザーが OK を押した場合のみ実行する。

● 挙動

- 対象の取込履歴レコードに紐づいている、すべての売上レコードを削除する。
- 取込履歴レコード自体については、実装判断で以下のいずれかとする。
  - 物理削除する
  - 「削除済み」フラグを立てて非表示とする
- 削除実行後、月次PL・商品別PL・予算 vs 実績などの集計結果は、
  売上データの削除を反映した状態に自動更新される。


7. 取込履歴の保持ポリシー（V1.4 確認）

- 取込履歴は、基本的に無期限に保持する。
- 過去の取込をもとに販路変更・削除などの操作を行う前提であるため、
  自動削除は行わず、不要となった履歴はユーザー操作（削除機能）により整理する。
- 画面表示のパフォーマンス確保のため、
  - 初期表示は最新 100 件とし、
  - ページングや検索条件（期間・販路・コメントキーワードなど）で過去分を参照する運用とする。


以上
