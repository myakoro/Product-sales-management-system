# Rinori 売上管理システム V1.58 要件定義 差分案

## 1. 概要
V1.57で向上させた分析機能・操作性をベースに、経営的なトップダウン目標の管理機能と、カテゴリー分析の視覚化を強化する。
1. **管理売上予算（マスター予算）管理**: 商品積み上げではない、上位の売上目標を設定・比較可能にする。
2. **カテゴリーPLの粗利構成比表示**: 売上だけでなく、粗利に対しても全体に占める比率を表示。
3. **カテゴリーPLの円グラフ視覚化**: 構成比を一目で把握できるよう、動的な円グラフを追加。

## 2. 機能要件

### 2-1. 管理売上予算（マスター予算）の設定 (新設: SC-18)
- **概要**: 商品単位の予算とは別に、年月単位で「本来達成すべき売上目標」を保持する。
- **設定単位**: 年月単位 (YYYY-MM)。
- **金額単位**: すべて「税別（税抜）」で管理する。
- **権限管理**: 設定・編集は「管理者 (master)」のみ可能とする。
- **計算への影響**:
  - 本システム内の他の損益計算（実績PL、商品別利率など）には一切影響を与えない。あくまで「比較参照用」の数値として扱う。
- **データ保持**:
  - データベースに年月と目標金額をペアで保存する（例: `ManagementBudgets` テーブル）。

### 2-2. 予算設定画面における目標比較 (SC-09 拡張)
- **比較表示**:
  - 商品予算設定画面のヘッダー（サマリ領域）に、以下の情報を追加表示する。
    - **管理売上予算 (目標)**: 設定画面で入力された、表示期間内の目標合計値。
    - **累積商品予算 (計画)**: 現在入力されている各商品の予算合計値。
    - **乖離額 (過不足)**: `目標 - 計画` の差額。乖離が大きい場合に視覚的に強調（例: 赤字表示など）する。
- **期間連動**:
  - 予算設定画面で選択されている期間（月、四半期、年間など）に応じて、管理売上予算も動的に合計・表示する。
  - 例: 4-6月の四半期が表示されていれば、目標も4-6月の3ヶ月合計と比較する。
- **未保存変更の破棄防止【V1.581追加】**:
  - 予算数量を編集済みかつ未保存の状態で、期間ナビゲーターにより別の期間へ移動しようとした場合、確認ダイアログを表示する。
  - ユーザーが「OK」を選択した場合のみ変更を破棄して移動し、「キャンセル」を選択した場合は移動を中止して編集状態を維持する。
  - 保存完了後は変更なしの状態にリセットし、確認ダイアログを表示しない。

### 2-3. カテゴリー別PL分析 (SC-13) の強化
- **粗利構成比の表示**:
  - V1.57で実装した「売上構成比」と同様に、「粗利構成比 (%)」を表示する。
  - 計算式: `(当該カテゴリーの粗利 / 全カテゴリー合計粗利) * 100`
  - 売上高の比率と並べて表示することで、どのカテゴリーが利益に貢献しているかを明確にする。

- **構成比の円グラフ表示**:
  - カテゴリー別PL画面に、構成比を視覚化した円グラフ（Pie Chart）を追加する。
  - **表示項目**: 「売上構成比」と「粗利構成比」を切り替えて表示可能な UI とする。
  - **表示ルール**:
    - **選択カテゴリーの優先表示**: ユーザーが比較対象として選択しているカテゴリー（最大5つ）を個別のスライスとして表示。
    - **その他 (Others) の集約**: 選択されていない残りの全カテゴリーを合算し、「その他」として1つのスライスにまとめる。
    - **最大スライス数**: 選択5カテゴリー + その他1つ = 合計6スライスで構成。
    - **精度**: 小数点第一位まで表示し、端数処理により合計が100%にならない場合は「その他」で調整または各項目の数値をそのまま表示する。
    - **動的更新**: 期間変更や販路フィルタに連動してグラフ形状を更新する。

## 3. 非機能要件
- **ユーザビリティ**:
  - 円グラフの「その他」スライスには、集約された全カテゴリーの合計値と比率を合算して表示する。

## 4. UI/UX要件
- **管理売上予算の設定**: 「設定 > 管理予算設定」等のメニューを新設、または既存の設定画面に編集フォームを追加。
- **損益分析画面**: 従来の折れ線/棒グラフに加え、円グラフへの切り替え、または併記ボタンを設置。

## 5. 成功基準
- [ ] 2026年4-6月の各月に「管理売上予算」を設定し、商品予算画面でその3ヶ月合計が正しく表示されること。
- [ ] 累積商品予算との差額（乖離）がリアルタイムに計算・表示されること。
- [ ] カテゴリー別PLのテーブルで、粗利構成比 (%) が正しく表示されること。
- [ ] カテゴリー別PL画面で、選択した5カテゴリーと「その他」に集約された円グラフ（売上/粗利切り替え）が表示されること。

---
**作成日**: 2026-02-03  
**対象バージョン**: V1.58  
**前提バージョン**: V1.57
