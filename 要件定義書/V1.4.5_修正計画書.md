# Rinori 販売管理システム V1.4.5 修正計画書

## 📋 計画概要

**目的**: 要件定義書 V1.3/V1.4 に完全準拠した状態に戻す  
**バージョン**: V1.4.5（V1.4の修正版）  
**作成日**: 2025-12-15  
**実装予定**: ユーザー承認後

---

## 🎯 修正方針

### 基本方針
1. **要件定義書V1.3/V1.4を絶対基準とする**
2. **未実装機能を優先的に実装**
3. **仕様相違箇所を要件に合わせて修正**
4. **過剰実装は要件に統合または削除**
5. **seed.jsの初期データを本番DBに反映**

### 作業の優先順位
- **Phase 1**: 緊急対応（ユーザーが困っている機能）
- **Phase 2**: 仕様適合（要件定義書との整合性）
- **Phase 3**: データ整合性（seed.js反映、マイグレーション）

---

## 📦 Phase 1: 緊急対応（優先度: 最高）

### 1-1. CSV様式ダウンロード機能の追加

#### 目的
手動でCSVを作成するユーザー向けに、正しい様式を提供する。

#### 実装内容

**1. サンプルCSVファイルの作成**
- ファイル: `public/templates/sales_template.csv`
- エンコーディング: **Shift-JIS**（要件定義書に明記）
- 内容:
  ```csv
  商品コード,受注数,売上金額（税込）,商品名
  RINO-FR010-X-BLK,10,50000,サンプル商品1
  RINODO002BLK,5,25000,サンプル商品2
  ```

**2. ダウンロードボタンと取込履歴リンクの追加**
- 場所: `/import/sales` 画面の上部
- 位置: ファイル選択エリアの上
- UI:
  ```
  ┌─────────────────────────────────────────────────┐
  │ 📥 CSV様式をダウンロード                        │
  │ ネクストエンジン以外で手動作成する場合は、      │
  │ この様式に従ってください                        │
  │ [CSV様式ダウンロード] ボタン                    │
  │                                                 │
  │ 📋 過去の取込履歴を確認・修正する               │
  │ [取込履歴を見る] リンク → /import/history       │
  └─────────────────────────────────────────────────┘
  ```

**3. ダウンロード処理**
- Next.jsの `public/` フォルダから直接配信
- または、API経由でShift-JIS変換して配信

#### 修正ファイル
- `public/templates/sales_template.csv` (新規作成)
- `src/app/import/sales/page.tsx` (修正)

---

### 1-2. 広告費の編集・削除機能の実装

#### 目的
V1.3要件「インライン編集」を実装し、登録後のデータ修正を可能にする。

#### 実装内容

**1. API拡張**
- `src/app/api/ad-expenses/route.ts`
  - **PUT**: 既存広告費の編集
  - **DELETE**: 広告費の削除

**2. フロントエンド修正**
- `src/app/ad-expenses/page.tsx`
  - テーブル行にホバーで「編集」「削除」ボタン表示
  - 編集モード: インライン編集（行内で直接編集）
  - 削除: 確認ダイアログ後に削除

**3. UI仕様**
```
┌──────────────────────────────────────────────────┐
│ 日付       │ カテゴリ  │ 金額    │ メモ │ 操作 │
├──────────────────────────────────────────────────┤
│ 2025-12-01 │ Meta広告  │ 50,000  │ ... │ ✏️ 🗑️ │ ← ホバーで表示
│ 2025-12-02 │ Google広告│ 30,000  │ ... │      │
└──────────────────────────────────────────────────┘
```

#### 修正ファイル
- `src/app/api/ad-expenses/route.ts` (修正)
- `src/app/ad-expenses/page.tsx` (修正)

---

### 1-3. ダッシュボードメニューの再構成

#### 目的
要件定義書V1.4に従い、「売上」カテゴリ配下に関連機能を配置。

#### 実装内容

**1. メニュー構造の変更**
```
現状（フラット構造）:
- 商品マスタ管理
- 商品CSV取込
- 売上CSV取込
- 予算設定
- 予算 vs 実績
- PL確認
- 広告費管理
- 税率設定
- アカウント設定
- ユーザー管理（マスター）
- データエクスポート（マスター）
- データ復元（マスター）

↓

修正後（カテゴリ構造）:
📦 商品
  - 商品マスタ管理
  - 商品CSV取込
  - 新商品候補

💰 売上
  - 売上CSV取込
  - 取込履歴 ← 追加

📊 予算・PL
  - 予算設定
  - 予算 vs 実績
  - 月次PL
  - 商品別PL

📢 広告費管理

⚙️ 設定
  - 販路マスタ ← 追加
  - 税率設定
  - アカウント設定
  - ユーザー管理（マスター）
  - データエクスポート（マスター）
  - データ復元（マスター）
```

**2. UI実装**
- `src/app/page.tsx` のナビゲーションメニューを階層構造に変更
- アコーディオンまたはグループ化されたカード表示

#### 修正ファイル
- `src/app/page.tsx` (修正)

---

### 1-4. 取込履歴の削除ボタン表示確認

#### 問題
ユーザー報告: 本番環境で取込履歴の削除ボタンが表示されていない。

#### 原因分析
1. **権限チェック**: コードでは `isMaster &&` で削除ボタンを条件表示
   - スタッフ権限でログインしている場合は表示されない（仕様通り）
2. **本番環境のコード**: ローカルには実装されているが、本番にデプロイされていない可能性

#### 実装内容

**1. 現状確認**
- `/import/history` 画面のコードを確認
- 削除ボタンは206-211行目に実装済み
- マスター権限のみ表示される仕様

**2. 確認項目**
- ユーザーがマスター権限でログインしているか確認
- 本番環境のコードが最新か確認
- ビルド・デプロイが正しく行われているか確認

**3. 必要に応じた対応**
- 本番環境への再デプロイ
- または、権限表示ロジックの見直し（要件確認）

#### 修正ファイル
- なし（確認作業のみ、必要に応じて再デプロイ）

---

## 🔧 Phase 2: 仕様適合（優先度: 高）

### 2-1. 広告費管理画面のタブ統合

#### 目的
V1.3要件「タブ1: 広告費一覧、タブ2: カテゴリ管理」に準拠。

#### 実装内容

**1. タブUIの実装**
- `src/app/ad-expenses/page.tsx` をタブ構成に変更
- タブ1: 広告費一覧（現状の画面）
- タブ2: カテゴリ管理（`/settings/ad-categories` の内容を移植）

**2. カテゴリ管理の統合**
- `/settings/ad-categories` のコンポーネントを `/ad-expenses` に統合
- API は共通（`/api/ad-categories`）を使用

**3. 旧画面の削除**
- `src/app/settings/ad-categories/page.tsx` を削除
- または、リダイレクトを設定

#### 修正ファイル
- `src/app/ad-expenses/page.tsx` (大幅修正)
- `src/app/settings/ad-categories/page.tsx` (削除またはリダイレクト化)

---

### 2-2. 期間PL画面の期間選択方式の確認・修正

#### 目的
V1.3要件「ラジオボタンで方式選択、非選択はグレーアウト」に準拠。

#### 実装内容

**1. 現状確認**
- `/pl/monthly` または `/pl` 画面の期間選択UIを確認
- 要件通りか検証

**2. 必要に応じて修正**
- ラジオボタン方式の実装
- プリセット期間（単月/3ヶ月/6ヶ月/期首〜現在）
- 任意期間（開始年月〜終了年月）
- 非選択方式のdisabled処理

#### 修正ファイル
- `src/app/pl/monthly/page.tsx` または該当画面（要確認）

---

### 2-3. 予算vs実績の0行フィルタラベルの確認

#### 目的
V1.4要件のラベル文言に準拠。

#### 実装内容

**1. 現状確認**
- `/budget/vs-actual` のチェックボックスラベルを確認

**2. 要件通りに修正**
- ラベル: 「予算・実績がどちらも0の商品の行を非表示にする」

#### 修正ファイル
- `src/app/budget/vs-actual/page.tsx` (要確認・修正)

---

## 💾 Phase 3: データ整合性（優先度: 高）

### 3-1. seed.jsの初期データを本番DBに反映

#### 問題
`seed.js` にはデータが定義されているが、本番DBに反映されていない。

#### 原因分析
1. `npm run seed` または `npx prisma db seed` が実行されていない
2. `package.json` に seed スクリプトが定義されていない可能性

#### 実装内容

**1. package.jsonの確認・修正**
```json
{
  "prisma": {
    "seed": "node prisma/seed.js"
  }
}
```

**2. seedコマンドの実行**
```bash
npx prisma db seed
```

**3. 反映確認**
- 販路マスタに5件（EC, モール, 卸, 催事ポップアップ, その他）が存在するか確認
- 広告費カテゴリに4件（Meta広告, Google広告, アフィリエイト, その他）が存在するか確認

#### 修正ファイル
- `package.json` (確認・修正)
- 実行コマンド: `npx prisma db seed`

---

### 3-2. 既存データとの整合性確保

#### 問題
既に本番DBに何らかのデータが存在する可能性。

#### 実装内容

**1. upsert処理の確認**
- `seed.js` は既に `upsert` を使用しているため、重複登録は発生しない
- ただし、既存データと名称が異なる場合は追加される

**2. データクリーンアップ（必要に応じて）**
- 重複した販路・カテゴリがあれば手動で統合
- または、マイグレーションスクリプトで自動統合

#### 修正ファイル
- なし（手動作業またはマイグレーションスクリプト作成）

---

## 🗑️ Phase 4: 過剰実装の整理（優先度: 中）

### 4-1. 広告費カテゴリ管理の独立画面の削除

#### 対応
Phase 2-1で `/ad-expenses` にタブ統合するため、`/settings/ad-categories` は削除。

---

### 4-2. isActive機能の扱い

#### 判断
- **販路マスタ**: isActive は V1.4 要件に明記されている → **維持**
- **広告費カテゴリ**: 要件には削除機能のみ記載 → **判断保留**

#### 推奨
広告費カテゴリの isActive は、販路マスタとの一貫性のため**維持**を推奨。
ただし、要件に明記されていないため、ユーザーに確認。

---

## 📋 実装チェックリスト

### Phase 1: 緊急対応
- [ ] 1-1. CSV様式ダウンロード機能
  - [ ] `public/templates/sales_template.csv` 作成
  - [ ] `/import/sales` にダウンロードボタン追加
- [ ] 1-2. 広告費の編集・削除機能
  - [ ] API: PUT/DELETE エンドポイント追加
  - [ ] フロントエンド: インライン編集UI実装
- [ ] 1-3. ダッシュボードメニュー再構成
  - [ ] カテゴリ構造の実装
  - [ ] 取込履歴・販路マスタへのリンク追加

### Phase 2: 仕様適合
- [ ] 2-1. 広告費管理のタブ統合
  - [ ] タブUI実装
  - [ ] カテゴリ管理の統合
  - [ ] 旧画面の削除
- [ ] 2-2. 期間PL選択方式の確認・修正
- [ ] 2-3. 予算vs実績ラベルの確認・修正

### Phase 3: データ整合性
- [ ] 3-1. seed.js反映
  - [ ] package.json確認
  - [ ] `npx prisma db seed` 実行
  - [ ] データ反映確認
- [ ] 3-2. 既存データ整合性確保

### Phase 4: 過剰実装整理
- [ ] 4-1. 独立画面削除（Phase 2-1で対応）
- [ ] 4-2. isActive機能の扱い（ユーザー確認）

---

## 🧪 検証計画

### 検証項目
1. **CSV様式ダウンロード**
   - ダウンロードボタンが表示されるか
   - ダウンロードしたCSVがShift-JISか
   - 様式が正しいか

2. **広告費編集・削除**
   - 編集ボタンでインライン編集できるか
   - 削除ボタンで削除できるか
   - API呼び出しが正しいか

3. **ダッシュボードメニュー**
   - カテゴリ構造が表示されるか
   - 取込履歴・販路マスタにアクセスできるか

4. **広告費管理タブ**
   - タブ切り替えが動作するか
   - カテゴリ管理がタブ2で動作するか

5. **seed.js反映**
   - 販路マスタに5件存在するか
   - 広告費カテゴリに4件存在するか

---

## 📝 実装後の確認事項

### ユーザーへの確認
1. **広告費カテゴリのisActive機能**
   - 削除機能に戻すか、isActiveを維持するか

2. **期間PL画面**
   - 現状の実装で問題ないか

3. **その他の要件**
   - 見落としている要件がないか

---

## 🚀 リリース手順

1. **開発環境での実装・テスト**
2. **ビルド確認** (`npm run build`)
3. **seed.js実行** (`npx prisma db seed`)
4. **ユーザーによる受け入れテスト**
5. **本番環境へのデプロイ**
6. **本番DBへのseed.js実行**（必要に応じて）

---

## 📌 注意事項

### 破壊的変更
- `/settings/ad-categories` の削除（ブックマークがあれば無効化）
- 広告費一覧のUI変更（タブ化）

### データ影響
- seed.js実行による初期データ追加（既存データには影響なし）

### 後方互換性
- API エンドポイントは変更なし（追加のみ）
- データベーススキーマ変更なし

---

以上
