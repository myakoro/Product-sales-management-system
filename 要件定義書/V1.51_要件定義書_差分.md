# Rinori 売上管理システム 要件定義書 V1.51（差分版）

> **注意**: 本書はV1.5からの差分のみを記載しています。完全な要件はV1.5_要件定義書.mdと併せて参照してください。

## 変更履歴
- V1.0〜V1.5: 省略（V1.5_要件定義書.md参照）
- V1.51: Amazon CSV取込対応

---

## 1. V1.51 概要

### 1-1. 目的
売上CSV取込機能において、**Amazon Business Report（CSV）** を取り込み可能にする。
これにより、ネクストエンジン（NE）経由の売上だけでなく、Amazonセラーセントラルから直接ダウンロードした売上データも一元管理できる。

### 1-2. スコープ
- Amazon CSV取込機能の追加
- 商品マスタへのASIN列追加
- 取込画面UIの拡張（データソース選択）
- 取込履歴へのデータソース記録

### 1-3. スコープ外
- NE API連携（将来バージョンで対応予定）
- Amazon API連携

---

## 2. 機能要件

### 2-1. Amazon CSV取込

#### 対応CSVフォーマット
- **レポート種別**: Amazon Business Report（ビジネスレポート）
- **エンコーディング**: UTF-8 / Shift-JIS（既存の自動判別ロジックを適用）

#### 使用する列
| Amazon CSV列名 | 用途 | 備考 |
|---|---|---|
| （親）ASIN | 商品コードへの変換キー | 商品マスタのASIN列と照合 |
| タイトル | 警告表示用 | 未登録ASIN表示時に使用 |
| 注文された商品点数 | 受注数 | **B2B列は使用しない** |
| 注文商品の売上額 | 売上金額（税込） | **B2B列は使用しない**、税率設定に基づき税抜換算 |

#### B2B売上の扱い
- **通常売上（B2Bなし列）のみを取込対象とする**
- 「注文された商品点数 - B2B」「注文商品の売上額 - B2B」列は無視する

#### Amazon固有フォーマット対応
- 数値のカンマ区切り（例: `"3,805"`）を適切にパース
- 円記号付き金額（例: `"￥262,240"`）を適切にパース

#### データ変換ルール
- **ASIN → 親コード変換**: 商品マスタに登録されたASINを照合し、対応する親コード（productCode）を取得
- **税抜換算**: 「注文商品の売上額」は税込のため、NEと同様に税率設定に基づき税抜換算（HALF UP）
- **原価・粗利**: 親コードに紐づく商品マスタから原価を取得し、粗利を自動計算

### 2-2. 商品マスタ拡張

#### 追加項目
| 項目名 | 型 | NULL許可 | 説明 |
|---|---|---|---|
| ASIN | 文字列 | 許可 | Amazon（親）ASINコード。1商品に対し1つのASINを登録可能 |

#### 運用
- ASINは商品マスタ編集画面で手動登録
- 1つのASINは1つの親コードにのみ紐づく（1対1）
- 複数商品に同じASINは登録不可（ユニーク制約）

### 2-3. 取込画面UI拡張

#### データソース選択
売上CSV取込画面に「データソース」プルダウンを追加：
- **NE (CSV)**: 従来のネクストエンジン形式（デフォルト）
- **Amazon (CSV)**: Amazon Business Report形式

#### 選択による動作切替
| 項目 | NE (CSV) | Amazon (CSV) |
|---|---|---|
| 商品コード列 | 商品コード（SKU） | （親）ASIN |
| 数量列 | 受注数 | 注文された商品点数 |
| 売上金額列 | 売上金額（税込） | 注文商品の売上額 |
| コード変換 | SKU→親コード変換ルール | ASIN→親コード（マスタ照合） |

#### その他の入力項目（変更なし）
- 対象年月（YYYY-MM）
- 販路（必須）
- 取込モード（追加/上書き）
- コメント（任意）

### 2-4. 未登録ASINの取扱い

#### 取込前警告表示
Amazon CSVに含まれるASINが商品マスタに登録されていない場合：
1. 取込実行前に警告ダイアログを表示
2. 未登録ASINの一覧を表示（**ASIN + タイトル** を併記）
3. ユーザーが「続行」を選択すると、未登録ASINの行をスキップして取込を実行
4. ユーザーが「キャンセル」を選択すると、取込を中止

#### 重要な仕様
- **未登録ASINは「新商品候補」として登録しない**
- 商品マスタへのASIN登録は、事前に手動で行う運用とする
- 取込結果画面で「○件スキップしました（未登録ASIN）」と表示

### 2-5. 取込履歴の拡張

#### データソースの記録
取込履歴（ImportHistory）に「データソース」を追加で記録する：
- **NE**: ネクストエンジンCSV
- **Amazon**: Amazon Business Report CSV

#### 取込履歴画面での表示
- 一覧にデータソース列を追加
- 後から「この取込はどのソースだったか」を確認可能

---

## 3. 画面一覧（V1.51での変更）

| 画面 | 変更内容 |
|---|---|
| 売上CSV取込画面 | 「データソース」プルダウン追加、未登録ASIN警告ダイアログ追加 |
| 商品マスタ一覧・編集 | ASIN列の表示・編集機能追加 |
| 取込履歴画面 | データソース列を追加表示 |

---

## 4. 将来拡張への配慮

データソース選択UIは、将来的に以下の拡張を想定した設計とする：
- NE API連携（自動取込）
- Amazon API連携
- その他販路のCSV/API対応

---

## 5. 非機能要件（V1.5から変更なし）

- ブラウザ: PC版Chromeのみサポート
- 同時アクセス: 想定3名以内

---

以上
