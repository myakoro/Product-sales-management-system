# V1.57 実装計画書

## 1. 概要
V1.56で実装された機能をブラッシュアップし、分析データの精度向上と操作性の改善を行う。

## 2. タスク一覧

### タスク1: NE同期期間の拡大 (SC-14)
- [x] `src/app/settings/nextengine/page.tsx` の `generateMonthOptions` を修正。
    - 2024年1月まで（当月含め最大25ヶ月分）の選択肢を生成するように変更。
- [x] 同期実行時に正しく過去の年月が送信されるか確認。

### タスク2: カテゴリー別PLの構成比表示 (SC-13)
- [x] `src/app/pl/page.tsx` の集計ロジックを修正。
    - 選択された期間・販路における全カテゴリー合計売上（未分類含む）を算出。
- [x] 一覧テーブルの売上高の横に構成比 `(XX%)` を追加表示。
- [x] Recharts のツールチップをカスタムし、構成比を表示。

### タスク3: 商品マスタのカテゴリーフィルタ修正 (SC-01/03)
- [x] `src/app/products/page.tsx` のカテゴリープルダウン表示ロジックを確認・修正。
    - APIのレスポンス形式 (`name` / `categoryName`) との不整合を解消。
    - 「未分類」が正しく機能するか確認。

### タスク4: 商品予算設定の機能拡張 (SC-09)
- [x] `src/app/api/budget/route.ts` (GET) を修正。
    - 商品データ取得時にカテゴリー情報を `include` し、レスポンスに含める。
- [x] `src/app/budget/page.tsx` のUI修正。
    - 「カテゴリー」列の追加。
    - カテゴリー名によるソート機能の実装。
- [x] 集計サマリの動的化と加重平均計算。
    - `filteredData` をベースに合計売上、合計粗利、加重平均粗利率を算出。
- [x] 保存ロジックの安全性確認。
    - フィルタ適用中に保存ボタンを押しても、非表示の商品データが上書き・削除されないことを保証。

### タスク5: 商品予算 vs 商品実績の項目追加 (SC-11)
- [x] `src/app/api/budget/vs-actual/route.ts` を修正。
    - 商品ごとの「予算粗利率」「実績粗利率」を計算し、レスポンスに含める。
    - サマリ（全体合計）にも同様の利率を追加。
- [x] `src/app/budget/vs-actual/page.tsx` のUI修正。
    - 一覧テーブルに「粗利率（予算/実績）」列を追加。
    - レイアウト崩れ（横幅オーバー）がないか確認・調整。

## 3. 確認項目
- [ ] 2024年1月の同期が実行できるか。
- [ ] カテゴリーPLの構成比合計が概ね100%（端数処理の関係で多少前後可）になるか。
- [ ] 予算設定画面でフィルタを変更した際、上部のサマリ数値が即座に同期されるか。
- [ ] 予算実績画面で、予算利率と実績利率が正しく並んでいるか。
